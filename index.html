<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>LLQâ€™s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="i have an Apple">
<meta property="og:type" content="website">
<meta property="og:title" content="LLQâ€™s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="LLQâ€™s Blog">
<meta property="og:description" content="i have an Apple">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LLQâ€™s Blog">
<meta name="twitter:description" content="i have an Apple">
  
    <link rel="alternate" href="/atom.xml" title="LLQâ€™s Blog" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/orange.png">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/home.css" >
  

  

  

</head>


<body>
  
    <header id="header">

  
    <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">
    <script>
        var imgUrls = "css/images/home-bg.jpg,css/images/fengjing.jpg,css/images/pose.jpg,css/images/fengjing2.jpg".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("intrologo").style.backgroundImage='url(' + imgUrls[random] + ')';
        } else {
          document.getElementById("intrologo").style.backgroundImage='url(/' + imgUrls[random] + ')';
        }
    </script>
  

    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">LLQâ€™s Blog</a></h1>
            <h3>i have an Apple</h3>
            <h5>LLQ</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- è‡ªé€‚åº”ä¸»é¡µèƒŒæ™¯å¤§å›¾ -->
  
    <script>
        var img = new Image();
        var intrologodiv = document.getElementById("intrologo");
        img.src = intrologodiv.style.backgroundImage.replace('url(','').replace(')','').replace(/\"/gi, "");
        img.onload=function(){
          if (img.width / img.height <= document.body.clientWidth / document.body.clientHeight) {
            intrologodiv.style.backgroundSize = "100% auto";
          } else {
            intrologodiv.style.backgroundSize = "auto 100%";
          }
        };
    </script>
 

 <!-- home_logo_imageå±…ä¸­ -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">é¦–é¡µ</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">æ‰€æœ‰æ–‡ç« </a>
        
          <a id="beautifont" class="main-nav-link" href="https://github.com/li1024316925">GitHub</a>
        
          <a id="beautifont" class="main-nav-link" href="http://www.jianshu.com/u/605febdfa703">ç®€ä¹¦</a>
        
          <a id="beautifont" class="main-nav-link" href="/impress">å…³äº</a>
        
      </p>
  </div>

</header>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-ä½¿ç”¨-FFmpeg-åšä¸€ä¸ªç®€å•çš„-RTMP-æ¨æµ"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/12/29/ä½¿ç”¨-FFmpeg-åšä¸€ä¸ªç®€å•çš„-RTMP-æ¨æµ/">ä½¿ç”¨ FFmpeg åšä¸€ä¸ªç®€å•çš„ RTMP æ¨æµ</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/12/29/ä½¿ç”¨-FFmpeg-åšä¸€ä¸ªç®€å•çš„-RTMP-æ¨æµ/" class="article-date">
	  <time datetime="2017-12-29T13:37:33.000Z" itemprop="datePublished">2017-12-29</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>ç«™åœ¨å¤§ç‰›è‚©è†€ä¸Šç¼–ç¨‹â€”â€” i_have_an_AppleğŸ˜‚</p>
</blockquote>
<p>ä¸Šé¢é‚£å¥è¯æ˜¯æˆ‘æ‰¯æ·¡å‘¢ï¼Œå¤§å®¶ä¹ä¸€ä¹å°±å¥½</p>
<p>åœ¨æœ¬æ–‡çš„å¼€å§‹ï¼Œæˆ‘ä»¬è¦æ„Ÿè°¢çœŸæ­£çš„å¤§ç‰›ï¼Œé›·ç¥ã€‚<br><a href="http://blog.csdn.net/leixiaohua1020/article/details/47072519" target="_blank" rel="external">è¿™æ˜¯é›·ç¥çš„åšå®¢</a></p>
<p>æ­¤ç¯‡æ–‡ç« ï¼Œä¸»è¦æ˜¯å¯¹å¤§ç‰› demo çš„è¯¦ç»†æ³¨é‡Šï¼Œæœ¬äººæœ€è¿‘åœ¨ç ”ç©¶ FFmpeg ä¹Ÿæœ‰å¾ˆå¤šä¸æ‡‚çš„åœ°æ–¹ï¼Œæ¬¢è¿å„ä½å°ä¼™ä¼´ç•™è¨€ä¸€èµ·è®¨è®ºã€‚</p>
<p>FFmpeg çš„ç¼–è¯‘ä¸é›†æˆè¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¿™é‡Œç›´æ¥è¿›å…¥æ­£é¢˜</p>
<h3 id="é¦–å…ˆå®šä¹‰ä¸€äº›ç›¸å…³çš„ç»“æ„ä½“ï¼Œå¹¶å°†å®ƒä»¬åˆå§‹åŒ–"><a href="#é¦–å…ˆå®šä¹‰ä¸€äº›ç›¸å…³çš„ç»“æ„ä½“ï¼Œå¹¶å°†å®ƒä»¬åˆå§‹åŒ–" class="headerlink" title="é¦–å…ˆå®šä¹‰ä¸€äº›ç›¸å…³çš„ç»“æ„ä½“ï¼Œå¹¶å°†å®ƒä»¬åˆå§‹åŒ–"></a>é¦–å…ˆå®šä¹‰ä¸€äº›ç›¸å…³çš„ç»“æ„ä½“ï¼Œå¹¶å°†å®ƒä»¬åˆå§‹åŒ–</h3><p>è¿™è¾¹æˆ‘æä¾›äº†ä¸€ä¸ªæ¨æµåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯æˆ‘è‡ªå·±æ­å»ºçš„ SRS(simple-rtmp-server) æœåŠ¡å™¨åœ°å€ï¼Œå› ä¸ºæœåŠ¡å™¨æ˜¯æ”¶è´¹çš„ï¼Œæˆ‘ä¹Ÿä¸èƒ½ä¸€ç›´å¼€ç€ï¼Œå„ä½å¦‚æœæƒ³æµ‹è¯• demo ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ­å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒåŒæ ·å¯ä»¥ä½œä¸ºæœåŠ¡å™¨ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> input_str_full[<span class="number">500</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">Â  Â  <span class="keyword">char</span> output_str_full[<span class="number">500</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ–‡ä»¶åœ°å€</span></div><div class="line">Â  Â  <span class="built_in">NSString</span> *input_str = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"war3end.mp4"</span> ofType:<span class="literal">nil</span>];</div><div class="line">Â  Â  <span class="comment">//æ¨æµåœ°å€</span></div><div class="line">Â  Â  <span class="built_in">NSString</span> *output_str = <span class="string">@"rtmp://106.75.92.197/live/test"</span>;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å°†åœ°å€å†™å…¥åˆ°åˆ›å»ºå¥½çš„å®¹å™¨</span></div><div class="line">Â  Â  sprintf(input_str_full, <span class="string">"%s"</span>,[input_str UTF8String]);</div><div class="line">Â  Â  sprintf(output_str_full, <span class="string">"%s"</span>,[output_str UTF8String]);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="built_in">NSLog</span>(<span class="string">@"input_str_full:%s"</span>,input_str_full);</div><div class="line">Â  Â  <span class="built_in">NSLog</span>(<span class="string">@"output_str_full:%s"</span>,output_str_full);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ–</span></div><div class="line">Â  Â  <span class="built_in">AVOutputFormat</span> *ofmt = <span class="literal">NULL</span>;</div><div class="line">Â  Â  <span class="comment">//è¾“å…¥formatå’Œè¾“å‡ºformat</span></div><div class="line">Â  Â  <span class="built_in">AVFormatContext</span> *ifmt_ctx = <span class="literal">NULL</span>, *ofmt_ctx = <span class="literal">NULL</span>;</div><div class="line">Â  Â  <span class="built_in">AVPacket</span> pkt;Â  <span class="comment">//å­˜å‚¨è§£ç å‰æ•°æ®</span></div><div class="line">Â  Â  <span class="keyword">char</span> in_filename[<span class="number">500</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">Â  Â  <span class="keyword">char</span> out_filename[<span class="number">500</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line">Â  Â  <span class="keyword">int</span> ret, i;</div><div class="line">Â  Â  <span class="keyword">int</span> videoindex = <span class="number">-1</span>;</div><div class="line">Â  Â  <span class="keyword">int</span> frame_index = <span class="number">0</span>;</div><div class="line">Â  Â  int64_t start_time = <span class="number">0</span>;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//strcpy(a,b) æŠŠ b ä¸­çš„å†…å®¹å¤åˆ¶åˆ° a ä¸­</span></div><div class="line">Â  Â  strcpy(in_filename, input_str_full);</div><div class="line">Â  Â  strcpy(out_filename, output_str_full);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ³¨å†Œ</span></div><div class="line">Â  Â  av_register_all();</div><div class="line">Â  Â  <span class="comment">//ç½‘ç»œåˆå§‹åŒ–</span></div><div class="line">Â  Â  avformat_network_init();</div></pre></td></tr></table></figure>
<h3 id="è¯»å–æœ¬åœ°çš„-MP4-æ–‡ä»¶ï¼Œå¹¶æ‰“å¼€æ¨æµåœ°å€"><a href="#è¯»å–æœ¬åœ°çš„-MP4-æ–‡ä»¶ï¼Œå¹¶æ‰“å¼€æ¨æµåœ°å€" class="headerlink" title="è¯»å–æœ¬åœ°çš„ MP4 æ–‡ä»¶ï¼Œå¹¶æ‰“å¼€æ¨æµåœ°å€"></a>è¯»å–æœ¬åœ°çš„ MP4 æ–‡ä»¶ï¼Œå¹¶æ‰“å¼€æ¨æµåœ°å€</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">Â  Â  <span class="comment">//Input</span></div><div class="line">Â  Â  <span class="comment">//æ‰“å¼€æ–‡ä»¶ï¼Œå­˜å‚¨åˆ°è¾“å…¥ä¸Šä¸‹æ–‡ä¸­</span></div><div class="line">Â  Â  <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx, in_filename, <span class="number">0</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  printf(<span class="string">"æœªèƒ½æ‰“å¼€æ–‡ä»¶\n"</span>);</div><div class="line">Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  &#125;</div><div class="line">Â  Â  <span class="comment">//æŸ¥æ‰¾è¾“å…¥æµæ•°æ®</span></div><div class="line">Â  Â  <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  printf(<span class="string">"æœªèƒ½æ‰¾åˆ°è¾“å…¥æµæ•°æ®\n"</span>);</div><div class="line">Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è¾“å…¥æµæ•°æ®çš„æ•°é‡å¾ªç¯</span></div><div class="line">Â  Â  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i ++) &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ifmt_ctx-&gt;streams[i]-&gt;codec-&gt;codec_type == <span class="built_in">AVMEDIA_TYPE_VIDEO</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  videoindex = i;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">break</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ£€æŸ¥ä¸€äº›è®¾ç½®çš„å‚æ•°æœ‰æ— é—®é¢˜</span></div><div class="line">Â  Â  av_dump_format(ifmt_ctx, <span class="number">0</span>, in_filename, <span class="number">0</span>);</div><div class="line">Â Â  Â </div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//Output</span></div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ–è¾“å‡ºä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  avformat_alloc_output_context2(&amp;ofmt_ctx, <span class="literal">NULL</span>, <span class="string">"flv"</span>, out_filename); <span class="comment">//RTMP</span></div><div class="line"><span class="comment">//Â  Â  avformat_alloc_output_context2(&amp;ofmt_ctx, NULL, "mpegts", out_filename); //UDP</span></div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">if</span> (!ofmt_ctx) &#123;</div><div class="line">Â  Â  Â  Â  printf(<span class="string">"è¾“å‡ºä¸Šä¸‹æ–‡æœªèƒ½åˆå§‹åŒ–æˆåŠŸ\n"</span>);</div><div class="line">Â  Â  Â  Â  ret = <span class="built_in">AVERROR_UNKNOWN</span>;</div><div class="line">Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//ä»è¾“å‡ºä¸Šä¸‹æ–‡ä¸­æ‹¿åˆ°å­˜å‚¨è¾“å‡ºä¿¡æ¯çš„ç»“æ„ä½“</span></div><div class="line">Â  Â  ofmt = ofmt_ctx-&gt;oformat;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i ++) &#123;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//è·å–è¾“å…¥è§†é¢‘æµ</span></div><div class="line">Â  Â  Â  Â  <span class="built_in">AVStream</span> *in_stream = ifmt_ctx-&gt;streams[i];</div><div class="line">Â  Â  Â  Â  <span class="comment">//ä¸ºè¾“å‡ºä¸Šä¸‹æ–‡æ·»åŠ éŸ³è§†é¢‘æµï¼ˆåˆå§‹åŒ–ä¸€ä¸ªéŸ³è§†é¢‘æµå®¹å™¨ï¼‰</span></div><div class="line">Â  Â  Â  Â  <span class="built_in">AVStream</span> *out_stream = avformat_new_stream(ofmt_ctx, in_stream-&gt;codec-&gt;codec);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (!out_stream) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  printf(<span class="string">"æœªèƒ½æˆåŠŸæ·»åŠ éŸ³è§†é¢‘æµ\n"</span>);</div><div class="line">Â  Â  Â  Â  Â  Â  ret = <span class="built_in">AVERROR_UNKNOWN</span>;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//å°†è¾“å…¥ç¼–è§£ç å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯ copy ç»™è¾“å‡ºç¼–è§£ç å™¨ä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  Â  Â  ret = avcodec_copy_context(out_stream-&gt;codec, in_stream-&gt;codec);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  printf(<span class="string">"copy ç¼–è§£ç å™¨ä¸Šä¸‹æ–‡å¤±è´¥\n"</span>);</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//è¿™é‡Œæ²¡çœ‹æ‡‚....</span></div><div class="line">Â  Â  Â  Â  out_stream-&gt;codec-&gt;codec_tag = <span class="number">0</span>;</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ofmt_ctx-&gt;oformat-&gt;flags &amp; <span class="built_in">AVFMT_GLOBALHEADER</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  out_stream-&gt;codec-&gt;flags = out_stream-&gt;codec-&gt;flags | CODEC_FLAG_GLOBAL_HEADER;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ£€æŸ¥å‚æ•°è®¾ç½®æœ‰æ— é—®é¢˜</span></div><div class="line">Â  Â  av_dump_format(ofmt_ctx, <span class="number">0</span>, out_filename, <span class="number">1</span>);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ‰“å¼€è¾“å‡ºåœ°å€ï¼ˆæ¨æµåœ°å€ï¼‰</span></div><div class="line">Â  Â  <span class="keyword">if</span> (!(ofmt-&gt;flags &amp; <span class="built_in">AVFMT_NOFILE</span>)) &#123;</div><div class="line">Â  Â  Â  Â  ret = avio_open(&amp;ofmt_ctx-&gt;pb, out_filename, <span class="built_in">AVIO_FLAG_WRITE</span>);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  printf(<span class="string">"æ— æ³•æ‰“å¼€åœ°å€ '%s'"</span>,out_filename);</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  &#125;</div></pre></td></tr></table></figure>
<h3 id="æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„æ¨æµäº†"><a href="#æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„æ¨æµäº†" class="headerlink" title="æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„æ¨æµäº†"></a>æ¥ä¸‹æ¥å°±æ˜¯æœ€é‡è¦çš„æ¨æµäº†</h3><p>å‰é¢æˆ‘ä»¬å·²ç»é€šè¿‡æœåŠ¡å™¨åœ°å€æ‰“å¼€äº†æœåŠ¡å™¨ï¼Œä»¥æˆ‘çš„ç†è§£æ¨æµå®é™…ä¸Šå°±æ˜¯å¾€æœåŠ¡å™¨å†™å…¥æ–‡ä»¶ï¼Œç„¶åå‰©ä¸‹çš„äº‹æƒ…æ¯”å¦‚è½¬å‘ç­‰ç­‰å°±æ˜¯æœåŠ¡å™¨çš„å·¥ä½œäº†ã€‚<br>ä¸‹é¢çš„ä»£ç ä¸­ï¼Œè®¡ç®—<br>PTSï¼ˆPresentation Time Stampï¼‰æ˜¾ç¤ºæ’­æ”¾æ—¶é—´æˆ³<br>DTSï¼ˆDecoding Time Stampï¼‰è§£ç æ—¶é—´æˆ³<br>æ¯”è¾ƒé‡è¦</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">Â  Â  <span class="comment">//å†™è§†é¢‘æ–‡ä»¶å¤´</span></div><div class="line">Â  Â  ret = avformat_write_header(ofmt_ctx, <span class="literal">NULL</span>);</div><div class="line">Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  printf(<span class="string">"åœ¨ URL æ‰€åœ¨çš„æ–‡ä»¶å†™è§†é¢‘å¤´å‡ºé”™\n"</span>);</div><div class="line">Â  Â  Â  Â  <span class="keyword">goto</span> end;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å–å¾—æ—¶é—´</span></div><div class="line">Â  Â  start_time = av_gettime();</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//è¾“å…¥è¾“å‡ºè§†é¢‘æµ</span></div><div class="line">Â  Â  Â  Â  <span class="built_in">AVStream</span> *in_stream, *out_stream;</div><div class="line">Â  Â  Â  Â  <span class="comment">//è·å–è§£ç å‰æ•°æ®</span></div><div class="line">Â  Â  Â  Â  ret = av_read_frame(ifmt_ctx, &amp;pkt);</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">break</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">/*</span></div><div class="line">Â Â  Â  Â  Â  PTSï¼ˆPresentation Time Stampï¼‰æ˜¾ç¤ºæ’­æ”¾æ—¶é—´</div><div class="line">Â Â  Â  Â  Â  DTSï¼ˆDecoding Time Stampï¼‰è§£ç æ—¶é—´</div><div class="line">Â Â  Â  Â  Â  */</div><div class="line">Â  Â  Â  Â  <span class="comment">//æ²¡æœ‰æ˜¾ç¤ºæ—¶é—´ï¼ˆæ¯”å¦‚æœªè§£ç çš„ H.264 ï¼‰</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (pkt.pts == <span class="built_in">AV_NOPTS_VALUE</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//AVRational time_baseï¼šæ—¶åŸºã€‚é€šè¿‡è¯¥å€¼å¯ä»¥æŠŠPTSï¼ŒDTSè½¬åŒ–ä¸ºçœŸæ­£çš„æ—¶é—´ã€‚</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">AVRational</span> time_base1 = ifmt_ctx-&gt;streams[videoindex]-&gt;time_base;</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//è®¡ç®—ä¸¤å¸§ä¹‹é—´çš„æ—¶é—´</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">/*</span></div><div class="line">Â Â  Â  Â  Â  Â  Â  r_frame_rate åŸºæµå¸§é€Ÿç‡Â  ï¼ˆä¸æ˜¯å¤ªæ‡‚ï¼‰</div><div class="line">Â Â  Â  Â  Â  Â  Â  av_q2d è½¬åŒ–ä¸ºdoubleç±»å‹</div><div class="line">Â Â  Â  Â  Â  Â  Â  */</div><div class="line">Â  Â  Â  Â  Â  Â  int64_t calc_duration = (<span class="keyword">double</span>)<span class="built_in">AV_TIME_BASE</span>/av_q2d(ifmt_ctx-&gt;streams[videoindex]-&gt;r_frame_rate);</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//é…ç½®å‚æ•°</span></div><div class="line">Â  Â  Â  Â  Â  Â  pkt.pts = (<span class="keyword">double</span>)(frame_index*calc_duration)/(<span class="keyword">double</span>)(av_q2d(time_base1)*<span class="built_in">AV_TIME_BASE</span>);</div><div class="line">Â  Â  Â  Â  Â  Â  pkt.dts = pkt.pts;</div><div class="line">Â  Â  Â  Â  Â  Â  pkt.duration = (<span class="keyword">double</span>)calc_duration/(<span class="keyword">double</span>)(av_q2d(time_base1)*<span class="built_in">AV_TIME_BASE</span>);</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//å»¶æ—¶</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (pkt.stream_index == videoindex) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">AVRational</span> time_base = ifmt_ctx-&gt;streams[videoindex]-&gt;time_base;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">AVRational</span> time_base_q = &#123;<span class="number">1</span>,<span class="built_in">AV_TIME_BASE</span>&#125;;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//è®¡ç®—è§†é¢‘æ’­æ”¾æ—¶é—´</span></div><div class="line">Â  Â  Â  Â  Â  Â  int64_t pts_time = av_rescale_q(pkt.dts, time_base, time_base_q);</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//è®¡ç®—å®é™…è§†é¢‘çš„æ’­æ”¾æ—¶é—´</span></div><div class="line">Â  Â  Â  Â  Â  Â  int64_t now_time = av_gettime() - start_time;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (pts_time &gt; now_time) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//ç¡çœ ä¸€æ®µæ—¶é—´ï¼ˆç›®çš„æ˜¯è®©å½“å‰è§†é¢‘è®°å½•çš„æ’­æ”¾æ—¶é—´ä¸å®é™…æ—¶é—´åŒæ­¥ï¼‰</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  av_usleep((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(pts_time - now_time));</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  in_stream = ifmt_ctx-&gt;streams[pkt.stream_index];</div><div class="line">Â  Â  Â  Â  out_stream = ofmt_ctx-&gt;streams[pkt.stream_index];</div><div class="line"></div><div class="line"><span class="comment">//è®¡ç®—å»¶æ—¶åï¼Œé‡æ–°æŒ‡å®šæ—¶é—´æˆ³</span></div><div class="line">Â  Â  Â  Â  pkt.pts = av_rescale_q_rnd(pkt.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, (<span class="built_in">AV_ROUND_NEAR_INF</span>|<span class="built_in">AV_ROUND_PASS_MINMAX</span>));</div><div class="line">Â  Â  Â  Â  pkt.dts = av_rescale_q_rnd(pkt.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, (<span class="built_in">AV_ROUND_NEAR_INF</span>|<span class="built_in">AV_ROUND_PASS_MINMAX</span>));</div><div class="line">Â  Â  Â  Â  pkt.duration = (<span class="keyword">int</span>)av_rescale_q(pkt.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);</div><div class="line">Â  Â  Â  Â  <span class="comment">//å­—èŠ‚æµçš„ä½ç½®ï¼Œ-1 è¡¨ç¤ºä¸çŸ¥é“å­—èŠ‚æµä½ç½®</span></div><div class="line">Â  Â  Â  Â  pkt.pos = <span class="number">-1</span>;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (pkt.stream_index == videoindex) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  printf(<span class="string">"Send %8d video frames to output URL\n"</span>,frame_index);</div><div class="line">Â  Â  Â  Â  Â  Â  frame_index++;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//å‘è¾“å‡ºä¸Šä¸‹æ–‡å‘é€ï¼ˆå‘åœ°å€æ¨é€ï¼‰</span></div><div class="line">Â  Â  Â  Â  ret = av_interleaved_write_frame(ofmt_ctx, &amp;pkt);</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  printf(<span class="string">"å‘é€æ•°æ®åŒ…å‡ºé”™\n"</span>);</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">break</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//é‡Šæ”¾</span></div><div class="line">Â  Â  Â  Â  av_free_packet(&amp;pkt);</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å†™æ–‡ä»¶å°¾</span></div><div class="line">Â  Â  av_write_trailer(ofmt_ctx);</div></pre></td></tr></table></figure>
<h3 id="æœ€åæ˜¯ä¸€ä¸ª-end-èŠ‚ç‚¹ï¼Œä¸Šè¿°è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªè·³è½¬-end-èŠ‚ç‚¹ï¼Œåœ¨å‡ºé”™æ—¶ç»“æŸç¨‹åºå¹¶é‡Šæ”¾å„ä¸ªç»“æ„ä½“"><a href="#æœ€åæ˜¯ä¸€ä¸ª-end-èŠ‚ç‚¹ï¼Œä¸Šè¿°è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªè·³è½¬-end-èŠ‚ç‚¹ï¼Œåœ¨å‡ºé”™æ—¶ç»“æŸç¨‹åºå¹¶é‡Šæ”¾å„ä¸ªç»“æ„ä½“" class="headerlink" title="æœ€åæ˜¯ä¸€ä¸ª end èŠ‚ç‚¹ï¼Œä¸Šè¿°è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªè·³è½¬ end èŠ‚ç‚¹ï¼Œåœ¨å‡ºé”™æ—¶ç»“æŸç¨‹åºå¹¶é‡Šæ”¾å„ä¸ªç»“æ„ä½“"></a>æœ€åæ˜¯ä¸€ä¸ª end èŠ‚ç‚¹ï¼Œä¸Šè¿°è¿‡ç¨‹ä¸­æœ‰å¤šä¸ªè·³è½¬ end èŠ‚ç‚¹ï¼Œåœ¨å‡ºé”™æ—¶ç»“æŸç¨‹åºå¹¶é‡Šæ”¾å„ä¸ªç»“æ„ä½“</h3><blockquote>
<p>ä¸æ¨èå¤§å®¶ä½¿ç”¨ <code>goto</code> è¯­å¥ï¼Œè¿™é‡Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸”ä»£ç å—å¤ªé•¿ï¼Œæ‰€ä»¥æ‰ä½¿ç”¨äº†ä¸€ä¸ª <code>goto</code> è¯­å¥</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//end èŠ‚ç‚¹</span></div><div class="line">end:</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å…³é—­è¾“å…¥ä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  avformat_close_input(&amp;ifmt_ctx);</div><div class="line">Â  Â  <span class="comment">//å…³é—­è¾“å‡ºä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  <span class="keyword">if</span> (ofmt_ctx &amp;&amp; !(ofmt-&gt;flags &amp; <span class="built_in">AVFMT_NOFILE</span>)) &#123;</div><div class="line">Â  Â  Â  Â  avio_close(ofmt_ctx-&gt;pb);</div><div class="line">Â  Â  &#125;</div><div class="line">Â  Â  <span class="comment">//é‡Šæ”¾è¾“å‡ºä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  avformat_free_context(ofmt_ctx);</div><div class="line">Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; ret != <span class="built_in">AVERROR_EOF</span>) &#123;</div><div class="line">Â  Â  Â  Â  printf(<span class="string">"å‘ç”Ÿé”™è¯¯\n"</span>);</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">Â  Â  <span class="keyword">return</span>;</div></pre></td></tr></table></figure>
<p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œåœ¨è¿™æœ€åçš„æœ€åï¼Œæ”¾ä¸Š demo æºç <br><a href="https://github.com/li1024316925/FFmpeg-RTMP-PushStream" target="_blank" rel="external">ç‚¹è¿™é‡Œç‚¹è¿™é‡Œç‚¹è¿™é‡Œç‚¹è¿™é‡Œ</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Swift3.0 åˆ©ç”¨ Runtime ç®€å•å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/03/18/Swift3.0 åˆ©ç”¨ Runtime ç®€å•å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹/">Swift3.0 åˆ©ç”¨Runtimeå°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/03/18/Swift3.0 åˆ©ç”¨ Runtime ç®€å•å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹/" class="article-date">
	  <time datetime="2017-03-18T05:03:04.000Z" itemprop="datePublished">2017-03-18</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Swiftä¸‹-åˆ©ç”¨-Runtime-å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹"><a href="#Swiftä¸‹-åˆ©ç”¨-Runtime-å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹" class="headerlink" title="Swiftä¸‹ åˆ©ç”¨ Runtime å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹"></a>Swiftä¸‹ åˆ©ç”¨ Runtime å°è£…ä¸€ä¸ªå­—å…¸è½¬æ¨¡å‹</h1><p>åœ¨é€šå¸¸çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ°å­—å…¸è½¬ model çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„<br><code>setValuesForKeys</code>ï¼ˆSwiftï¼‰<br><code>setValuesForKeysWithDictionary</code>ï¼ˆOCï¼‰<br>æ–¹æ³•æ¥å®Œæˆè¿™ä¸€æ“ä½œï¼Œä½†æ˜¯è¿™æ ·å°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æ•°æ®å­—å…¸å…¶ä¸­çš„ä¸€ä¸ª key ä¸ç³»ç»Ÿå…³é”®å­—é‡åï¼Œé‚£æˆ‘ä»¬åœ¨modelä¸­ä½¿ç”¨è¿™ä¸ª key ä½œä¸ºå±æ€§å°±ä¼šæŠ¥é”™ï¼Œä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¸€äº›ç¬¬ä¸‰æ–¹åº“å»å®Œæˆå­—å…¸è½¬æ¨¡å‹çš„æ“ä½œï¼Œä¾‹å¦‚ MJExtension ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è‡ªå·±å»å°è£…ä¸€ä¸ªç®€å•çš„å­—å…¸è½¬æ¨¡å‹ï¼Œé—²è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬é©¬ä¸Šå¼€å§‹ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å»åˆ›å»ºä¸€ä¸ª BaseModel ç±»ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªæ ¹ç±»ä¸­å»å®ç°ä¸€ä¸ªå¯ä»¥å­—å…¸è½¬è‡ªèº«å±æ€§çš„æ„é€ æ–¹æ³•ï¼Œåªè¦æˆ‘ä»¬è‡ªå®šä¹‰çš„ model éƒ½ç»§æ‰¿è¿™ä¸ª BaseModel é‚£ä¹ˆæˆ‘ä»¬çš„ model å°±éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•å®Œæˆå­—å…¸è½¬æ¨¡å‹çš„æ“ä½œå•¦~</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span>: <span class="title">NSObject</span> </span>&#123; </div><div class="line">    <span class="comment">//è‡ªå®šä¹‰æ„é€ æ–¹æ³•</span></div><div class="line">Â  Â  <span class="keyword">init</span>(dic: [<span class="type">String</span>:<span class="type">Any</span>]) &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">Â  Â  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡æ„é€ æ–¹æ³•ï¼Œæ‹¿åˆ°äº†æ•°æ®å­—å…¸ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬åªè¦å°†å­—å…¸çš„é”®å€¼å¯¹è½¬æ¢ä¸ºæˆ‘ä»¬è‡ªèº«çš„å±æ€§ï¼Œå°±å¤§åŠŸå‘Šæˆå•¦~<br>æˆ‘ä»¬å†™ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œå»å®Œæˆè¿™ä¸ªæ“ä½œ<br>æˆ‘ä»¬é¦–å…ˆåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä½¿ç”¨ Runtime è·å–ä¸€ä¸‹æœ¬ç±»çš„æ‰€æœ‰å±æ€§</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">setAttribut</span><span class="params">(dic: [String:Any])</span></span> -&gt; <span class="type">Void</span> &#123;</div><div class="line">        <span class="comment">//Runtimeè·å–æœ¬ç±»å±æ€§</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">var</span> <span class="built_in">count</span>:<span class="type">UInt32</span> = <span class="number">0</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> ivars = class_copyIvarList(<span class="keyword">self</span>.classForCoder, &amp;<span class="built_in">count</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬éå†è¿™ä¸ªè·å–åˆ°çš„å±æ€§æ•°ç»„ï¼Œå–å‡ºå…¶ä¸­çš„å…ƒç´ ï¼Œå¹¶è·å¾—å±æ€§åï¼Œè¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è·å¾—çš„å±æ€§åæ˜¯ C è¯­è¨€å­—ç¬¦ä¸²ï¼Œè¿™é‡Œæˆ‘ä»¬è¦è½¬æ¢ä¸€ä¸‹å˜æˆ Swift å­—ç¬¦ä¸²</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</div><div class="line">Â  Â  Â  Â  Â <span class="comment">//å–å‡ºå±æ€§å</span></div><div class="line">Â  Â  Â  Â  Â <span class="keyword">let</span> ivar = ivars?[<span class="type">Int</span>(i)]</div><div class="line">         <span class="keyword">let</span> ivarName = ivar_getName(ivar!)</div><div class="line">Â  Â  Â  Â  Â <span class="keyword">let</span> nName = <span class="type">String</span>(cString: ivarName!)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿›è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´å·²ç»æ˜ç™½å…¶ä¸­çš„åŸç†äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªè¦åˆ©ç”¨å–åˆ°çš„å±æ€§åä»æˆ‘ä»¬çš„æ•°æ®å­—å…¸ä¸­å–åˆ°ç›¸åº”çš„ value ç„¶åèµ‹å€¼ç»™æˆ‘ä»¬çš„å±æ€§ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å°±å®Œæˆäº†ï¼Œä½†æ˜¯è¿™é‡Œï¼Œæˆ‘ä»¬è¦è§£å†³æˆ‘ä»¬åˆšå¼€å§‹é‡åˆ°é—®é¢˜ â€œæˆ‘ä»¬çš„å±æ€§åå’Œå­—å…¸çš„keyå€¼å¿…é¡»ä¸ç›¸åŒæ€ä¹ˆåŠï¼Ÿâ€ åœ¨è¿™é‡Œæˆ‘çš„è§£å†³åŠæ³•æ˜¯é‡æ–°å»ºç«‹ä¸€ä¸ª model å±æ€§ä¸å­—å…¸ key å€¼çš„æ˜ å°„å…³ç³»ï¼Œè¿™é‡Œåˆå†™äº†ä¸€ä¸ªå»ºç«‹æ˜ å°„çš„æ–¹æ³•</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å¦‚æœå±æ€§åä¸æ•°æ®å­—å…¸çš„keyå€¼ä¸å¯¹åº”ï¼Œé‚£ä¹ˆåœ¨å­ç±»modelä¸­å¤å†™æ­¤æ–¹æ³•ï¼Œå°†å±æ€§åä½œä¸ºkeyï¼Œå­—å…¸keyå€¼ä½œä¸ºvalue</span></div><div class="line">Â  Â  <span class="function"><span class="keyword">func</span> <span class="title">attributesDic</span><span class="params">(dic: [String:Any])</span></span> -&gt; [<span class="type">String</span>:<span class="type">String</span>] &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">var</span> newDic:[<span class="type">String</span>:<span class="type">String</span>] = [:]</div><div class="line">Â  Â  Â  Â  <span class="keyword">for</span> key <span class="keyword">in</span> dic.keys &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å¤å†™æ—¶æ³¨æ„å°†å±æ€§åä½œä¸ºkey æ•°æ®å­—å…¸çš„keyä½œä¸ºvalue</span></div><div class="line">Â  Â  Â  Â  Â  Â  newDic[key] = key</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span> newDic</div><div class="line">Â  Â  &#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ª BaseModel çˆ¶ç±»ä¸­ï¼Œæˆ‘ä»¬å…ˆè®©æ•°æ®å­—å…¸æ‰€æœ‰çš„ key æ˜ å°„ä¸º key æœ¬èº«ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨å¤å†™è¿™ä¸ªæ–¹æ³•æ—¶åªä¿®æ”¹ key ä¸å±æ€§ä¸å¯¹åº”çš„æ˜ å°„å°±å¯ä»¥äº†ã€‚<br><strong>è¿™é‡Œæœ‰ç‰¹åˆ«æ³¨æ„çš„ä¸€ç‚¹ï¼Œåœ¨å¤å†™æ—¶ï¼Œæˆ‘ä»¬ä¸€å®šè¦ç”¨ super é¦–å…ˆè°ƒç”¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚</strong></p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„å±æ€§èµ‹å€¼æ–¹æ³•å°±è¦ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬è¦é¦–å…ˆæ‹¿åˆ°æ•°æ®å­—å…¸çš„ key ä¸å±æ€§çš„å…¨æ–°æ˜ å°„å…³ç³»</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">setAttribut</span><span class="params">(dic: [String:Any])</span></span> -&gt; <span class="type">Void</span> &#123;</div><div class="line">        <span class="comment">//è·å¾—æ˜ å°„å…³ç³»</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> attributDic = attributesDic(dic: dic)Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//Runtimeè·å–æœ¬ç±»å±æ€§</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">var</span> <span class="built_in">count</span>:<span class="type">UInt32</span> = <span class="number">0</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> ivars = class_copyIvarList(<span class="keyword">self</span>.classForCoder, &amp;<span class="built_in">count</span>)</div><div class="line">Â  Â  Â  Â  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å–å‡ºå±æ€§å</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> ivar = ivars?[<span class="type">Int</span>(i)]</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> ivarName = ivar_getName(ivar!)</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> nName = <span class="type">String</span>(cString: ivarName!)</div><div class="line">        &#125; Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬ç¦»æˆåŠŸå°±åªå·®ä¸€æ­¥äº†ï¼ï¼<br>æˆ‘ä»¬éœ€è¦å°†å–åˆ°çš„å±æ€§åé€šè¿‡å…¨æ–°çš„æ˜ å°„å…³ç³»å–åˆ°æ•°æ®å­—å…¸çš„ key ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ª key ä»æ•°æ®å­—å…¸å–åˆ° value æœ€åå°† value èµ‹å€¼ç»™æˆ‘ä»¬ model  çš„å±æ€§<br>æœ€åï¼Œæˆ‘ä»¬çš„å±æ€§èµ‹å€¼æ–¹æ³•å˜æˆäº†è¿™æ ·</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">setAttribut</span><span class="params">(dic: [String:Any])</span></span> -&gt; <span class="type">Void</span> &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> attributDic = attributesDic(dic: dic)</div><div class="line">Â  Â  Â  Â  <span class="comment">//Runtimeè·å–æœ¬ç±»å±æ€§</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">var</span> <span class="built_in">count</span>:<span class="type">UInt32</span> = <span class="number">0</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> ivars = class_copyIvarList(<span class="keyword">self</span>.classForCoder, &amp;<span class="built_in">count</span>)</div><div class="line">Â  Â  Â  Â  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å–å‡ºå±æ€§å</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> ivar = ivars?[<span class="type">Int</span>(i)]</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> ivarName = ivar_getName(ivar!)</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">let</span> nName = <span class="type">String</span>(cString: ivarName!)</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å–å‡ºè¦èµ‹å€¼çš„å€¼</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">var</span> attribut = attributDic[nName]</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> attribut == <span class="literal">nil</span>&#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  attribut = <span class="string">""</span></div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">var</span> value:<span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> dic[attribut!] != <span class="literal">nil</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  value = dic[attribut!] <span class="keyword">as</span>! <span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  value = <span class="string">""</span> <span class="keyword">as</span> <span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//åˆ©ç”¨KVCç»™æœ¬ç±»çš„å±æ€§èµ‹å€¼</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">self</span>.setValue(value, forKey: nName)Â  Â </div><div class="line">Â  Â  Â  Â  &#125;Â Â  Â  Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id="æœ€åçš„æœ€å"><a href="#æœ€åçš„æœ€å" class="headerlink" title="æœ€åçš„æœ€å"></a>æœ€åçš„æœ€å</h6><p>åœ¨æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆå§‹åŒ–æ–¹æ³•ä¸­è°ƒç”¨ä¸€ä¸‹</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è‡ªå®šä¹‰æ„é€ æ–¹æ³•</span></div><div class="line">Â  Â  <span class="keyword">init</span>(dic: [<span class="type">String</span>:<span class="type">Any</span>]) &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">Â  Â  Â  Â  setAttribut(dic: dic)</div><div class="line">Â  Â  &#125;</div></pre></td></tr></table></figure>
<p>å¤§åŠŸå‘Šæˆï¼ï¼<br>è¿™ä¸ªå°è£…å¥½çš„ model å·²ç»åœ¨æˆ‘å†™çš„ Swift å°é¡¹ç›®ä¸­å¾—åˆ°äº†éªŒè¯ï¼Œè¿™æ˜¯é¡¹ç›®åœ°å€<br><a href="https://github.com/li1024316925/Swift-TimeMovie" target="_blank" rel="external">æ—¶å…‰ç”µå½±Swiftç‰ˆåˆå­¦å°é¡¹ç›®</a><br>æœ¬æ–‡å¦‚æœæœ‰ä»€ä¹ˆé”™è¯¯æˆ–è€…æ‚¨æœ‰æ›´å¥½çš„æ–¹æ³•ï¼Œæ¬¢è¿æŒ‡å‡º</p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS-Runtime-Swift/">iOS Runtime Swift</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-UITableView è¡Œé«˜è‡ªé€‚åº”-ç¼“å­˜ä¼˜åŒ–"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/02/27/UITableView è¡Œé«˜è‡ªé€‚åº”-ç¼“å­˜ä¼˜åŒ–/">UITableViewè¡Œé«˜è‡ªé€‚åº”-ç¼“å­˜ä¼˜åŒ–</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/02/27/UITableView è¡Œé«˜è‡ªé€‚åº”-ç¼“å­˜ä¼˜åŒ–/" class="article-date">
	  <time datetime="2017-02-27T05:03:04.000Z" itemprop="datePublished">2017-02-27</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å­¦ä¹ äº† FDTemplateLayoutCell åï¼Œæˆ‘è‡ªå·±ä¹Ÿå†™äº†ä¸€ä¸ª TableView è¡Œé«˜è‡ªé€‚åº”åŠ é«˜åº¦ç¼“å­˜çš„ Demoï¼Œæœ¬ Demo ç ”ç©¶å®ç°äº†å…¶ä¸­çš„æœ€åŸºæœ¬ç®—é«˜ä¸ç¼“å­˜åŠŸèƒ½ï¼Œä»…ä¾›å¤§å®¶å­¦ä¹ ä½¿ç”¨ã€‚</p>
</blockquote>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬äº†è§£ä¸€äº› Runtime çš„çŸ¥è¯†ï¼Œ<code>objc_setAssociatedObject</code>ä¸<code>objc_getAssociatedObject</code>è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">     object è¦æŒæœ‰â€œåˆ«çš„å¯¹è±¡â€çš„å¯¹è±¡</div><div class="line">     key å…³è”å…³é”®å­—ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼Œæ˜¯ä¸€ä¸ªåœ°å€(è¿™é‡Œæ³¨æ„ï¼Œåœ°å€å¿…é¡»æ˜¯ä¸å˜çš„ï¼Œåœ°å€ä¸åŒä½†æ˜¯å†…å®¹ç›¸åŒçš„ä¹Ÿä¸ç®—åŒä¸€ä¸ªkey)</div><div class="line">     value ä¹Ÿå°±æ˜¯å€¼</div><div class="line">     policy è¿™æ˜¯ä¸€ä¸ªæšä¸¾ï¼Œä½ å¯ä»¥ç‚¹è¿›å»çœ‹çœ‹è¿™ä¸ªæšä¸¾æ˜¯ä»€ä¹ˆï¼š</div><div class="line">     OBJC_ASSOCIATION_ASSIGN</div><div class="line">     OBJC_ASSOCIATION_RETAIN_NONATOMIC</div><div class="line">     OBJC_ASSOCIATION_COPY_NONATOMIC</div><div class="line">     OBJC_ASSOCIATION_RETAIN</div><div class="line">     OBJC_ASSOCIATION_COPY</div><div class="line">     */</div><div class="line">    <span class="comment">//å‚æ•°ä¸€ï¼šéœ€è¦æ·»åŠ å±æ€§çš„å¯¹è±¡ å‚æ•°äºŒï¼šå…³è”å…³é”®å­—ï¼ˆå…³è”å…³é”®å­—è¦ä¸getæ–¹æ³•ä¸­çš„å…³é”®å­—ç›¸åŒï¼Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼‰ å‚æ•°ä¸‰ï¼šå±æ€§å å‚æ•°å››ï¼šæšä¸¾ä¸@propertyæ‹¬å·ä¸­ç›¸åŒ</span></div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="string">@"name"</span>, name, OBJC_ASSOCIATION_COPY_NONATOMIC);</div></pre></td></tr></table></figure>
<p><code>objc_setAssociatedObject</code>è¿™ä¸ªå‡½æ•°çš„æ„æ€å°±æ˜¯é€šè¿‡ä¸€ä¸ª key ä¸ºä¸€ä¸ªå¯¹è±¡ç»‘å®šå¦ä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">     object æŒæœ‰â€œåˆ«çš„å¯¹è±¡â€çš„å¯¹è±¡ï¼Œè¿™é‡ŒæŒ‡a</div><div class="line">     key å…³è”å…³é”®å­—</div><div class="line">     */</div><div class="line">     objc_getAssociatedObject(<span class="keyword">self</span>, <span class="string">@"name"</span>);</div></pre></td></tr></table></figure>
<p><code>objc_getAssociatedObject</code>è¿™ä¸ªå‡½æ•°çš„æ„æ€æ˜¯é€šè¿‡ä¸€ä¸ª key å–åˆ°ä¸€ä¸ªå¯¹è±¡ç»‘å®šçš„é‚£ä¸ªå¯¹è±¡</p>
<p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œä¸º<code>self</code>æ‰€æŒ‡çš„å¯¹è±¡é€šè¿‡<code>@&quot;name&quot;</code>è¿™ä¸ª key ç»‘å®šäº†ä¸€ä¸ªå€¼ä¸º<code>name</code>çš„å¯¹è±¡<br>Runtime å°±è¯´è¿™ä¹ˆå¤šï¼Œå¦‚æœå°ä¼™ä¼´ä»¬æƒ³è¦æ›´ä¸ºæ·±å…¥çš„äº†è§£ï¼Œè¯·è‡ªè¡Œæœå¯»ç›¸å…³èµ„æ–™ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è¯´è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè¯·å°ä¼™ä¼´ä»¬ç»§ç»­å¾€ä¸‹é¢çœ‹ã€‚</p>
<blockquote>
<p>â€”â€”â€”â€”å‰æ–¹é«˜èƒ½é¢„è­¦â€”â€”â€”â€”<br>ä¸‹é¢å°±æ˜¯æœ¬æ–‡çš„é‡ç‚¹äº†</p>
</blockquote>
<h3 id="ä¸º-UITableViewCell-åˆ›å»ºä¸€ä¸ª-Category-ç›®çš„æ˜¯ä¸ºå…¶å¢åŠ ä¸¤ä¸ªå±æ€§"><a href="#ä¸º-UITableViewCell-åˆ›å»ºä¸€ä¸ª-Category-ç›®çš„æ˜¯ä¸ºå…¶å¢åŠ ä¸¤ä¸ªå±æ€§" class="headerlink" title="ä¸º UITableViewCell åˆ›å»ºä¸€ä¸ª Category ç›®çš„æ˜¯ä¸ºå…¶å¢åŠ ä¸¤ä¸ªå±æ€§"></a>ä¸º UITableViewCell åˆ›å»ºä¸€ä¸ª Category ç›®çš„æ˜¯ä¸ºå…¶å¢åŠ ä¸¤ä¸ªå±æ€§</h3><p>ä¸º Cell æ·»åŠ ä¸¤ä¸ªå±æ€§ï¼Œä¸€ä¸ªç”¨æ¥æ ‡å¿—æ­¤ Cell åªç”¨æ¥è®¡ç®—é«˜åº¦ï¼Œä¸è¿›è¡Œæ˜¾ç¤ºï¼Œå¦ä¸€ä¸ªå±æ€§æ ‡å¿—æ˜¯å¦ä½¿ç”¨çº¦æŸæ¥è¿›è¡Œè®¡ç®—ã€‚æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¯ä¸€ç§ç±»çš„ Cell éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„è®¡ç®— Cellï¼Œè€Œä¸”æ­¤ç§ç±»çš„è®¡ç®— Cell æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œå¦‚æœä½ æ­¤æ—¶è¿˜æœ‰äº›æ‡µé€¼ï¼Œé‚£è¯·å¸¦ç€ä½ çš„ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚<br>ä»€ä¹ˆï¼Ÿä½ è¯´ Category ä¸èƒ½æ·»åŠ å±æ€§ï¼Ÿçš„ç¡®ï¼ŒCategory ç¡®å®ä¸èƒ½æ·»åŠ å±æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä¸‡èƒ½çš„ Runtime å•Šï¼Œæ¥çœ‹çœ‹æˆ‘ä»¬æ˜¯æ€ä¹ˆåšçš„</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITableViewCell</span> (<span class="title">HeightCacheCell</span>)</span></div><div class="line"></div><div class="line"><span class="comment">//æ·»åŠ ä¸¤ä¸ªå±æ€§</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>)<span class="built_in">BOOL</span> justForCalculate; <span class="comment">//åªç”¨æ¥è®¡ç®—çš„æ ‡å¿—</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>)<span class="built_in">BOOL</span> noAuotSizeing; <span class="comment">//ä¸ä¾é çº¦æŸè®¡ç®—ï¼Œåªè¿›è¡Œè‡ªé€‚åº”</span></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UITableViewCell</span> (<span class="title">HeightCacheCell</span>)</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#pragma mark ------ ç»‘å®šå±æ€§</span></div><div class="line"></div><div class="line"><span class="comment">//justForCall</span></div><div class="line">- (<span class="keyword">void</span>)setJustForCalculate:(<span class="built_in">BOOL</span>)justForCalculate&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(justForCalculate), @(justForCalculate), OBJC_ASSOCIATION_RETAIN); <span class="comment">//ä½¿ç”¨getæ–¹æ³•åä½œä¸ºkey</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)justForCalculate&#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//noAuotSizeing</span></div><div class="line">- (<span class="keyword">void</span>)setNoAuotSizeing:(<span class="built_in">BOOL</span>)noAuotSizeing&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(noAuotSizeing), @(noAuotSizeing), OBJC_ASSOCIATION_RETAIN);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)noAuotSizeing&#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, _cmd) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>é‡å†™è¿™ä¸¤ä¸ªå±æ€§çš„ get set æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨åˆšæ‰å­¦åˆ°çš„ä¸¤ä¸ª Runtime æ–¹æ³•ï¼Œä¸º UITableViewCell ç»‘å®šäº†ä¸¤ä¸ªå¯¹è±¡ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å˜ç›¸çš„ä¸º UITableViewCell æ·»åŠ äº†ä¸¤ä¸ªå±æ€§</p>
<h3 id="åˆ›å»ºä¸€ä¸ª-Cache-ç±»ï¼Œç”¨æ¥ç¼“å­˜ç›¸åº”-Cell-çš„é«˜åº¦"><a href="#åˆ›å»ºä¸€ä¸ª-Cache-ç±»ï¼Œç”¨æ¥ç¼“å­˜ç›¸åº”-Cell-çš„é«˜åº¦" class="headerlink" title="åˆ›å»ºä¸€ä¸ª Cache ç±»ï¼Œç”¨æ¥ç¼“å­˜ç›¸åº” Cell çš„é«˜åº¦"></a>åˆ›å»ºä¸€ä¸ª Cache ç±»ï¼Œç”¨æ¥ç¼“å­˜ç›¸åº” Cell çš„é«˜åº¦</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HeightCache</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>)<span class="built_in">NSMutableDictionary</span> *heightCacheDicV; <span class="comment">//ç«–ç›´è¡Œé«˜ç¼“å­˜å­—å…¸</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>)<span class="built_in">NSMutableDictionary</span> *heightCacheDicH; <span class="comment">//æ°´å¹³è¡Œé«˜ç¼“å­˜å­—å…¸</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>)<span class="built_in">NSMutableDictionary</span> *heightCacheDicCurrent; <span class="comment">//å½“å‰è¡Œé«˜ç¼“å­˜å­—å…¸</span></div><div class="line"></div><div class="line"><span class="comment">//åˆ¶ä½œkey</span></div><div class="line">- (<span class="built_in">NSString</span> *)makeKeyWithIdentifier:(<span class="built_in">NSString</span> *)identifier indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath;</div><div class="line"></div><div class="line"><span class="comment">//åˆ¤æ–­é«˜åº¦æ˜¯å¦å­˜åœ¨</span></div><div class="line">- (<span class="built_in">BOOL</span>)existInCacheByKey:(<span class="built_in">NSString</span> *)key;</div><div class="line"></div><div class="line"><span class="comment">//æŸ¥æ‰¾é«˜åº¦ç¼“å­˜</span></div><div class="line">- (<span class="built_in">CGFloat</span>)heightFromCacheWithKey:(<span class="built_in">NSString</span> *)key;</div><div class="line"></div><div class="line"><span class="comment">//ç¼“å­˜</span></div><div class="line">- (<span class="keyword">void</span>)cacheHieght:(<span class="built_in">CGFloat</span>)hieght key:(<span class="built_in">NSString</span> *)key;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>åˆ›å»º HeightCache è¿™æ ·ä¸€ä¸ªç±»ï¼Œä¸ºå…¶æ·»åŠ äº†ä¸‰ä¸ªå­—å…¸ä½œä¸ºå±æ€§ï¼Œåˆ†åˆ«å­˜å‚¨åœ¨æ‰‹æœºæ¨ªå±ç«–å±ä¸‹çš„ Cell ç¼“å­˜é«˜åº¦ï¼ŒCurrent å­—å…¸ä¸ºå½“å‰æ‰‹æœºå±å¹•çŠ¶æ€ä¸‹çš„ç¼“å­˜å­—å…¸ï¼Œåœ¨å®ƒçš„æ‡’åŠ è½½æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†åˆ¤æ–­ä½¿ç”¨çš„æ˜¯æ¨ªå±ç¼“å­˜å­—å…¸è¿˜æ˜¯ç«–å±ç¼“å­˜å­—å…¸ã€‚æš´éœ²å››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯â€œåˆ¶ä½œä»ç¼“å­˜å­—å…¸ä¸­å–ç¼“å­˜é«˜åº¦çš„ keyâ€ã€â€œåˆ¤æ–­æ­¤ key ä¸‹æ˜¯å¦æœ‰ç¼“å­˜é«˜åº¦â€ã€â€œé€šè¿‡ key å–å‡ºç¼“å­˜é«˜åº¦â€ã€â€œé€šè¿‡ key å°†å¯¹åº”é«˜åº¦ç¼“å­˜â€è¿™å››ä¸ªæ–¹æ³•ã€‚<br>å®ç°ç›¸å½“ç®€å•ï¼Œè¿™é‡Œç›´æ¥è´´ä¸Šä»£ç ï¼Œä¸åšè¿‡å¤šè§£é‡Šã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HeightCache</span></span></div><div class="line"></div><div class="line"><span class="comment">//åˆ¶ä½œkey</span></div><div class="line">- (<span class="built_in">NSString</span> *)makeKeyWithIdentifier:(<span class="built_in">NSString</span> *)identifier indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@S%ldR%ld"</span>,identifier,indexPath.section,indexPath.row];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//åˆ¤æ–­é«˜åº¦æ˜¯å¦å­˜åœ¨</span></div><div class="line">- (<span class="built_in">BOOL</span>)existInCacheByKey:(<span class="built_in">NSString</span> *)key&#123;</div><div class="line">    <span class="built_in">NSNumber</span> * value = [<span class="keyword">self</span>.heightCacheDicCurrent objectForKey:key];</div><div class="line">    <span class="keyword">return</span> (value &amp;&amp; ![value isEqualToNumber:@<span class="number">-1</span>]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å–å‡ºç¼“å­˜çš„é«˜åº¦</span></div><div class="line">- (<span class="built_in">CGFloat</span>)heightFromCacheWithKey:(<span class="built_in">NSString</span> *)key&#123;</div><div class="line">    <span class="built_in">NSNumber</span> *value = [<span class="keyword">self</span>.heightCacheDicCurrent objectForKey:key];</div><div class="line">    <span class="keyword">return</span> [value floatValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç¼“å­˜</span></div><div class="line">- (<span class="keyword">void</span>)cacheHieght:(<span class="built_in">CGFloat</span>)hieght key:(<span class="built_in">NSString</span> *)key&#123;</div><div class="line">    [<span class="keyword">self</span>.heightCacheDicCurrent setObject:@(hieght) forKey:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//lazy</span></div><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)heightCacheDicH&#123;</div><div class="line">    <span class="keyword">if</span> (!_heightCacheDicH) &#123;</div><div class="line">        _heightCacheDicH = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _heightCacheDicH;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)heightCacheDicV&#123;</div><div class="line">    <span class="keyword">if</span> (!_heightCacheDicV) &#123;</div><div class="line">        _heightCacheDicV = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _heightCacheDicV;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//æ ¹æ®æ¨ªç«–å±çŠ¶æ€é€‰æ‹©å­—å…¸</span></div><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)heightCacheDicCurrent&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIDeviceOrientationIsPortrait</span>([<span class="built_in">UIDevice</span> currentDevice].orientation)?<span class="keyword">self</span>.heightCacheDicV:<span class="keyword">self</span>.heightCacheDicH;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="é‡ç‚¹ï¼åˆ›å»º-UITableView-çš„-Category-ï¼Œè®¡ç®—-Cell-é«˜åº¦å¹¶ç¼“å­˜"><a href="#é‡ç‚¹ï¼åˆ›å»º-UITableView-çš„-Category-ï¼Œè®¡ç®—-Cell-é«˜åº¦å¹¶ç¼“å­˜" class="headerlink" title="é‡ç‚¹ï¼åˆ›å»º UITableView çš„ Category ï¼Œè®¡ç®— Cell é«˜åº¦å¹¶ç¼“å­˜"></a>é‡ç‚¹ï¼åˆ›å»º UITableView çš„ Category ï¼Œè®¡ç®— Cell é«˜åº¦å¹¶ç¼“å­˜</h3><h4 id="æˆ‘ä»¬é¦–å…ˆä¸º-UITableView-æ·»åŠ ä¸€ä¸ª-HeightCache-ä½œä¸ºå±æ€§ï¼Œæ–¹ä¾¿ç”¨æ¥å­˜å‚¨é«˜åº¦ç¼“å­˜ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨-Runtime-çš„æ–¹æ³•"><a href="#æˆ‘ä»¬é¦–å…ˆä¸º-UITableView-æ·»åŠ ä¸€ä¸ª-HeightCache-ä½œä¸ºå±æ€§ï¼Œæ–¹ä¾¿ç”¨æ¥å­˜å‚¨é«˜åº¦ç¼“å­˜ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨-Runtime-çš„æ–¹æ³•" class="headerlink" title="æˆ‘ä»¬é¦–å…ˆä¸º UITableView æ·»åŠ ä¸€ä¸ª HeightCache ä½œä¸ºå±æ€§ï¼Œæ–¹ä¾¿ç”¨æ¥å­˜å‚¨é«˜åº¦ç¼“å­˜ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨ Runtime çš„æ–¹æ³•"></a>æˆ‘ä»¬é¦–å…ˆä¸º UITableView æ·»åŠ ä¸€ä¸ª HeightCache ä½œä¸ºå±æ€§ï¼Œæ–¹ä¾¿ç”¨æ¥å­˜å‚¨é«˜åº¦ç¼“å­˜ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨ Runtime çš„æ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark ------ ç»‘å®šå±æ€§</span></div><div class="line"></div><div class="line">- (HeightCache *)heightCache&#123;</div><div class="line">    HeightCache *cache = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">    <span class="keyword">if</span> (!cache) &#123;</div><div class="line">        cache = [[HeightCache alloc] init];</div><div class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, _cmd, cache, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> cache;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHeightCache:(HeightCache *)heightCache&#123;</div><div class="line">    </div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(heightCache), heightCache, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ä»å¤ç”¨æ± ä¸­è·å–ä¸€ä¸ªç”¨äºè®¡ç®—çš„-Cell"><a href="#ä»å¤ç”¨æ± ä¸­è·å–ä¸€ä¸ªç”¨äºè®¡ç®—çš„-Cell" class="headerlink" title="ä»å¤ç”¨æ± ä¸­è·å–ä¸€ä¸ªç”¨äºè®¡ç®—çš„ Cell"></a>ä»å¤ç”¨æ± ä¸­è·å–ä¸€ä¸ªç”¨äºè®¡ç®—çš„ Cell</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è·å–ä¸€ä¸ªç”¨äºè®¡ç®—é«˜åº¦çš„Cell</span></div><div class="line">- (__kindof <span class="built_in">UITableViewCell</span> *)LLQ_CalculateCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!identifier.length) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//runtimeè·å–ä¸€ä¸ªå­˜å‚¨cellçš„å­—å…¸</span></div><div class="line">    <span class="built_in">NSMutableDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">UITableViewCell</span> *&gt; *dicForTheUniqueCalCell = objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</div><div class="line">    <span class="comment">//å¦‚æœå–ä¸åˆ°ï¼Œå°±ç»‘å®šä¸€ä¸ª</span></div><div class="line">    <span class="keyword">if</span> (!dicForTheUniqueCalCell) &#123;</div><div class="line">        dicForTheUniqueCalCell = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</div><div class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, _cmd, dicForTheUniqueCalCell, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//å–å‡ºcellï¼Œä»ç»‘å®šçš„å­—å…¸å–ç”¨</span></div><div class="line">    <span class="built_in">UITableViewCell</span> *cell = dicForTheUniqueCalCell[identifier];</div><div class="line">    <span class="keyword">if</span> (!cell) &#123;</div><div class="line">        cell = [<span class="keyword">self</span> dequeueReusableCellWithIdentifier:identifier];</div><div class="line">        cell.contentView.translatesAutoresizingMaskIntoConstraints = <span class="literal">NO</span>; <span class="comment">//è®¾ç½®ä¸ºNOæ‰èƒ½ç”¨ä»£ç ä½¿ç”¨AutoLayout</span></div><div class="line">        cell.justForCalculate = <span class="literal">YES</span>; <span class="comment">//è®¾ç½®åªè®¡ç®—</span></div><div class="line">        dicForTheUniqueCalCell[identifier] = cell;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> cell;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•ä¸­ä¸º UITableView ç»‘å®šäº†ä¸€ä¸ªå­—å…¸ï¼Œç›®çš„æ˜¯å­˜å‚¨æŸä¸€ç§ç±»çš„ Cellï¼Œè€ŒåŒºåˆ† Cell ç§ç±»çš„åŠæ³•å°±æ˜¯é€šè¿‡ Cell çš„é‡ç”¨æ ‡è¯†ç¬¦ã€‚é€šè¿‡é‡ç”¨æ ‡è¯†ç¬¦ä»å­—å…¸ä¸­è·å– Cellï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±ä» TableView çš„å¤ç”¨æ± ä¸­å–å‡ºä¸€ä¸ªæ­¤ç§ç±»çš„ Cellï¼Œå¹¶è®¾ç½®åªè®¡ç®—å±æ€§ï¼Œå­˜å…¥ç»‘å®šçš„å­—å…¸ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±ä¿è¯äº†æ¯ç§ç±»çš„ Cell æœ‰ä¸”åªæœ‰ä¸€ä¸ªç”¨æ¥è®¡ç®—ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®é™…é¡¹ç›®ä½¿ç”¨ä¸­æˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code>-registerClass:forCellReuseIdentifier:</code> æˆ– <code>-registerNib:forCellReuseIdentifier:</code>å…¶ä¸­ä¹‹ä¸€çš„æ–¹æ³•å¯¹ Cell è¿›è¡Œæ³¨å†Œã€‚</p>
<h4 id="è®¡ç®—-Cell-çš„é«˜åº¦"><a href="#è®¡ç®—-Cell-çš„é«˜åº¦" class="headerlink" title="è®¡ç®— Cell çš„é«˜åº¦"></a>è®¡ç®— Cell çš„é«˜åº¦</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è®¡ç®—cellé«˜åº¦</span></div><div class="line">- (<span class="built_in">CGFloat</span>)LLQ_CalculateCellHeightWithCell:(<span class="built_in">UITableViewCell</span> *)cell&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> width = <span class="keyword">self</span>.bounds.size.width;</div><div class="line">    </div><div class="line">    <span class="comment">//æ ¹æ®è¾…åŠ©è§†å›¾ï¼Œè°ƒæ•´å®½åº¦</span></div><div class="line">    <span class="keyword">if</span> (cell.accessoryView) &#123;</div><div class="line">        width -= cell.accessoryView.bounds.size.width + <span class="number">16</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> accessoryWith[] = &#123;</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryNone</span>] = <span class="number">0</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryCheckmark</span>] = <span class="number">40</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDetailButton</span>] = <span class="number">48</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDisclosureIndicator</span>] = <span class="number">34</span>,</div><div class="line">            [<span class="built_in">UITableViewCellAccessoryDetailDisclosureButton</span>] = <span class="number">68</span>,</div><div class="line">        &#125;;</div><div class="line">        width -= accessoryWith[cell.accessoryType];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">CGFloat</span> height = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//éè‡ªé€‚åº”æ¨¡å¼ï¼Œæ·»åŠ çº¦æŸåè®¡ç®—çº¦æŸåé«˜åº¦</span></div><div class="line">    <span class="keyword">if</span> (!cell.noAuotSizeing &amp;&amp; width&gt;<span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">NSLayoutConstraint</span> *widthConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeWidth</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:<span class="literal">nil</span> attribute:<span class="built_in">NSLayoutAttributeNotAnAttribute</span> multiplier:<span class="number">1.0</span> constant:width];</div><div class="line">        [cell.contentView addConstraint:widthConstraint];</div><div class="line">        <span class="comment">//æ ¹æ®çº¦æŸè®¡ç®—é«˜åº¦</span></div><div class="line">        height = [cell.contentView systemLayoutSizeFittingSize:<span class="built_in">UILayoutFittingCompressedSize</span>].height;</div><div class="line">        [cell.contentView removeConstraint:widthConstraint]; <span class="comment">//ç§»é™¤çº¦æŸ</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//å¦‚æœçº¦æŸæ·»åŠ é”™è¯¯ï¼Œå¯èƒ½å¯¼è‡´è®¡ç®—ç»“æœä¸º0ï¼Œåˆ™é‡‡ç”¨è‡ªé€‚åº”æ¨¡å¼è®¡ç®—çº¦æŸ</span></div><div class="line">    <span class="keyword">if</span> (height == <span class="number">0</span>) &#123;</div><div class="line">        height = [cell sizeThatFits:<span class="built_in">CGSizeMake</span>(width, <span class="number">0</span>)].height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//è¿˜æ˜¯ä¸º0ï¼Œé»˜è®¤é«˜åº¦</span></div><div class="line">    <span class="keyword">if</span> (height == <span class="number">0</span>) &#123;</div><div class="line">        height = <span class="number">44</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.separatorStyle != <span class="built_in">UITableViewCellSeparatorStyleNone</span>) &#123;</div><div class="line">        height += <span class="number">1.0</span>/[<span class="built_in">UIScreen</span> mainScreen].scale;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> height;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè®¡ç®— Cell çš„ widthï¼Œå¦‚æœæœ‰è¾…åŠ©è§†å›¾ï¼Œæˆ‘ä»¬è¿˜è¦ä¿®æ­£ widthï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ AutoSizeing æ¨¡å¼ï¼Œæ¥å†³å®šä½¿ç”¨å“ªç§æ–¹å¼ç®— Cell çš„é«˜åº¦ï¼Œå¦‚æœä½¿ç”¨çº¦æŸç®—é«˜ï¼Œå°±æ˜¯é€šè¿‡æ·»åŠ ä¸€ä¸ªæˆ‘ä»¬ç®—å¥½çš„å›ºå®š width çš„çº¦æŸï¼Œä»è€Œå¾—å‡º Cell çš„é«˜åº¦ã€‚èƒ½å¤Ÿè¿™æ ·åšçš„å‰ææ˜¯æˆ‘ä»¬åœ¨ xib ä¸­ä½¿ç”¨çš„ autolayout çº¦æŸæ­£ç¡®ã€‚åœ¨æœ€ååˆ¤æ–­ä¸€ä¸‹æœ‰æ— åˆ†å‰²çº¿ï¼Œåšæœ€åä¸€æ¬¡é«˜åº¦ä¿®æ­£ã€‚</p>
<h4 id="å°†ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•æ•´åˆï¼Œç»™-Cell-å¡«å……æ•°æ®åè®¡ç®—å‡ºå½“å‰-Cell-çš„é«˜åº¦"><a href="#å°†ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•æ•´åˆï¼Œç»™-Cell-å¡«å……æ•°æ®åè®¡ç®—å‡ºå½“å‰-Cell-çš„é«˜åº¦" class="headerlink" title="å°†ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•æ•´åˆï¼Œç»™ Cell å¡«å……æ•°æ®åè®¡ç®—å‡ºå½“å‰ Cell çš„é«˜åº¦"></a>å°†ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•æ•´åˆï¼Œç»™ Cell å¡«å……æ•°æ®åè®¡ç®—å‡ºå½“å‰ Cell çš„é«˜åº¦</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å–å‡ºcellå¹¶å¯¹cellè¿›è¡Œæ“ä½œï¼Œç„¶åè®¡ç®—é«˜åº¦</span></div><div class="line">- (<span class="built_in">CGFloat</span>)LLQ_CalculateCellWithIdentifier:(<span class="built_in">NSString</span> *)identifier configuration:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> cell))configuration&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!identifier.length) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">UITableViewCell</span> *cell = [<span class="keyword">self</span> LLQ_CalculateCellWithIdentifier:identifier];</div><div class="line">    [cell prepareForReuse]; <span class="comment">//æ”¾å›é‡ç”¨æ± </span></div><div class="line">    <span class="keyword">if</span> (configuration) &#123;</div><div class="line">        configuration(cell);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> LLQ_CalculateCellHeightWithCell:cell];</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆè·å–ä¸€ä¸ª Cell ç„¶åå°†å…¶æ”¾å›å¤ç”¨æ± ï¼ˆå› ä¸ºæˆ‘ä»¬åœ¨å– Cell çš„æ–¹æ³•ä¸­æ²¡æœ‰å°†å…¶æ”¾å›ï¼‰ï¼Œç„¶åç»™ Cell å¡«å……æ•°æ®ï¼Œè¿™é‡Œä½¿ç”¨äº† block å°† Cell ä¼ é€’åˆ°å¤–ç•Œï¼Œå¡«å……å®Œæ•°æ®åä½¿ç”¨ç®—é«˜æ–¹æ³•è®¡ç®—é«˜åº¦ã€‚</p>
<h4 id="è®¡ç®—é«˜åº¦ï¼Œå¹¶å°†è®¡ç®—çš„é«˜åº¦ç¼“å­˜ï¼Œæœ¬æ–¹æ³•æš´éœ²ç»™å¤–ç•Œå…±å¤–ç•Œè°ƒç”¨"><a href="#è®¡ç®—é«˜åº¦ï¼Œå¹¶å°†è®¡ç®—çš„é«˜åº¦ç¼“å­˜ï¼Œæœ¬æ–¹æ³•æš´éœ²ç»™å¤–ç•Œå…±å¤–ç•Œè°ƒç”¨" class="headerlink" title="è®¡ç®—é«˜åº¦ï¼Œå¹¶å°†è®¡ç®—çš„é«˜åº¦ç¼“å­˜ï¼Œæœ¬æ–¹æ³•æš´éœ²ç»™å¤–ç•Œå…±å¤–ç•Œè°ƒç”¨"></a>è®¡ç®—é«˜åº¦ï¼Œå¹¶å°†è®¡ç®—çš„é«˜åº¦ç¼“å­˜ï¼Œæœ¬æ–¹æ³•æš´éœ²ç»™å¤–ç•Œå…±å¤–ç•Œè°ƒç”¨</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä¾›å¤–éƒ¨è°ƒç”¨çš„æ–¹æ³•</span></div><div class="line">- (<span class="built_in">CGFloat</span>)LLQ_CalculateCellWithIdentifer:(<span class="built_in">NSString</span> *)identifier indexPath:(<span class="built_in">NSIndexPath</span> *)indexPath configuration:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> cell))configuration&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.bounds.size.width != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!identifier.length || !indexPath) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">NSString</span> *key = [<span class="keyword">self</span>.heightCache makeKeyWithIdentifier:identifier indexPath:indexPath];</div><div class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.heightCache existInCacheByKey:key]) &#123;  <span class="comment">//å¦‚æœæœ‰ç¼“å­˜ï¼Œå°±å–å‡ºç¼“å­˜</span></div><div class="line">            <span class="keyword">return</span> [<span class="keyword">self</span>.heightCache heightFromCacheWithKey:key]; <span class="comment">//ä»å­—å…¸ä¸­å–å‡ºé«˜åº¦</span></div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ²¡æœ‰ç¼“å­˜ï¼Œè®¡ç®—ç¼“å­˜</span></div><div class="line">        <span class="built_in">CGFloat</span> height = [<span class="keyword">self</span> LLQ_CalculateCellWithIdentifier:identifier configuration:configuration];</div><div class="line">        <span class="comment">//å¹¶è¿›è¡Œç¼“å­˜</span></div><div class="line">        [<span class="keyword">self</span>.heightCache cacheHieght:height key:key];</div><div class="line">        <span class="keyword">return</span> height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆä½¿ç”¨é‡ç”¨æ ‡è¯†ç¬¦å’Œ IndexPath åˆ¶ä½œé«˜åº¦ç¼“å­˜çš„ keyï¼Œè¿™æ ·åˆ¶ä½œå‡ºçš„ key å°±èƒ½ä¿è¯ç§ç±»ã€ç»„ã€è¡Œçš„å”¯ä¸€æ€§ï¼Œç„¶åä½¿ç”¨è¿™ä¸ª key å»å–ç¼“å­˜çš„é«˜åº¦ï¼Œè‹¥æ²¡æœ‰ç¼“å­˜é«˜åº¦å°±è¿›è¡Œè®¡ç®—ã€‚</p>
<blockquote>
<p><strong>æœ¬ Demo å®ç°äº† TableView çš„è¡Œé«˜è‡ªé€‚åº”ä¸è¡Œé«˜ç¼“å­˜ï¼Œè¿™åªæ˜¯ FDTemplateLayoutCell çš„ä¸€éƒ¨åˆ†ä¸»è¦åŠŸèƒ½ï¼Œåœ¨é¡¹ç›®å¤æ‚æƒ…å†µä¸‹ä¸å¤Ÿé€‚ç”¨ï¼Œæ¯”å¦‚åœ¨ç§»åŠ¨ä¸€ä¸ªå•å…ƒæ ¼ï¼Œåˆ é™¤ä¸€ä¸ªå•å…ƒæ ¼ç­‰æƒ…å†µæ—¶æœ¬ Demo æ²¡æœ‰ç›¸åº”çš„å¤„ç†å®ç°ï¼Œå¦‚æœå„ä½å°ä¼™ä¼´é¡¹ç›®éœ€è¦ï¼Œè¯·ç›´æ¥ä½¿ç”¨ <a href="https://github.com/forkingdog/UITableView-FDTemplateLayoutCell" target="_blank" rel="external">FDTemplateLayoutCell</a>ã€‚</strong></p>
</blockquote>
<p><strong>æœ¬ Demo ä»…ä¾›å­¦ä¹ ä½¿ç”¨ã€‚</strong></p>
<p>æœ€åï¼Œæˆ‘è¿˜æ˜¯ä¼šæŒ‰ç…§æƒ¯ä¾‹æŠŠ Demo å…±äº«ç»™å¤§å®¶<br><a href="https://github.com/li1024316925/UITableviewHeightCache" target="_blank" rel="external">Demoç‚¹è¿™é‡Œï¼ç‚¹è¿™é‡Œï¼ç‚¹è¿™é‡Œï¼</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-å°è£…ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åŠ è½½ä¸ç¼“å­˜ Category"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/02/18/å°è£…ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åŠ è½½ä¸ç¼“å­˜ Category/">å°è£…ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åŠ è½½ä¸ç¼“å­˜ Category</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/02/18/å°è£…ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åŠ è½½ä¸ç¼“å­˜ Category/" class="article-date">
	  <time datetime="2017-02-18T07:54:46.000Z" itemprop="datePublished">2017-02-18</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>åˆæœ‰å¥½å¤šå¤©æ²¡å†™åšå®¢äº†ï¼ŒMarkdown è¯­æ³•éƒ½å¿«å¿˜äº†â€¦.</p>
<p><strong>æ­¥å…¥æ­£é¢˜ï¼Œèµ¶ç´§æ¥çœ‹çœ‹æˆ‘ä»¬ä»Šå¤©è¦æçš„äº‹æƒ…</strong></p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-09995ecaf5360971.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/340" alt="å·å·å‘Šè¯‰ä½ ï¼Œæˆ‘ä»¬è¦æäº‹æƒ…å•¦.jpg"></p>
<blockquote>
<p>æ—å‹ï¼Œå¬è¯´è¿‡ SDWebImage ä¼ï¼Ÿä»Šå¤©æˆ‘ä»¬è¦æå¾—äº‹æƒ…å°±æ˜¯åšä¸€ä¸ªç±»ä¼¼çš„ UIImageView Categoryï¼Œç½‘ç»œå›¾ç‰‡çš„åŠ è½½ä¸ç¼“å­˜ï¼ˆä»€ä¹ˆï¼Ÿå–ä»£ SD ï¼Ÿæ—å‹ä½ æƒ³å¤šäº†ï¼‰</p>
</blockquote>
<h3 id="é¦–å…ˆè¯´ä¸€ä¸‹æ€è·¯"><a href="#é¦–å…ˆè¯´ä¸€ä¸‹æ€è·¯" class="headerlink" title="é¦–å…ˆè¯´ä¸€ä¸‹æ€è·¯"></a>é¦–å…ˆè¯´ä¸€ä¸‹æ€è·¯</h3><p>å¦‚æœé¡µé¢ä¸­æœ‰å¤šä¸ª ImageView æˆ‘ä»¬æ¯æ¬¡åŠ è½½è¿™ä¸ªé¡µé¢éƒ½è¦é‡æ–°å»ç½‘ç»œè¯·æ±‚å›¾ç‰‡çš„è¯é€Ÿåº¦æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œè€Œä¸”ä¹Ÿæ˜¯ç‰¹åˆ«æ¶ˆè€—æ€§èƒ½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ª Category ä¸å…‰æ˜¯ä»ç½‘ç»œåŠ è½½å›¾ç‰‡ï¼Œæˆ‘ä»¬çš„å¦ä¸€ä¸ªç›®çš„æ˜¯å°†ç¬¬ä¸€æ¬¡ä»ç½‘ç»œåŠ è½½çš„å›¾ç‰‡ç¼“å­˜åˆ°å†…å­˜ä¸ç¡¬ç›˜ï¼ˆå°±æ˜¯å­˜åˆ°æ‰‹æœºçš„é—ªå­˜ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°åŒ–ä¿å­˜ï¼Œä¸ºäº†æ–¹ä¾¿ä»¥ä¸‹ç»Ÿç§°å­˜åˆ°ç¡¬ç›˜ï¼‰ï¼Œä¸‹æ¬¡å–ç”¨çš„æ—¶å€™å…ˆä»å†…å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰å†æŸ¥æ‰¾ç¡¬ç›˜ï¼Œè¿˜æ˜¯æ²¡æœ‰å†ä»ç½‘ç»œåŠ è½½ã€‚</p>
<h3 id="å¼€å§‹ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆåˆ›å»ºä¹‹åæ‰€éœ€è¦çš„ç¼“å­˜å†…å­˜ä¸ç¡¬ç›˜çš„å·¥å…·ç±»"><a href="#å¼€å§‹ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆåˆ›å»ºä¹‹åæ‰€éœ€è¦çš„ç¼“å­˜å†…å­˜ä¸ç¡¬ç›˜çš„å·¥å…·ç±»" class="headerlink" title="å¼€å§‹ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆåˆ›å»ºä¹‹åæ‰€éœ€è¦çš„ç¼“å­˜å†…å­˜ä¸ç¡¬ç›˜çš„å·¥å…·ç±»"></a>å¼€å§‹ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆåˆ›å»ºä¹‹åæ‰€éœ€è¦çš„ç¼“å­˜å†…å­˜ä¸ç¡¬ç›˜çš„å·¥å…·ç±»</h3><h4 id="å†…å­˜å­˜å‚¨å·¥å…·ç±»"><a href="#å†…å­˜å­˜å‚¨å·¥å…·ç±»" class="headerlink" title="å†…å­˜å­˜å‚¨å·¥å…·ç±»"></a>å†…å­˜å­˜å‚¨å·¥å…·ç±»</h4><p>å†…å­˜å­˜å‚¨ï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠä¸‹è½½å¥½çš„å›¾ç‰‡å­˜åˆ°å¯å˜å­—å…¸ï¼Œæˆ‘è¿™è¾¹ä½¿ç”¨äº†ä¸€ä¸ªå•ä¾‹æ¥ä¿å­˜è¿™ä¸ªå­—å…¸<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebImageMemory</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="comment">//ä½¿ç”¨å­—å…¸å­˜å‚¨</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSMutableDictionary</span> *imageDic;</div><div class="line"></div><div class="line"><span class="comment">//å•ä¾‹æ–¹æ³•</span></div><div class="line">+ (WebImageMemory *)shareInstancy;</div><div class="line"></div><div class="line"><span class="comment">//å†…å­˜å­˜å‚¨çš„æ–¹æ³•</span></div><div class="line">- (<span class="keyword">void</span>)setImageToMemoryWithImage:(<span class="built_in">UIImage</span> *)image withName:(<span class="built_in">NSString</span> *)imageName;</div><div class="line"></div><div class="line"><span class="comment">//å†…å­˜è¯»å–çš„æ–¹æ³•</span></div><div class="line">- (<span class="built_in">UIImage</span> *)getImageFormMenoryWithName:(<span class="built_in">NSString</span> *)imageName;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>ä¸‹é¢æ˜¯å®ç°ä»£ç <br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> WebImageMemory *webImgMemory;</div><div class="line"><span class="comment">//å•ä¾‹æ–¹æ³•</span></div><div class="line">+ (WebImageMemory *)shareInstancy&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//GCDåªæ‰§è¡Œä¸€æ¬¡çš„æ–¹æ³•</span></div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        </div><div class="line">        webImgMemory = [[WebImageMemory alloc] init];</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> webImgMemory;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//æ‡’åŠ è½½</span></div><div class="line">- (<span class="built_in">NSMutableDictionary</span> *)imageDic&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!_imageDic) &#123;</div><div class="line">        </div><div class="line">        _imageDic = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _imageDic;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å­˜å‚¨çš„æ–¹æ³•</span></div><div class="line">- (<span class="keyword">void</span>)setImageToMemoryWithImage:(<span class="built_in">UIImage</span> *)image withName:(<span class="built_in">NSString</span> *)imageName&#123;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.imageDic setObject:image forKey:imageName];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è¯»å–çš„æ–¹æ³•</span></div><div class="line">- (<span class="built_in">UIImage</span> *)getImageFormMenoryWithName:(<span class="built_in">NSString</span> *)imageName&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span>.imageDic objectForKey:imageName];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (image) &#123;</div><div class="line">        <span class="keyword">return</span> image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå†…å­˜å­˜å‚¨ç›¸å½“ç®€å•ï¼Œæˆ‘ä»¬å†çœ‹çœ‹ç¡¬ç›˜å­˜å‚¨</p>
<h4 id="ç¡¬ç›˜å­˜å‚¨å·¥å…·ç±»"><a href="#ç¡¬ç›˜å­˜å‚¨å·¥å…·ç±»" class="headerlink" title="ç¡¬ç›˜å­˜å‚¨å·¥å…·ç±»"></a>ç¡¬ç›˜å­˜å‚¨å·¥å…·ç±»</h4><p>åŒæ ·çš„ï¼Œæˆ‘ä¹Ÿæ˜¯ç”¨ä¸€ä¸ªå•ä¾‹æ¥ç®¡ç†å­˜å‚¨çš„ä¸€äº›ç›¸å…³æ“ä½œï¼Œå¹¶ä¿å­˜æœ¬åœ°å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebImageCaches</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> *imagePath;</div><div class="line"></div><div class="line"><span class="comment">//å•ä¾‹</span></div><div class="line">+ (WebImageCaches *)shareInstance;</div><div class="line"></div><div class="line"><span class="comment">//ç¡¬ç›˜å­˜å‚¨çš„æ–¹æ³•</span></div><div class="line">- (<span class="keyword">void</span>)setImageToCachesWithImageData:(<span class="built_in">NSData</span> *)imageData withImageName:(<span class="built_in">NSString</span> *)imageName;</div><div class="line"></div><div class="line"><span class="comment">//ç¡¬ç›˜ç¼“å­˜çš„æ–¹æ³•</span></div><div class="line">- (<span class="built_in">UIImage</span> *)getImageFromCachesWithName:(<span class="built_in">NSString</span> *)imageName;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>å®ç°éƒ¨åˆ†ï¼Œè¿™è¾¹ç”¨ä¿å­˜å¥½çš„æœ¬åœ°è·¯å¾„æ‹¼æ¥ä¸Šæ–‡ä»¶åï¼Œä½œä¸ºä¿å­˜å›¾ç‰‡æ–‡ä»¶çš„æœ€ç»ˆè·¯å¾„<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> WebImageCaches *imageCaches;</div><div class="line"><span class="comment">//å•ä¾‹æ–¹æ³•</span></div><div class="line">+ (WebImageCaches *)shareInstance&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        </div><div class="line">        imageCaches = [[WebImageCaches alloc] init];</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> imageCaches;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å¤å†™imagePathçš„getæ–¹æ³•ï¼Œåœ¨ç¬¬ä¸€æ¬¡getæ—¶ç»™imagePathèµ‹å€¼</span></div><div class="line">- (<span class="built_in">NSString</span> *)imagePath&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (!_imagePath) &#123;</div><div class="line">        <span class="comment">//è·å–æ–‡ä»¶å­˜å‚¨è·¯å¾„</span></div><div class="line">        _imagePath = [<span class="built_in">NSHomeDirectory</span>() stringByAppendingString:<span class="string">@"/Library/Caches/WebImageCaches/"</span>];</div><div class="line">        <span class="comment">//é€šè¿‡æ–‡ä»¶ç®¡å®¶åˆ›å»ºè¯¥è·¯å¾„</span></div><div class="line">        [[<span class="built_in">NSFileManager</span> defaultManager] createDirectoryAtPath:_imagePath withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:<span class="literal">nil</span>];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> _imagePath;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//å­˜å…¥ç¡¬ç›˜</span></div><div class="line">- (<span class="keyword">void</span>)setImageToCachesWithImageData:(<span class="built_in">NSData</span> *)imageData withImageName:(<span class="built_in">NSString</span> *)imageName&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//æ‹¼æ¥æ–‡ä»¶è·¯å¾„</span></div><div class="line">    <span class="built_in">NSString</span> *filePath = [<span class="keyword">self</span>.imagePath stringByAppendingString:imageName];</div><div class="line">    <span class="comment">//ä½¿ç”¨æ–‡ä»¶ç®¡å®¶å°†dataå­˜å‚¨</span></div><div class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] createFileAtPath:filePath contents:imageData attributes:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ä»ç¡¬ç›˜è¯»å–</span></div><div class="line">- (<span class="built_in">UIImage</span> *)getImageFromCachesWithName:(<span class="built_in">NSString</span> *)imageName&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//æ‹¼æ¥æ–‡ä»¶è·¯å¾„</span></div><div class="line">    <span class="built_in">NSString</span> *filePath = [<span class="keyword">self</span>.imagePath stringByAppendingString:imageName];</div><div class="line">    <span class="comment">//å–å‡ºå›¾ç‰‡</span></div><div class="line">    <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithContentsOfFile:filePath];</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> image;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ç¬¬äºŒæ­¥ï¼Œåˆ›å»º-UIImageView-çš„-Category"><a href="#ç¬¬äºŒæ­¥ï¼Œåˆ›å»º-UIImageView-çš„-Category" class="headerlink" title="ç¬¬äºŒæ­¥ï¼Œåˆ›å»º UIImageView çš„ Category"></a>ç¬¬äºŒæ­¥ï¼Œåˆ›å»º UIImageView çš„ Category</h3><h4 id="ä½¿ç”¨-MD5-åŠ å¯†å›¾ç‰‡é“¾æ¥ä½œä¸ºå›¾ç‰‡å"><a href="#ä½¿ç”¨-MD5-åŠ å¯†å›¾ç‰‡é“¾æ¥ä½œä¸ºå›¾ç‰‡å" class="headerlink" title="ä½¿ç”¨ MD5 åŠ å¯†å›¾ç‰‡é“¾æ¥ä½œä¸ºå›¾ç‰‡å"></a>ä½¿ç”¨ MD5 åŠ å¯†å›¾ç‰‡é“¾æ¥ä½œä¸ºå›¾ç‰‡å</h4><p>è¿™è¾¹è®°å¾—è¦å¯¼å…¥<code>#import &lt;CommonCrypto/CommonCrypto.h&gt;</code><br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//MD5åŠ å¯†</span></div><div class="line">- (<span class="built_in">NSString</span> *)md5:(<span class="built_in">NSString</span> *)str&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cStr = [str UTF8String];</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> schemes[CC_MD5_DIGEST_LENGTH];</div><div class="line">    </div><div class="line">    <span class="comment">//MD5åŠ å¯†å‡½æ•°</span></div><div class="line">    CC_MD5(cStr, (<span class="built_in">UInt32</span>)strlen(cStr), schemes);</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableString</span> *md5Str = [[<span class="built_in">NSMutableString</span> alloc] init];</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CC_MD5_DIGEST_LENGTH; i ++) &#123;</div><div class="line">        </div><div class="line">        [md5Str appendFormat:<span class="string">@"%02x"</span>,schemes[i]];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    [md5Str appendFormat:<span class="string">@".png"</span>];</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">return</span> md5Str;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="æš´éœ²ä¸€ä¸ªè·å–å›¾ç‰‡çš„æ–¹æ³•"><a href="#æš´éœ²ä¸€ä¸ªè·å–å›¾ç‰‡çš„æ–¹æ³•" class="headerlink" title="æš´éœ²ä¸€ä¸ªè·å–å›¾ç‰‡çš„æ–¹æ³•"></a>æš´éœ²ä¸€ä¸ªè·å–å›¾ç‰‡çš„æ–¹æ³•</h4><p><code>- (void)setimageWithURL:(NSString *)urlString;</code><br>æ¥çœ‹çœ‹å®ƒçš„å®ç°<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setimageWithURL:(<span class="built_in">NSString</span> *)urlString&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//MD5åŠ å¯†</span></div><div class="line">    <span class="built_in">NSString</span> *imageName = [<span class="keyword">self</span> md5:urlString];</div><div class="line">    </div><div class="line">    <span class="comment">//é¦–å…ˆä»å†…å­˜ä¸­è¯»å–</span></div><div class="line">    <span class="built_in">UIImage</span> *image = [[WebImageMemory shareInstancy] getImageFormMenoryWithName:imageName];</div><div class="line">    </div><div class="line">    <span class="comment">//å¦‚æœèƒ½ä»å†…å­˜å–åˆ°å€¼ï¼Œå°±ç›´æ¥åŠ è½½</span></div><div class="line">    <span class="keyword">if</span> (image) &#123;</div><div class="line">        <span class="keyword">self</span>.image = image;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ä»å†…å­˜åŠ è½½"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//å…¶æ¬¡ä»ç¡¬ç›˜ä¸­è¯»å–</span></div><div class="line">    <span class="built_in">UIImage</span> *image2 = [[WebImageCaches shareInstance] getImageFromCachesWithName:imageName];</div><div class="line">    </div><div class="line">    <span class="comment">//å¦‚æœèƒ½ä»ç¡¬ç›˜ä¸­å–åˆ°ï¼Œå°±ç›´æ¥åŠ è½½</span></div><div class="line">    <span class="keyword">if</span> (image2) &#123;</div><div class="line">        <span class="keyword">self</span>.image = image2;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ä»ç¡¬ç›˜åŠ è½½"</span>);</div><div class="line">        <span class="comment">//å­˜å…¥å†…å­˜</span></div><div class="line">        [[WebImageMemory shareInstancy] setImageToMemoryWithImage:image2 withName:imageName];</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰§è¡Œä¸‹è½½ä»»åŠ¡</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> download_queu = dispatch_queue_create(<span class="string">"download_queue"</span>, DISPATCH_QUEUE_SERIAL);</div><div class="line">    </div><div class="line">    <span class="comment">//å¼‚æ­¥æ·»åŠ ä»»åŠ¡  å¼€è¾Ÿå­çº¿ç¨‹</span></div><div class="line">    <span class="built_in">dispatch_async</span>(download_queu, ^&#123;</div><div class="line">       </div><div class="line">        <span class="comment">//ä¸‹è½½ä»»åŠ¡</span></div><div class="line">        <span class="built_in">NSURL</span> *imageURL = [<span class="built_in">NSURL</span> URLWithString:urlString];</div><div class="line">        <span class="built_in">NSData</span> *imageData = [<span class="built_in">NSData</span> dataWithContentsOfURL:imageURL];</div><div class="line">        <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:imageData];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ä¸‹è½½"</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (image == <span class="literal">nil</span>) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"å›¾ç‰‡ä¸‹è½½å¤±è´¥"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">//è·å–ä¸»é˜Ÿåˆ—å‘ä¸»é˜Ÿåˆ—å¼‚æ­¥æ·»åŠ åŠ è½½å›¾ç‰‡çš„ä»»åŠ¡</span></div><div class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">           </div><div class="line">            <span class="keyword">self</span>.image = image;</div><div class="line">            <span class="comment">//å°†ç½‘è·¯ä¸‹è½½çš„å›¾ç‰‡å­˜å…¥å†…å­˜</span></div><div class="line">            [[WebImageMemory shareInstancy] setImageToMemoryWithImage:image withName:imageName];</div><div class="line">            </div><div class="line">            <span class="comment">//å­˜å…¥ç¡¬ç›˜</span></div><div class="line">            [[WebImageCaches shareInstance] setImageToCachesWithImageData:imageData withImageName:imageName];</div><div class="line">            </div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é¦–å…ˆå°†å›¾ç‰‡é“¾æ¥ç»è¿‡ MD5 åŠ å¯†åä½œä¸ºæ–‡ä»¶åå»æŸ¥æ‰¾å†…å­˜å­—å…¸ä¸­æœ‰æ²¡æœ‰ä¿å­˜æœ‰çš„è¯ç›´æ¥å–å‡ºæ¥ï¼Œæ˜¾ç¤ºåˆ° UIï¼Œæ²¡æœ‰çš„è¯æŸ¥æ‰¾ç¡¬ç›˜ä¸­ä¸æ²¡æœ‰ä¿å­˜å›¾ç‰‡æ–‡ä»¶ï¼Œæœ‰çš„è¯å–å‡ºæ¥æ›´æ–°åˆ° UIï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€æ¡ä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™æ ·ä¿è¯å›¾ç‰‡æ˜¯ä¸€ä¸ªä¸ªåŠ è½½çš„ï¼Œå‘è¿™ä¸ªä¸²è¡Œé˜Ÿåˆ—å¼‚æ­¥æ·»åŠ ä¸‹è½½ä»»åŠ¡ï¼Œä¸‹è½½å®Œæˆåä¿å­˜åˆ°å†…å­˜ä¸ç¡¬ç›˜</p>
<blockquote>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ªç®€å•çš„ç½‘ç»œå›¾ç‰‡åŠ è½½å°±å°è£…å®Œæˆäº†ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰å¾ˆå¤šçš„ç¼ºé™·ï¼Œæ¯”å¦‚ç¼“å­˜åˆ°å†…å­˜çš„å›¾ç‰‡è¿‡å¤šã€åœ¨ TableView ä¸­ä½¿ç”¨ä¼šä¸ä¼šé€ æˆå¡é¡¿ç­‰ç­‰ï¼Œè¿™ç¯‡æ–‡ç« åªæ˜¯ä»‹ç»äº†ä¸€ä¸ªç®€å•çš„ç½‘ç»œå›¾ç‰‡ç¼“å­˜æ€è·¯ï¼Œç›´æ¥ç”¨åœ¨é¡¹ç›®ä¸­çš„è¯è¿˜éœ€è¦å¤§é‡çš„å®Œå–„</p>
</blockquote>
<p>è¿™ä¸ª demo è™½ç„¶å¾ˆç®€å•ï¼Œä¸Šé¢å†™çš„ä¹Ÿå¾ˆæ¸…æ¥šï¼Œä½†æ˜¯æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘è¿˜æ˜¯æŠŠGitHub åœ°å€é™„ä¸Š<br><a href="https://github.com/li1024316925/Webimage" target="_blank" rel="external">demoç‚¹è¿™é‡Œç‚¹è¿™é‡Œç‚¹è¿™é‡Œ</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS-Category/">iOS Category</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-çºµå‘æ¨ªå‘ç€‘å¸ƒæµ"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/01/16/çºµå‘æ¨ªå‘ç€‘å¸ƒæµ/">çºµå‘æ¨ªå‘ç€‘å¸ƒæµ</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/01/16/çºµå‘æ¨ªå‘ç€‘å¸ƒæµ/" class="article-date">
	  <time datetime="2017-01-16T10:12:34.000Z" itemprop="datePublished">2017-01-16</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç€‘å¸ƒæµçš„å®ç°åŸç†ï¼Œdemoä»¥åŸç†ä¸ºä¸»ï¼Œéšä¾¿å†™äº†å†™ï¼Œå°è£…æ€§ä¸å¥½ï¼Œå¦‚æœæ‹¿å»ç›´æ¥ç”¨éœ€è¦ä¿®æ”¹çš„åœ°æ–¹æ˜¯æ¯”è¾ƒå¤šçš„ã€‚æ‰€ä»¥æ­¤æ–‡ç« ä»…ä¾›å­¦ä¹ ï¼Œæƒ³ç›´æ¥ç”¨çš„å°ä¼™ä¼´éœ€è¦å¤šè´¹äº›åŠŸå¤«äº†ã€‚</p>
</blockquote>
<p>è¯ä¸å¤šè¯´ï¼Œå…ˆçœ‹çœ‹æ•ˆæœå›¾</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-7e63c180c88ffcc2.gif?imageMogr2/auto-orient/strip" alt="ç€‘å¸ƒæµ.gif"></p>
<h3 id="é¦–å…ˆä»‹ç»ä¸€ä¸‹ç”¨åˆ°çš„æ§ä»¶"><a href="#é¦–å…ˆä»‹ç»ä¸€ä¸‹ç”¨åˆ°çš„æ§ä»¶" class="headerlink" title="é¦–å…ˆä»‹ç»ä¸€ä¸‹ç”¨åˆ°çš„æ§ä»¶"></a>é¦–å…ˆä»‹ç»ä¸€ä¸‹ç”¨åˆ°çš„æ§ä»¶</h3><p>è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ <code>UICollectionView</code> å®ƒçš„ä¼˜ç‚¹å’±ä»¬ä¸å¤šè¯´ï¼Œæœ€å¤§çš„ä¼˜ç‚¹å•å…ƒæ ¼å¯å¤ç”¨ï¼Œå½“ç„¶ä½ éè¦ç”¨ <code>UIView</code> å¾ªç¯åˆ›å»ºé‚£æˆ‘ä¹Ÿæ²¡è¯è¯´ã€‚<br>è¦ç”¨ <code>UICollectionView</code> å®ç°ä¸€ä¸ªç€‘å¸ƒæµï¼Œåªç”¨ä»£ç†æ–¹æ³•æ˜¯ä¸å¯èƒ½çš„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ° <code>UICollectionView</code> çš„å¸ƒå±€ç±» <code>UICollectionViewFlowLayout</code>ã€‚<br>æˆ‘ä»¬è¦å»ç»§æ‰¿ <code>UICollectionViewFlowLayout</code> è‡ªå®šä¹‰ä¸€ä¸ªæ–°çš„å¸ƒå±€ç±»ï¼Œç€‘å¸ƒæµçš„å®ç°å°±æ˜¯ä¾é æˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€ç±»ã€‚</p>
<h3 id="å†æ¥çœ‹çœ‹è‡ªå®šä¹‰å¸ƒå±€ç±»ä¸­ç”¨åˆ°çš„æ–¹æ³•"><a href="#å†æ¥çœ‹çœ‹è‡ªå®šä¹‰å¸ƒå±€ç±»ä¸­ç”¨åˆ°çš„æ–¹æ³•" class="headerlink" title="å†æ¥çœ‹çœ‹è‡ªå®šä¹‰å¸ƒå±€ç±»ä¸­ç”¨åˆ°çš„æ–¹æ³•"></a>å†æ¥çœ‹çœ‹è‡ªå®šä¹‰å¸ƒå±€ç±»ä¸­ç”¨åˆ°çš„æ–¹æ³•</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å½“collectionViewçš„frameæœ‰æ–°æ”¹å˜(å‘ç”Ÿç§»åŠ¨)æ—¶è°ƒç”¨ï¼Œå…¶è‹¥è¿”å›YESåˆ™é‡æ–°å¸ƒå±€</span></div><div class="line">- (<span class="built_in">BOOL</span>)shouldInvalidateLayoutForBoundsChange:(<span class="built_in">CGRect</span>)newBounds&#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  å‡†å¤‡å¥½å¸ƒå±€æ—¶è°ƒç”¨</div><div class="line"> *  å¸ƒå±€å‡†å¤‡æ–¹æ³• å½“collectionViewçš„å¸ƒå±€å‘ç”Ÿå˜åŒ–æ—¶ ä¼šè¢«è°ƒç”¨</div><div class="line"> *  é€šå¸¸æ˜¯åšå¸ƒå±€çš„å‡†å¤‡å·¥ä½œ itemSize.....</div><div class="line"> *  UICollectionView çš„ contentSize æ˜¯æ ¹æ® itemSize åŠ¨æ€è®¡ç®—å‡ºæ¥çš„</div><div class="line">è°ƒç”¨é¡ºåº Â·Â·Â·Â· 1</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)prepareLayout&#123; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è¿”å›collectionViewè§†å›¾ä¸­æ‰€æœ‰è§†å›¾çš„å±æ€§(UICollectionViewLayoutAttributes)æ•°ç»„</span></div><div class="line">è°ƒç”¨é¡ºåº Â·Â·Â·Â· <span class="number">3</span>ï¼ˆæ¯ä¸ªåº”çš„itemå±æ€§æ–¹æ³•è°ƒç”¨å®Œåè¿˜ä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼‰</div><div class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect&#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è¿”å›indexPathå¯¹åº”itemçš„å±æ€§</span></div><div class="line">è°ƒç”¨é¡ºåº Â·Â·Â·Â· <span class="number">4</span></div><div class="line">- (<span class="built_in">UICollectionViewLayoutAttributes</span> *)layoutAttributesForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è®¾ç½®collectionViewçš„å¯æ˜¾ç¤ºèŒƒå›´</span></div><div class="line">è°ƒç”¨é¡ºåº Â·Â·Â·Â· <span class="number">2</span></div><div class="line">- (<span class="built_in">CGSize</span>)collectionViewContentSize&#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç€‘å¸ƒæµçš„åŸç†å°±æ˜¯æ‰‹åŠ¨è®¡ç®—æ¯ä¸ª item çš„ frame ç„¶åäº¤ç»™ collectionView å¸ƒå±€ç±»çš„å†…å®¹è§†å›¾ï¼ˆåŒ…æ‹¬å¤´å°¾è§†å›¾ã€æ¯ä¸ªå•å…ƒæ ¼ç­‰ï¼‰å±æ€§æ•°ç»„ã€‚</p>
<h3 id="å…ˆçœ‹æ¯”è¾ƒç®€å•çš„ï¼Œå‚ç›´ç€‘å¸ƒæµçš„å®ç°æ­¥éª¤"><a href="#å…ˆçœ‹æ¯”è¾ƒç®€å•çš„ï¼Œå‚ç›´ç€‘å¸ƒæµçš„å®ç°æ­¥éª¤" class="headerlink" title="å…ˆçœ‹æ¯”è¾ƒç®€å•çš„ï¼Œå‚ç›´ç€‘å¸ƒæµçš„å®ç°æ­¥éª¤"></a>å…ˆçœ‹æ¯”è¾ƒç®€å•çš„ï¼Œå‚ç›´ç€‘å¸ƒæµçš„å®ç°æ­¥éª¤</h3><h4 id="1-å¤å†™-prepareLayout-æ–¹æ³•ï¼Œå‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶çš„-collectionView-å°±åƒä¸€ä¸ªç©ºçš„-scrollView-æ‰€æœ‰çš„-item-éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨çš„ç¡®å®šä»–çš„-frame-å°±åƒä¸€ä¸ªç”»æ¿ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè§†å›¾éƒ½ç”»åœ¨è¿™ä¸ªç”»æ¿ä¸Šã€‚"><a href="#1-å¤å†™-prepareLayout-æ–¹æ³•ï¼Œå‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶çš„-collectionView-å°±åƒä¸€ä¸ªç©ºçš„-scrollView-æ‰€æœ‰çš„-item-éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨çš„ç¡®å®šä»–çš„-frame-å°±åƒä¸€ä¸ªç”»æ¿ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè§†å›¾éƒ½ç”»åœ¨è¿™ä¸ªç”»æ¿ä¸Šã€‚" class="headerlink" title="1.å¤å†™ prepareLayout æ–¹æ³•ï¼Œå‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶çš„ collectionView å°±åƒä¸€ä¸ªç©ºçš„ scrollView æ‰€æœ‰çš„ item éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨çš„ç¡®å®šä»–çš„ frame å°±åƒä¸€ä¸ªç”»æ¿ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè§†å›¾éƒ½ç”»åœ¨è¿™ä¸ªç”»æ¿ä¸Šã€‚"></a>1.å¤å†™ <code>prepareLayout</code> æ–¹æ³•ï¼Œå‡†å¤‡å·¥ä½œï¼Œæ­¤æ—¶çš„ collectionView å°±åƒä¸€ä¸ªç©ºçš„ scrollView æ‰€æœ‰çš„ item éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨çš„ç¡®å®šä»–çš„ frame å°±åƒä¸€ä¸ªç”»æ¿ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè§†å›¾éƒ½ç”»åœ¨è¿™ä¸ªç”»æ¿ä¸Šã€‚</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  å‡†å¤‡å¥½å¸ƒå±€æ—¶è°ƒç”¨</div><div class="line"> *  å¸ƒå±€å‡†å¤‡æ–¹æ³• å½“collectionViewçš„å¸ƒå±€å‘ç”Ÿå˜åŒ–æ—¶ ä¼šè¢«è°ƒç”¨</div><div class="line"> *  é€šå¸¸æ˜¯åšå¸ƒå±€çš„å‡†å¤‡å·¥ä½œ itemSize.....</div><div class="line"> *  UICollectionView çš„ contentSize æ˜¯æ ¹æ® itemSize åŠ¨æ€è®¡ç®—å‡ºæ¥çš„</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)prepareLayout&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//itemçš„æœ€å°é—´è·</span></div><div class="line">    <span class="built_in">CGFloat</span> space = <span class="keyword">self</span>.minimumInteritemSpacing;</div><div class="line">    <span class="built_in">CGFloat</span> contentSize = <span class="keyword">self</span>.collectionView.bounds.size.width - <span class="keyword">self</span>.sectionInset.left - <span class="keyword">self</span>.sectionInset.right;</div><div class="line">    <span class="comment">//æ¯ä¸ªå•å…ƒæ ¼çš„å®½åº¦</span></div><div class="line">    <span class="built_in">CGFloat</span> itemWidth = (contentSize - (space * (<span class="keyword">self</span>.lineNum<span class="number">-1</span>)))/<span class="keyword">self</span>.lineNum;</div><div class="line">    <span class="comment">//æ ¹æ®å®½åº¦è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼çš„å±æ€§</span></div><div class="line">    [<span class="keyword">self</span> computeAttributesWithItemWidth:itemWidth];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼çš„ attributes æ–¹æ³•ï¼Œæˆ‘ä»¬ä¿å­˜æ¯ä¸€åˆ—çš„æ€»é«˜åº¦ï¼Œåœ¨åˆ›å»ºæ¯ä¸ªå•å…ƒæ ¼çš„ attributes æ—¶æŒ‘é€‰æœ€çŸ­çš„é‚£ä¸€åˆ—ï¼ŒæŠŠå½“å‰å•å…ƒæ ¼æ·»åŠ åˆ°è¿™ä¸ªæœ€çŸ­åˆ—</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)computeAttributesWithItemWidth:(<span class="built_in">CGFloat</span>)width&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//å­˜å‚¨æ¯åˆ—ä¸ªæ•°å’Œæ¯åˆ—æ€»é«˜åº¦çš„æ•°ç»„</span></div><div class="line">    <span class="built_in">CGFloat</span> columnHeight[<span class="keyword">self</span>.lineNum];</div><div class="line">    <span class="built_in">CGFloat</span> columnNum[<span class="keyword">self</span>.lineNum];</div><div class="line">    <span class="comment">//åˆå§‹åŒ–æ•°ç»„</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">self</span>.lineNum; i ++) &#123;</div><div class="line">        columnNum[i] = <span class="number">0</span>;</div><div class="line">        <span class="comment">//sectionInset  UIEdgeInsetsç±»å‹  è¾¹è·</span></div><div class="line">        columnHeight[i] = <span class="keyword">self</span>.sectionInset.top;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//å¾ªç¯åˆ›å»ºæ¯ä¸ªå•å…ƒæ ¼çš„ attributes</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">self</span>.dataList.count; i ++) &#123;</div><div class="line">        <span class="keyword">int</span> index = [<span class="keyword">self</span> computerMinHeightWithArray:columnHeight];</div><div class="line">        <span class="built_in">UICollectionViewLayoutAttributes</span> *attributes = [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForCellWithIndexPath:[<span class="built_in">NSIndexPath</span> indexPathForItem:i inSection:<span class="number">0</span>]];</div><div class="line">        <span class="comment">//è®¡ç®—æ¯ä¸ªitemçš„ä½ç½®ï¼Œå¤§å°</span></div><div class="line">        <span class="built_in">CGFloat</span> itemX = index * (width+<span class="keyword">self</span>.minimumLineSpacing) + <span class="keyword">self</span>.sectionInset.left;</div><div class="line">        <span class="built_in">CGFloat</span> itemY = columnHeight[index];</div><div class="line">        <span class="built_in">CGFloat</span> itemHeight = [<span class="keyword">self</span> makeNum];</div><div class="line">        </div><div class="line">        attributes.frame = <span class="built_in">CGRectMake</span>(itemX, itemY, width, itemHeight);</div><div class="line">        </div><div class="line">        [<span class="keyword">self</span>.attributesArray addObject:attributes];</div><div class="line">        </div><div class="line">        columnHeight[index] += itemHeight+<span class="keyword">self</span>.minimumInteritemSpacing;</div><div class="line">        columnNum[index] ++;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//è®¡ç®—æœ€é«˜åˆ—</span></div><div class="line">    <span class="keyword">int</span> maxIndex = [<span class="keyword">self</span> computerMaxHeightWithArray:columnHeight];</div><div class="line">    _maxHeight = columnHeight[maxIndex];</div><div class="line">    <span class="comment">//è®¡ç®— item çš„å¤§å°å¹³å‡å€¼ï¼Œè¿™æ ·å¯ä»¥å¤§è‡´ç¡®å®š collectionView çš„å†…å®¹è§†å›¾å°ºå¯¸ï¼Œä½†ä¸æ˜¯å¤ªå‡†ç¡®</span></div><div class="line">    <span class="built_in">CGFloat</span> aveHeight = (columnHeight[maxIndex] - <span class="keyword">self</span>.sectionInset.top - columnNum[maxIndex]*<span class="keyword">self</span>.minimumLineSpacing)/columnNum[maxIndex];</div><div class="line">    <span class="keyword">self</span>.itemSize = <span class="built_in">CGSizeMake</span>(width, aveHeight);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-åœ¨-layoutAttributesForElementsInRect-æ–¹æ³•ä¸­-return-æ‰€æœ‰-item-çš„-attributes-æ•°ç»„"><a href="#2-åœ¨-layoutAttributesForElementsInRect-æ–¹æ³•ä¸­-return-æ‰€æœ‰-item-çš„-attributes-æ•°ç»„" class="headerlink" title="2.åœ¨ layoutAttributesForElementsInRect: æ–¹æ³•ä¸­ return æ‰€æœ‰ item çš„ attributes æ•°ç»„"></a>2.åœ¨ <code>layoutAttributesForElementsInRect:</code> æ–¹æ³•ä¸­ return æ‰€æœ‰ item çš„ attributes æ•°ç»„</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è¿”å›collectionViewè§†å›¾ä¸­æ‰€æœ‰è§†å›¾çš„å±æ€§(UICollectionViewLayoutAttributes)æ•°ç»„</span></div><div class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.attributesArray;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-å†™å®Œä¸Šä¸€æ­¥ï¼Œè¿™ä¸ªå‚ç›´ç€‘å¸ƒæµçš„å¸ƒå±€ç±»åŸºæœ¬å†™å®Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å†…å®¹å°ºå¯¸è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Œä¹‹å‰è¿™ä¸ªå†…å®¹å°ºå¯¸æ˜¯å¸ƒå±€ç±»æ ¹æ®è‡ªèº«çš„å±æ€§-itemSize-æ¥è®¡ç®—çš„ï¼Œè€Œ-itemSize-å–çš„æ˜¯å¹³å‡å€¼ï¼Œè¿™æ ·ç®—å‡ºçš„å†…å®¹å°ºå¯¸ä¼šæœ‰äº›åå·®ï¼Œæˆ‘ä»¬å†é‡å†™ä¸€ä¸‹-collectionViewContentSize-æ–¹æ³•"><a href="#3-å†™å®Œä¸Šä¸€æ­¥ï¼Œè¿™ä¸ªå‚ç›´ç€‘å¸ƒæµçš„å¸ƒå±€ç±»åŸºæœ¬å†™å®Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å†…å®¹å°ºå¯¸è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Œä¹‹å‰è¿™ä¸ªå†…å®¹å°ºå¯¸æ˜¯å¸ƒå±€ç±»æ ¹æ®è‡ªèº«çš„å±æ€§-itemSize-æ¥è®¡ç®—çš„ï¼Œè€Œ-itemSize-å–çš„æ˜¯å¹³å‡å€¼ï¼Œè¿™æ ·ç®—å‡ºçš„å†…å®¹å°ºå¯¸ä¼šæœ‰äº›åå·®ï¼Œæˆ‘ä»¬å†é‡å†™ä¸€ä¸‹-collectionViewContentSize-æ–¹æ³•" class="headerlink" title="3.å†™å®Œä¸Šä¸€æ­¥ï¼Œè¿™ä¸ªå‚ç›´ç€‘å¸ƒæµçš„å¸ƒå±€ç±»åŸºæœ¬å†™å®Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å†…å®¹å°ºå¯¸è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Œä¹‹å‰è¿™ä¸ªå†…å®¹å°ºå¯¸æ˜¯å¸ƒå±€ç±»æ ¹æ®è‡ªèº«çš„å±æ€§ itemSize æ¥è®¡ç®—çš„ï¼Œè€Œ itemSize å–çš„æ˜¯å¹³å‡å€¼ï¼Œè¿™æ ·ç®—å‡ºçš„å†…å®¹å°ºå¯¸ä¼šæœ‰äº›åå·®ï¼Œæˆ‘ä»¬å†é‡å†™ä¸€ä¸‹ collectionViewContentSize æ–¹æ³•"></a>3.å†™å®Œä¸Šä¸€æ­¥ï¼Œè¿™ä¸ªå‚ç›´ç€‘å¸ƒæµçš„å¸ƒå±€ç±»åŸºæœ¬å†™å®Œäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å†…å®¹å°ºå¯¸è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Œä¹‹å‰è¿™ä¸ªå†…å®¹å°ºå¯¸æ˜¯å¸ƒå±€ç±»æ ¹æ®è‡ªèº«çš„å±æ€§ itemSize æ¥è®¡ç®—çš„ï¼Œè€Œ itemSize å–çš„æ˜¯å¹³å‡å€¼ï¼Œè¿™æ ·ç®—å‡ºçš„å†…å®¹å°ºå¯¸ä¼šæœ‰äº›åå·®ï¼Œæˆ‘ä»¬å†é‡å†™ä¸€ä¸‹ <code>collectionViewContentSize</code> æ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å†…å®¹å°ºå¯¸</span></div><div class="line"><span class="comment">//å–æœ€é«˜åˆ—çš„é«˜åº¦ä½œä¸ºå†…å®¹å°ºå¯¸çš„é«˜åº¦</span></div><div class="line">- (<span class="built_in">CGSize</span>)collectionViewContentSize&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(<span class="keyword">self</span>.collectionView.bounds.size.width, _maxHeight);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å‚ç›´çš„å†™å®Œäº†ï¼Œå†æ¥çœ‹çœ‹æ°´å¹³çš„æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#å‚ç›´çš„å†™å®Œäº†ï¼Œå†æ¥çœ‹çœ‹æ°´å¹³çš„æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="å‚ç›´çš„å†™å®Œäº†ï¼Œå†æ¥çœ‹çœ‹æ°´å¹³çš„æ˜¯æ€ä¹ˆå®ç°çš„"></a>å‚ç›´çš„å†™å®Œäº†ï¼Œå†æ¥çœ‹çœ‹æ°´å¹³çš„æ˜¯æ€ä¹ˆå®ç°çš„</h3><h4 id="1-åŒæ ·çš„é¦–å…ˆå»å¤å†™-prepareLayout-æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•é‡Œé¢è®¡ç®—æ¯ä¸ª-item-çš„-attributes"><a href="#1-åŒæ ·çš„é¦–å…ˆå»å¤å†™-prepareLayout-æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•é‡Œé¢è®¡ç®—æ¯ä¸ª-item-çš„-attributes" class="headerlink" title="1.åŒæ ·çš„é¦–å…ˆå»å¤å†™ prepareLayout æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•é‡Œé¢è®¡ç®—æ¯ä¸ª item çš„ attributes"></a>1.åŒæ ·çš„é¦–å…ˆå»å¤å†™ <code>prepareLayout</code> æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•é‡Œé¢è®¡ç®—æ¯ä¸ª item çš„ attributes</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)prepareLayout&#123;</div><div class="line">    [<span class="keyword">self</span> computeAttributes];</div><div class="line">&#125;</div><div class="line"><span class="comment">//è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼çš„å±æ€§</span></div><div class="line">- (<span class="keyword">void</span>)computeAttributes&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//å­˜è´®æ¯è¡Œä¸ªæ•°</span></div><div class="line">    <span class="built_in">NSMutableArray</span> *lineNum = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    [lineNum insertObject:@<span class="number">0</span> atIndex:<span class="number">0</span>];</div><div class="line">    <span class="comment">//å‚¨å­˜æ¯è¡Œå®½åº¦</span></div><div class="line">    <span class="built_in">NSMutableArray</span> *lineWidth = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    [lineWidth insertObject:@<span class="number">10.0</span> atIndex:<span class="number">0</span>];</div><div class="line">    <span class="comment">//è®°å½•å½“å‰é«˜åº¦</span></div><div class="line">    <span class="built_in">CGFloat</span> verticalHeight = <span class="number">10</span>;</div><div class="line">    <span class="comment">//å½“å‰æ·»åŠ çš„è¡Œå·</span></div><div class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="keyword">self</span>.dataList.count; k ++) &#123;</div><div class="line">        <span class="built_in">NSArray</span> *array = <span class="keyword">self</span>.dataList[k];</div><div class="line">        </div><div class="line">        <span class="comment">//æ·»åŠ ä¸€ä¸ªç»„å¤´</span></div><div class="line">        <span class="built_in">UICollectionViewLayoutAttributes</span> *headerAttributes = [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForSupplementaryViewOfKind:<span class="built_in">UICollectionElementKindSectionHeader</span> withIndexPath:[<span class="built_in">NSIndexPath</span> indexPathForItem:<span class="number">0</span> inSection:k]];</div><div class="line">        headerAttributes.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, verticalHeight + k*<span class="number">50</span>, kScreenWidth, <span class="number">50</span>);</div><div class="line">        [<span class="keyword">self</span>.attributesArray addObject:headerAttributes];</div><div class="line">        <span class="comment">//ç›¸å½“äºæ·»åŠ äº†ä¸€è¡Œ</span></div><div class="line">        [lineNum addObject:@<span class="number">1</span>];</div><div class="line">        [lineWidth addObject:@(kScreenWidth)];</div><div class="line">        <span class="comment">//æ·»åŠ ç»„å¤´ï¼Œä¸éœ€è¦è®¡ç®—ç»„å¤´çš„é«˜åº¦ï¼Œå•å…ƒæ ¼ä¼šè‡ªåŠ¨é€‚é…åˆ°ç»„å¤´ä¸‹é¢</span></div><div class="line">        verticalHeight += <span class="number">10</span>;</div><div class="line">        index ++;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.count; i ++) &#123;</div><div class="line">            <span class="built_in">UICollectionViewLayoutAttributes</span> *attributes = [<span class="built_in">UICollectionViewLayoutAttributes</span> layoutAttributesForCellWithIndexPath:[<span class="built_in">NSIndexPath</span> indexPathForItem:i inSection:k]];</div><div class="line">            <span class="comment">//è®¡ç®—å®½åº¦</span></div><div class="line">            <span class="built_in">CGFloat</span> width = [<span class="keyword">self</span> computerWidthWithString:array[i]];</div><div class="line">            <span class="comment">//è®¡ç®—ä½ç½®</span></div><div class="line">            <span class="built_in">CGFloat</span> X;</div><div class="line">            <span class="built_in">CGFloat</span> Y;</div><div class="line">            <span class="built_in">CGFloat</span> indexWidth = [lineWidth[index] floatValue];  <span class="comment">//å½“å‰è¡Œå®½</span></div><div class="line">            <span class="keyword">if</span> ((indexWidth+width+<span class="number">10</span>) &lt;= <span class="keyword">self</span>.collectionView.bounds.size.width) &#123;</div><div class="line">                <span class="comment">//å¦‚æœæ·»åŠ ä¸€ä¸ªå•å…ƒæ ¼ï¼Œæ­¤è¡Œå®½åº¦è¿˜å°äºæ§ä»¶å®½åº¦ï¼Œé‚£å°±æ·»åŠ åˆ°æ­¤è¡Œ</span></div><div class="line">                X = [lineWidth[index] floatValue];</div><div class="line">                Y = verticalHeight;</div><div class="line">                lineNum[index] = @([lineNum[index] intValue]+<span class="number">1</span>);</div><div class="line">                lineWidth[index] = @([lineWidth[index] floatValue]+width+<span class="number">10</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                <span class="comment">//å¦‚æœæ·»åŠ ä¸€ä¸ªå•å…ƒæ ¼ï¼Œæ­¤è¡Œå®½åº¦å¤§äºæ§ä»¶å®½åº¦ï¼Œé‚£å°±å¦èµ·ä¸€è¡Œ</span></div><div class="line">                index++;</div><div class="line">                verticalHeight += <span class="number">50</span>;</div><div class="line">                Y = verticalHeight;</div><div class="line">                X = <span class="number">10.0</span>;</div><div class="line">                [lineNum addObject:@(<span class="number">1</span>)];</div><div class="line">                [lineWidth addObject:@(width+<span class="number">10</span>+<span class="number">10</span>)];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            attributes.frame = <span class="built_in">CGRectMake</span>(X, Y, width, <span class="number">40</span>);</div><div class="line">            [<span class="keyword">self</span>.attributesArray addObject:attributes];</div><div class="line">            </div><div class="line">            <span class="comment">//è®¾ç½®å¹³å‡itemå±æ€§</span></div><div class="line">            <span class="keyword">int</span> maxIndex = [<span class="keyword">self</span> computerMAXlineWithArray:lineWidth];</div><div class="line">            <span class="built_in">CGFloat</span> aveWidth = ([lineWidth[maxIndex] floatValue]-[lineNum[maxIndex] intValue]*<span class="number">10</span><span class="number">-10</span>)/[lineNum[maxIndex] intValue];</div><div class="line">            <span class="keyword">self</span>.itemSize = <span class="built_in">CGSizeMake</span>(aveWidth, <span class="number">40</span>);</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œç€é‡ä»‹ç»è¿™ä¸ªè®¡ç®—æ–¹æ³•<br>è·Ÿå‚ç›´ç€‘å¸ƒæµä¸åŒçš„æ˜¯ï¼Œæ°´å¹³ç€‘å¸ƒæµçš„è®¡ç®—æ–¹æ³•æ˜¯ä¸æ–­çš„å°† item å¾€ä¸€è¡Œä¸­æ”¾ï¼Œç›´åˆ°è¿™ä¸€è¡Œçš„å®½åº¦ + æ–° item çš„å®½åº¦å·²ç»è¶…å‡ºäº†æ§ä»¶ï¼ˆcollectionViewï¼‰çš„å®½åº¦ï¼Œé‚£æˆ‘ä»¬å°±å¦èµ·ä¸€è¡Œã€‚è¿˜è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªæ°´å¹³ç€‘å¸ƒæµä¸­æ·»åŠ äº†å¤´è§†å›¾ã€‚<br>å¤´è§†å›¾çš„ attributes ä¹Ÿæ˜¯è¦æ·»åŠ å…¥ collectionView çš„ attributes æ•°ç»„ä¸­çš„ï¼Œè¿™ä¸ªå¤´è§†å›¾çš„ä½ç½®æˆ‘ç›´æ¥å½“åšå¦èµ·äº†ä¸€è¡Œï¼Œä½†æ˜¯å®ƒçš„ç±»å‹æœ‰æ‰€ä¸åŒï¼Œå®ƒçš„ç±»å‹æ˜¯ä¸€ä¸ª <code>UICollectionElementKindSectionHeader</code> ã€‚è¿™ä¸ªåœ°æ–¹æœ‰ä¸€ä¸ªå‘ï¼Œæˆ‘è°ƒè¯•äº†å¥½ä¹…æ‰è°ƒè¯•å¥½ï¼Œå•å…ƒæ ¼çš„ä½ç½®æ˜¯ç›¸å¯¹äºè¿™ä¸ªå¤´è§†å›¾æ¥å®šä½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬è®¡ç®—å…¶ä»– item çš„ä½ç½®æ—¶åŠ ä¸Šäº†è¿™ä¸ªå¤´è§†å›¾çš„é«˜åº¦ï¼Œé‚£ä¹ˆå®é™…æ•ˆæœå°±æ˜¯è¿™ä¸ª item ä¸å¤´è§†å›¾ä¹‹é—´ä¼šå¤šå‡ºä¸€ä¸ªå¤´è§†å›¾çš„è·ç¦»ã€‚</p>
<h4 id="2-æœ€åè¿˜æ˜¯è¿”å›å®ƒçš„-attributes-æ•°ç»„"><a href="#2-æœ€åè¿˜æ˜¯è¿”å›å®ƒçš„-attributes-æ•°ç»„" class="headerlink" title="2.æœ€åè¿˜æ˜¯è¿”å›å®ƒçš„ attributes æ•°ç»„"></a>2.æœ€åè¿˜æ˜¯è¿”å›å®ƒçš„ attributes æ•°ç»„</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è¿”å›å±æ€§æ•°ç»„</span></div><div class="line">- (<span class="built_in">NSArray</span>&lt;<span class="built_in">UICollectionViewLayoutAttributes</span> *&gt; *)layoutAttributesForElementsInRect:(<span class="built_in">CGRect</span>)rect&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.attributesArray;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åä¾æ—§æ”¾ä¸Šæˆ‘ä»¬å¯çˆ±çš„ demo</p>
<p><a href="https://github.com/li1024316925/Waterfall" target="_blank" rel="external">demo ç‚¹è¿™é‡Œï¼ç‚¹è¿™é‡Œï¼</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-é‡å†™-View-çš„-Touch-æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªé…·ç‚«çš„ä¹å®«æ ¼å›¾ç‰‡"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/12/23/é‡å†™-View-çš„-Touch-æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªé…·ç‚«çš„ä¹å®«æ ¼å›¾ç‰‡/">é‡å†™ View çš„ Touch æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªé…·ç‚«çš„ä¹å®«æ ¼å›¾ç‰‡</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/12/23/é‡å†™-View-çš„-Touch-æ–¹æ³•ï¼Œå®ç°ä¸€ä¸ªé…·ç‚«çš„ä¹å®«æ ¼å›¾ç‰‡/" class="article-date">
	  <time datetime="2016-12-23T03:30:21.000Z" itemprop="datePublished">2016-12-23</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>å‰å‡ å¤©ç¿»çœ‹ä»£ç åº“ï¼Œå‘ç°ä¸€ä¸ªä¹‹å‰å†™è¿‡çš„ä¸€ä¸ªæœ‰æ„æ€çš„å°ç©æ„ï¼Œå…±äº«ç»™å¤§å®¶ğŸ˜„</strong></p>
<p><strong>åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šå›¾ï¼Œå…ˆçœ‹çœ‹æ•ˆæœ</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-f29e68c106c78c5f.gif?imageMogr2/auto-orient/strip" alt="photosView.gif"></p>
<p>æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯è¿˜è›®æœ‰æ„æ€å‘¢ï¼Ÿ</p>
<p>å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦é‡å†™å‡ ä¸ª View çš„ touch æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è§¦æ‘¸å¼€å§‹</span></div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è·å–è§¦æ‘¸ç‚¹</span></div><div class="line">Â  Â  <span class="built_in">UITouch</span> *touch = [touches anyObject];</div><div class="line">Â  Â  <span class="built_in">CGPoint</span> point = [touch locationInView:<span class="keyword">self</span>];</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å½“å‰ç‚¹å‡»åˆ°çš„å›¾ç‰‡çš„ä¸‹æ ‡å°äºå›¾ç‰‡æ•°ç»„çš„å…ƒç´ ä¸ªæ•°</span></div><div class="line">Â  Â  _selectIndex = [<span class="keyword">self</span> itemIndexWithPoint:point];</div><div class="line">Â  Â  <span class="keyword">if</span> (_selectIndex &lt; <span class="keyword">self</span>.itemArray.count) &#123;</div><div class="line">Â  Â  Â  Â  <span class="built_in">UIImageView</span> *item = <span class="keyword">self</span>.itemArray[_selectIndex];</div><div class="line">Â  Â  Â  Â  <span class="comment">//æ‹¿åˆ°æœ€ä¸Šå±‚</span></div><div class="line">Â  Â  Â  Â  [<span class="keyword">self</span> bringSubviewToFront:item];</div><div class="line">Â  Â  Â  Â  <span class="comment">//åŠ¨ç”»æ•ˆæœ</span></div><div class="line">Â  Â  Â  Â  [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> animations:^&#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//æ”¹å˜å½“å‰é€‰ä¸­å›¾ç‰‡è§†å›¾çš„å¤§å°å’Œä½ç½®</span></div><div class="line">Â  Â  Â  Â  Â  Â  item.center = point;</div><div class="line">Â  Â  Â  Â  Â  Â  item.transform = <span class="built_in">CGAffineTransformMakeScale</span>(<span class="number">1.2</span>, <span class="number">1.2</span>);</div><div class="line">Â  Â  Â  Â  Â  Â  item.alpha = <span class="number">0.8</span>;</div><div class="line">Â  Â  Â  Â  &#125;];</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è§¦æ‘¸ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆåˆ¤å®šå½“å‰è§¦æ‘¸çš„ç‚¹æ˜¯åœ¨å“ªä¸€å¼ å›¾ç‰‡ä¸Šï¼Œè·å¾—è¿™å¼ å›¾ç‰‡çš„ä¸‹æ ‡ï¼Œå¹¶è®¾ç½®ä¸ºé€‰ä¸­ä¸‹æ ‡ï¼Œç„¶åæ”¹å˜å½“å‰å›¾ç‰‡çš„ä½ç½®ï¼ˆä¸­å¿ƒç§»åŠ¨åˆ°è§¦æ‘¸ç‚¹ï¼‰å’Œå¤§å°ï¼ˆæ”¾å¤§æ•ˆæœï¼‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è§¦æ‘¸ç§»åŠ¨</span></div><div class="line">- (<span class="keyword">void</span>)touchesMoved:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è·å–è§¦æ‘¸ç‚¹</span></div><div class="line">Â  Â  <span class="built_in">UITouch</span> *touch = [touches anyObject];</div><div class="line">Â  Â  <span class="built_in">CGPoint</span> point = [touch locationInView:<span class="keyword">self</span>];</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è·å–å½“å‰è§¦æ‘¸ç‚¹ä½ç½®ä¸‹æ ‡</span></div><div class="line">Â  Â  <span class="built_in">NSInteger</span> index = [<span class="keyword">self</span> itemIndexWithPoint:point];</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">if</span> (_selectIndex &lt; <span class="keyword">self</span>.itemArray.count) &#123;</div><div class="line">Â  Â  Â  Â  <span class="built_in">UIImageView</span> *item = <span class="keyword">self</span>.itemArray[_selectIndex];</div><div class="line">Â  Â  Â  Â  item.center = point;</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (index &lt; <span class="keyword">self</span>.itemArray.count &amp;&amp; index != _selectIndex) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å½“å‰ç‚¹ä½ç½®æ‰€å±ä¸‹æ ‡ä¸é€‰ä¸­ä¸‹æ ‡ä¸åŒ</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//å°†ä¸¤ä¸ªå›¾ç‰‡åˆ†åˆ«åœ¨æ•°æ®æºæ•°ç»„å’Œå­è§†å›¾æ•°ç»„ä¸­ç§»é™¤</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">UIImage</span> *image = _dataList[_selectIndex];</div><div class="line">Â  Â  Â  Â  Â  Â  [_dataList removeObjectAtIndex:_selectIndex];</div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span>.itemArray removeObjectAtIndex:_selectIndex];</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//é‡æ–°æ’å…¥åˆ°æŒ‡å®šä½ç½®</span></div><div class="line">Â  Â  Â  Â  Â  Â  [_dataList insertObject:image atIndex:index];</div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span>.itemArray insertObject:item atIndex:index];</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//é‡æ–°è®°å½•é€‰ä¸­ä¸‹æ ‡</span></div><div class="line">Â  Â  Â  Â  Â  Â  _selectIndex = index;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//é‡æ–°å¸ƒå±€</span></div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span> restartMakeItemFram];</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨è§¦æ‘¸ç§»åŠ¨æ–¹æ³•ä¸­å†æ¬¡åˆ¤å®šå½“å‰è§¦æ‘¸ç‚¹æ‰€åœ¨çš„å›¾ç‰‡ä¸‹æ ‡ï¼Œç„¶åæ¯”è¾ƒé€‰ä¸­ä¸‹æ ‡ä¸å½“å‰ä¸‹æ ‡ï¼Œå¦‚æœä¸ç›¸åŒï¼Œå°±äº¤æ¢ä¸¤å¼ å›¾ç‰‡çš„ä½ç½®ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è§¦æ‘¸ç»“æŸ</span></div><div class="line">- (<span class="keyword">void</span>)touchesEnded:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">if</span> (_selectIndex &lt; _itemArray.count) &#123;</div><div class="line">Â  Â  Â  Â  <span class="built_in">UIImageView</span> *item = _itemArray[_selectIndex];</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//è¿˜åŸæ“ä½œ</span></div><div class="line">Â  Â  Â  Â  [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> animations:^&#123;</div><div class="line">Â  Â  Â  Â  Â  Â  item.transform = <span class="built_in">CGAffineTransformIdentity</span>;</div><div class="line">Â  Â  Â  Â  Â  Â  item.alpha = <span class="number">1</span>;</div><div class="line">Â  Â  Â  Â  Â  Â  item.frame = [<span class="keyword">self</span> makeFrameWithIndex:(<span class="keyword">int</span>)_selectIndex];</div><div class="line">Â  Â  Â  Â  &#125;];</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åï¼Œåœ¨è§¦æ‘¸ç»“æŸæ–¹æ³•ä¸­è¿˜åŸé€‰ä¸­å›¾ç‰‡çš„å¤§å°ï¼Œé‡æ–°è®¡ç®—å®ƒçš„ä½ç½®</p>
<p>æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿä¸‹é¢é™„ä¸Š Demo çš„åœ°å€<br><a href="https://github.com/li1024316925/PhotosView" target="_blank" rel="external">Demoç‚¹è¿™é‡Œ~ç‚¹è¿™é‡Œ~</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-FFmpeg è§£ç æœ¬åœ° H-264"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/12/15/FFmpeg è§£ç æœ¬åœ° H-264/">FFmpeg è§£ç æœ¬åœ° H.264</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/12/15/FFmpeg è§£ç æœ¬åœ° H-264/" class="article-date">
	  <time datetime="2016-12-15T09:28:46.000Z" itemprop="datePublished">2016-12-15</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>æœ€è¿‘å­¦ä¹  FFmpegï¼Œè‡ªå·±å†™äº†ä¸€ä¸ªå° Demo è§£ç ä¸€ä¸ª H.264 è£¸æµæ•°æ®<br>FFmpeg çš„ç¼–è¯‘å¯¼å…¥ç­‰å·¥ä½œæˆ‘ä»¬ä¸å†èµ˜è¿°ï¼Œä¸‹é¢ç›´æ¥è¿›å…¥æ­£é¢˜</p>
</blockquote>
<p>å¯¼å…¥åº“æ–‡ä»¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#include <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></div><div class="line"><span class="meta">#include <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></div><div class="line"><span class="meta">#include <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></div></pre></td></tr></table></figure>
<p>å£°æ˜ä¸€äº›æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„å…¨å±€å˜é‡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LLQH264Decoder</span>()&lt;<span class="title">UIAlertViewDelegate</span>&gt;</span></div><div class="line">&#123;</div><div class="line">Â  Â  <span class="built_in">AVFormatContext</span> *pFormatCtx;  <span class="comment">//è§£ç ä¸Šä¸‹æ–‡ï¼Œè´¯ç©¿æ•´ä¸ªè§£ç è¿‡ç¨‹</span></div><div class="line">Â  Â  <span class="keyword">int</span> i,videoIndex;</div><div class="line">Â  Â  <span class="built_in">AVCodecContext</span> *pCodecCtx;  <span class="comment">//è§£ç å™¨ä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨è§£ç å™¨ã€è§£ç ä¿¡æ¯ç­‰</span></div><div class="line">Â  Â  <span class="built_in">AVCodec</span> *pCodec;  <span class="comment">//è§£ç å™¨</span></div><div class="line">Â  Â  <span class="built_in">AVFrame</span> *pFrame, *pFrameYUV;  <span class="comment">//å­˜å‚¨æ¯ä¸€å¸§çš„åŸå§‹æ•°æ®</span></div><div class="line">Â  Â  uint8_t *out_Buffer;</div><div class="line">Â  Â  <span class="built_in">AVPacket</span> *packet;  <span class="comment">//å­˜å‚¨æ¯ä¸€å¸§çš„è§£ç åæ•°æ®</span></div><div class="line">Â  Â  <span class="keyword">int</span> ret,got_picture;</div><div class="line">Â  Â  <span class="keyword">struct</span> SwsContext *img_convert_ctx;</div><div class="line">Â  Â  <span class="keyword">int</span> frame_cnt;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‡†å¤‡å·¥ä½œå·²ç»åšå®Œäº†ï¼Œä¸‹é¢å¼€å§‹é‡ç‚¹</p>
<h1 id="è§£ç éƒ¨åˆ†"><a href="#è§£ç éƒ¨åˆ†" class="headerlink" title="è§£ç éƒ¨åˆ†"></a>è§£ç éƒ¨åˆ†</h1><p>æˆ‘ä»¬é€šè¿‡ä¼ å…¥ä¸€ä¸ª H.264 æ–‡ä»¶çš„è·¯å¾„ï¼Œæ¥è¯»å–è¿™ä¸ªæ–‡ä»¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setupFFMPEGwithPath:(<span class="built_in">NSString</span> *)path&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ³¨å†Œç¼–è§£ç å™¨</span></div><div class="line">Â  Â  av_register_all();</div><div class="line">Â  Â  <span class="comment">//</span></div><div class="line">Â  Â  avformat_network_init();</div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ– è´¯ç©¿æ•´ä¸ªè§£ç çš„è§£ç ä¸Šä¸‹æ–‡</span></div><div class="line">Â  Â  pFormatCtx = avformat_alloc_context();</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ‰“å¼€æ–‡ä»¶Â  è¿”å›0è¡¨ç¤ºæˆåŠŸï¼Œæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨formatCtxä¸­</span></div><div class="line">Â  Â  <span class="keyword">if</span> (avformat_open_input(&amp;pFormatCtx, path.UTF8String, <span class="literal">NULL</span>, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"ä¸èƒ½æ‰“å¼€æµæ–‡ä»¶"</span>];</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è¯»å–æ•°æ®åŒ…è·å–æµåª’ä½“æ–‡ä»¶çš„ä¿¡æ¯</span></div><div class="line">Â  Â  <span class="keyword">if</span> (avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"ä¸èƒ½è¯»å–åˆ°æµä¿¡æ¯"</span>];</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  videoIndex = <span class="number">-1</span>;</div><div class="line">Â  Â  <span class="comment">//æŸ¥æ‰¾è§†é¢‘æµ</span></div><div class="line">Â  Â  <span class="comment">//nb_streamsè§†éŸ³é¢‘æµçš„ä¸ªæ•°</span></div><div class="line">Â  Â  <span class="comment">//streamsè§†éŸ³é¢‘æµ</span></div><div class="line">Â  Â  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pFormatCtx-&gt;nb_streams; i ++) &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//ç›´è‡³æŸ¥æ‰¾åˆ°è§†é¢‘æµ</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type == <span class="built_in">AVMEDIA_TYPE_VIDEO</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  videoIndex = i;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">NSLog</span>(<span class="string">@"videoIndex==%d"</span>,videoIndex);Â  <span class="comment">//è§†é¢‘æµçš„ä¸‹æ ‡</span></div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">break</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> (videoIndex == <span class="number">-1</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"æ²¡æœ‰è§†é¢‘æµ"</span>];</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å–å‡ºæŸ¥æ‰¾åˆ°çš„è§†é¢‘æµçš„è§£ç å™¨ä¿¡æ¯</span></div><div class="line">Â  Â  pCodecCtx = pFormatCtx-&gt;streams[videoIndex]-&gt;codec;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ–è§£ç å™¨</span></div><div class="line">Â  Â  pCodec = avcodec_find_decoder(pCodecCtx-&gt;codec_id);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">if</span> (pCodec == <span class="literal">NULL</span>) &#123;</div><div class="line">Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"æ‰¾ä¸åˆ°è§£ç å™¨"</span>];</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ‰“å¼€è§£ç å™¨</span></div><div class="line">Â  Â  <span class="keyword">if</span> (avcodec_open2(pCodecCtx, pCodec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"ä¸èƒ½æ‰“å¼€è§£ç å™¨"</span>];</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ–frameï¼Œpacket</span></div><div class="line">Â  Â  <span class="comment">//AVPacketé‡Œé¢çš„æ˜¯H.264ç æµæ•°æ®</span></div><div class="line">Â  Â  <span class="comment">//AVFrameé‡Œé¢è£…çš„æ˜¯YUVæ•°æ®ã€‚YUVæ˜¯ç»è¿‡decoderè§£ç AVPacketçš„æ•°æ®</span></div><div class="line">Â  Â  pFrame = av_frame_alloc();</div><div class="line">Â  Â  packet = (<span class="built_in">AVPacket</span> *)malloc(<span class="keyword">sizeof</span>(<span class="built_in">AVPacket</span>));</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ‰“å°ä¸€å¤§å †æ—¶é—´ã€æ¯”ç‰¹ç‡ã€æµã€å®¹å™¨ã€ç¼–è§£ç å™¨å’Œæ—¶é—´ç­‰</span></div><div class="line">Â  Â  av_dump_format(pFormatCtx, <span class="number">0</span>, path.UTF8String, <span class="number">0</span>);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//ä¸ºè§£ç ä¸ºimageåšå‡†å¤‡</span></div><div class="line">Â  Â  img_convert_ctx = sws_getContext(pCodecCtx-&gt;width, pCodecCtx-&gt;height, pCodecCtx-&gt;pix_fmt, pCodecCtx-&gt;width, pCodecCtx-&gt;height, PIX_FMT_YUV420P, SWS_BICUBIC, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">Â  Â  frame_cnt = <span class="number">0</span>;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//å¼€è¾Ÿçº¿ç¨‹æ“ä½œ</span></div><div class="line">Â  Â  <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//ä»formatCtxä¸­è¯»å–ï¼Œä¸€å¸§ä¸€å¸§çš„è¯»å–ï¼Œå¾ªç¯ä¸€æ¬¡ï¼Œå°±è¯»å–ä¸€å¸§</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">while</span> (av_read_frame(pFormatCtx, packet) &gt;= <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="built_in">NSLog</span>(<span class="string">@"packet-&gt;data==%d"</span>,packet-&gt;size);</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (packet-&gt;stream_index == videoIndex) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//æ ¹æ®è·å–åˆ°çš„packetç”ŸæˆpFrame(AVFrame)å®é™…ä¸Šå°±æ˜¯è§£ç </span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//å¦‚æœæ²¡æœ‰éœ€è¦è§£ç çš„å¸§åˆ™got_pictureå°±ä¼šä¸º0</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  ret = avcodec_decode_video2(pCodecCtx, pFrame, &amp;got_picture, packet);</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span> showAlerViewTitle:<span class="string">@"è§£ç é”™è¯¯"</span>];</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">return</span>;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span> (got_picture) &#123;</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div><div class="line">                    <span class="comment">//è¿™é‡Œæ˜¯æ’­æ”¾éƒ¨åˆ†ï¼Œæœ‰ä¸¤ç§æ’­æ”¾æ–¹å¼ï¼Œç”¨ OpenGL æ’­æ”¾</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//OpenGL GPUæ¸²æŸ“</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span> makeYUVframe];</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//imageViewæ’­æ”¾ï¼Œæˆ‘ä»¬å°†è§£ç è·å¾—çš„ YUV æ•°æ®è§£ç ä¸º imageï¼Œç„¶åäº¤ç»™ imageview</span></div><div class="line"><span class="comment">//Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [self makeImage];</span></div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  av_free_packet(packet);</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">        <span class="comment">//æœ€åé‡Šæ”¾æˆ‘ä»¬ç”¨åˆ°çš„ç»“æ„ä½“</span></div><div class="line">Â  Â  Â  Â  sws_freeContext(img_convert_ctx);</div><div class="line">Â  Â  Â  Â  av_frame_free(&amp;pFrameYUV);</div><div class="line">Â  Â  Â  Â  av_frame_free(&amp;pFrame);</div><div class="line">Â  Â  Â  Â  avcodec_close(pCodecCtx);</div><div class="line">Â  Â  Â  Â  avformat_close_input(&amp;pFormatCtx);</div><div class="line">Â  Â  Â  Â  [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:decodeDidFinishNotification object:<span class="literal">nil</span>];</div><div class="line">Â  Â  &#125;);</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="æ’­æ”¾éƒ¨åˆ†"><a href="#æ’­æ”¾éƒ¨åˆ†" class="headerlink" title="æ’­æ”¾éƒ¨åˆ†"></a>æ’­æ”¾éƒ¨åˆ†</h1><h2 id="OpenGLæ’­æ”¾"><a href="#OpenGLæ’­æ”¾" class="headerlink" title="OpenGLæ’­æ”¾"></a>OpenGLæ’­æ”¾</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//YUVè½¬RGB</span></div><div class="line">- (<span class="keyword">void</span>)makeYUVframe&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">unsigned</span> <span class="keyword">int</span> lumaLength = (pCodecCtx-&gt;height)*(MIN(pFrame-&gt;linesize[<span class="number">0</span>], pCodecCtx-&gt;width));</div><div class="line">Â  Â  <span class="keyword">unsigned</span> <span class="keyword">int</span> chromBLength = ((pCodecCtx-&gt;height)/<span class="number">2</span>)*(MIN(pFrame-&gt;linesize[<span class="number">1</span>], (pCodecCtx-&gt;width)/<span class="number">2</span>));</div><div class="line">Â  Â  <span class="keyword">unsigned</span> <span class="keyword">int</span> chromRLength = ((pCodecCtx-&gt;height)/<span class="number">2</span>)*(MIN(pFrame-&gt;linesize[<span class="number">1</span>], (pCodecCtx-&gt;width)/<span class="number">2</span>));</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//åˆå§‹åŒ–</span></div><div class="line">Â  Â  H264YUV_Frame yuvFrame;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æ­¤å‡½æ•°çš„æ„æ€æ˜¯å°† sizeof(H264YUV_Frame) å¤§å°çš„ 0 æ•°æ®ï¼Œæ‹·è´åˆ°è¿™ä¸ªåœ°å€&amp;yuvFrame å®é™…ä¸Šå°±æ˜¯åˆå§‹åŒ–</span></div><div class="line">Â  Â  memset(&amp;yuvFrame, <span class="number">0</span>, <span class="keyword">sizeof</span>(H264YUV_Frame));</div><div class="line">Â Â  Â </div><div class="line">Â  Â  yuvFrame.luma.length = lumaLength;</div><div class="line">Â  Â  yuvFrame.chromaB.length = chromBLength;</div><div class="line">Â  Â  yuvFrame.chromaR.length = chromRLength;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  yuvFrame.luma.dataBuffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)malloc(lumaLength);</div><div class="line">Â  Â  yuvFrame.chromaB.dataBuffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)malloc(chromBLength);</div><div class="line">Â  Â  yuvFrame.chromaR.dataBuffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)malloc(chromRLength);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è½¬RGB</span></div><div class="line">Â  Â  copyDecodedFrame(pFrame-&gt;data[<span class="number">0</span>], yuvFrame.luma.dataBuffer, pFrame-&gt;linesize[<span class="number">0</span>], pCodecCtx-&gt;width, pCodecCtx-&gt;height);</div><div class="line">Â  Â  copyDecodedFrame(pFrame-&gt;data[<span class="number">1</span>], yuvFrame.chromaB.dataBuffer, pFrame-&gt;linesize[<span class="number">1</span>], pCodecCtx-&gt;width/<span class="number">2</span>, pCodecCtx-&gt;height/<span class="number">2</span>);</div><div class="line">Â  Â  copyDecodedFrame(pFrame-&gt;data[<span class="number">2</span>], yuvFrame.chromaR.dataBuffer, pFrame-&gt;linesize[<span class="number">2</span>], pCodecCtx-&gt;width/<span class="number">2</span>, pCodecCtx-&gt;height/<span class="number">2</span>);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  yuvFrame.width = pCodecCtx-&gt;width;</div><div class="line">Â  Â  yuvFrame.height = pCodecCtx-&gt;height;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//åœ¨ä¸»çº¿ç¨‹ä¸­æŠŠè·å¾—åˆ°çš„ RGB æ›´æ–°å‡ºå»ï¼Œè¿™é‡Œé€šè¿‡ä»£ç†</span></div><div class="line">Â  Â  <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span>([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(updateYUVFrameOnMainThread:)])&#123;</div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span>.delegate updateYUVFrameOnMainThread:(H264YUV_Frame *)&amp;yuvFrame];</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//æœ€åé‡Šæ”¾</span></div><div class="line">Â  Â  free(yuvFrame.luma.dataBuffer);</div><div class="line">Â  Â  free(yuvFrame.chromaB.dataBuffer);</div><div class="line">Â  Â  free(yuvFrame.chromaR.dataBuffer);</div><div class="line">Â Â  Â </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//è½¬RGBç®—æ³•</span></div><div class="line"><span class="keyword">void</span> copyDecodedFrame(<span class="keyword">unsigned</span> <span class="keyword">char</span> *src, <span class="keyword">unsigned</span> <span class="keyword">char</span> *dist,<span class="keyword">int</span> linesize, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</div><div class="line">&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  width = MIN(linesize, width);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; height; ++i) &#123;</div><div class="line">Â  Â  Â  Â  memcpy(dist, src, width);</div><div class="line">Â  Â  Â  Â  dist += width;</div><div class="line">Â  Â  Â  Â  src += linesize;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ OpenGL æ’­æ”¾æˆ‘ç”¨çš„æ˜¯å‰è¾ˆå†™çš„ OpenGL æ’­æ”¾å™¨ï¼Œåªéœ€è¦ä¼ å…¥RGB æ•°æ®å°±å¯ä»¥æ’­æ”¾äº†ï¼Œä¸‹é¢æ˜¯ä»£ç†æ–¹æ³•çš„å®ç°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark ------ LLQH264DecoderDelegate</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)updateYUVFrameOnMainThread:(H264YUV_Frame *)yuvFrame&#123;</div><div class="line">Â Â  Â </div><div class="line">    <span class="comment">//åªéœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥æ’­æ”¾äº†</span></div><div class="line">Â  Â  [_openGLFrameView render:yuvFrame];</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="imageViewæ’­æ”¾"><a href="#imageViewæ’­æ”¾" class="headerlink" title="imageViewæ’­æ”¾"></a>imageViewæ’­æ”¾</h2><p>åŒæ ·æ˜¯åˆ©ç”¨ä»£ç†æ–¹æ³•å°†è·å¾—çš„å›¾ç‰‡æ›´æ–°å‡ºå»</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è½¬ä¸ºimage</span></div><div class="line">- (<span class="keyword">void</span>)makeImage&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//ç»™pictureåˆ†é…ç©ºé—´</span></div><div class="line">Â  Â  <span class="built_in">AVPicture</span> pictureL = [<span class="keyword">self</span> AllocAVPicture];</div><div class="line">Â  Â  <span class="keyword">int</span> pictRet = sws_scale (img_convert_ctx,(<span class="keyword">const</span> uint8_t * <span class="keyword">const</span> *)pFrame-&gt;data, pFrame-&gt;linesize,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="number">0</span>, pCodecCtx-&gt;height,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pictureL.data, pictureL.linesize);</div><div class="line">Â  Â  <span class="keyword">if</span> (pictRet &gt; <span class="number">0</span>) &#123;</div><div class="line">Â  Â  Â  Â  <span class="built_in">UIImage</span> * image = [<span class="keyword">self</span> imageFromAVPicture:pictureL width:pCodecCtx-&gt;width height:pCodecCtx-&gt;height];</div><div class="line">Â  Â  Â  Â  [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1.0</span>/<span class="number">80.0</span>];</div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(updateImageOnMainTread:)]) &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  [<span class="keyword">self</span>.delegate updateImageOnMainTread:image];</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â  Â  <span class="comment">//é‡Šæ”¾AVPicture</span></div><div class="line">Â  Â  avpicture_free(&amp;pictureL);</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™è¾¹æ˜¯ä¸€äº›è½¬ä¸ºimageç”¨åˆ°çš„ç®—æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">-(<span class="built_in">AVPicture</span>)AllocAVPicture</div><div class="line">&#123;</div><div class="line">Â  Â  <span class="comment">//åˆ›å»ºAVPicture</span></div><div class="line">Â  Â  <span class="built_in">AVPicture</span> pictureL;</div><div class="line">Â  Â  sws_freeContext(img_convert_ctx);</div><div class="line">Â  Â  avpicture_alloc(&amp;pictureL, PIX_FMT_RGB24,pCodecCtx-&gt;width,pCodecCtx-&gt;height);</div><div class="line">Â  Â  <span class="keyword">static</span> <span class="keyword">int</span> sws_flags =Â  SWS_FAST_BILINEAR;</div><div class="line">Â  Â  img_convert_ctx = sws_getContext(pCodecCtx-&gt;width,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pCodecCtx-&gt;height,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pCodecCtx-&gt;pix_fmt,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pCodecCtx-&gt;width,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pCodecCtx-&gt;height,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PIX_FMT_RGB24,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sws_flags, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">Â Â  Â </div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">return</span> pictureL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**AVPictureè½¬UIImage*/</span></div><div class="line">-(<span class="built_in">UIImage</span> *)imageFromAVPicture:(<span class="built_in">AVPicture</span>)pict width:(<span class="keyword">int</span>)width height:(<span class="keyword">int</span>)height &#123;</div><div class="line">Â  Â  <span class="built_in">CGBitmapInfo</span> bitmapInfo = kCGBitmapByteOrderDefault;</div><div class="line">Â  Â  <span class="built_in">CFDataRef</span> data = <span class="built_in">CFDataCreateWithBytesNoCopy</span>(kCFAllocatorDefault, pict.data[<span class="number">0</span>], pict.linesize[<span class="number">0</span>]*height,kCFAllocatorNull);</div><div class="line">Â  Â  <span class="built_in">CGDataProviderRef</span> provider = <span class="built_in">CGDataProviderCreateWithCFData</span>(data);</div><div class="line">Â  Â  <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</div><div class="line">Â  Â  <span class="built_in">CGImageRef</span> cgImage = <span class="built_in">CGImageCreate</span>(width,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="number">8</span>,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="number">24</span>,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pict.linesize[<span class="number">0</span>],</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colorSpace,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bitmapInfo,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  provider,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="literal">NULL</span>,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="literal">NO</span>,</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  kCGRenderingIntentDefault);</div><div class="line">Â  Â  <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</div><div class="line">Â  Â  <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:cgImage];</div><div class="line">Â  Â  <span class="built_in">CGImageRelease</span>(cgImage);</div><div class="line">Â  Â  <span class="built_in">CGDataProviderRelease</span>(provider);</div><div class="line">Â  Â  <span class="built_in">CFRelease</span>(data);</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">return</span> image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç†æ–¹æ³•çš„å®ç°ï¼Œåªéœ€è¦å°†å›¾ç‰‡äº¤ç»™ imageView</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark ------ LLQH264DecoderDelegate</span></div><div class="line">- (<span class="keyword">void</span>)updateImageOnMainTread:(<span class="built_in">UIImage</span> *)image&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</div><div class="line">Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  _imageView.image = image;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;);</div><div class="line">Â Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/li1024316925/DecodeH264" target="_blank" rel="external">æœ€åé™„ä¸Šæºç åœ°å€</a><br>è¿™ä¸ªè§£ç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œéœ€è¦é™ä¸‹å¿ƒæ¥ç ”ç©¶ä¸€ä¸‹</p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FFmpeg/">FFmpeg</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-é€šè¿‡æ‹¦æˆª hitTest-withEvent æ–¹æ³•ï¼Œè§£å†³è¶…å‡ºçˆ¶è§†å›¾çš„å­è§†å›¾ä¸èƒ½æ¥å—ç‚¹å‡»äº‹ä»¶çš„é—®é¢˜"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/12/14/é€šè¿‡æ‹¦æˆª hitTest-withEvent æ–¹æ³•ï¼Œè§£å†³è¶…å‡ºçˆ¶è§†å›¾çš„å­è§†å›¾ä¸èƒ½æ¥å—ç‚¹å‡»äº‹ä»¶çš„é—®é¢˜/">é€šè¿‡æ‹¦æˆª hitTest:withEvent æ–¹æ³•ï¼Œè§£å†³è¶…å‡ºçˆ¶è§†å›¾çš„å­è§†å›¾ä¸èƒ½æ¥å—ç‚¹å‡»äº‹ä»¶çš„é—®é¢˜</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/12/14/é€šè¿‡æ‹¦æˆª hitTest-withEvent æ–¹æ³•ï¼Œè§£å†³è¶…å‡ºçˆ¶è§†å›¾çš„å­è§†å›¾ä¸èƒ½æ¥å—ç‚¹å‡»äº‹ä»¶çš„é—®é¢˜/" class="article-date">
	  <time datetime="2016-12-14T13:46:46.000Z" itemprop="datePublished">2016-12-14</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ç”±äºé¡¹ç›®éœ€æ±‚ï¼Œæˆ‘éœ€è¦åœ¨ä¸€ä¸ªé«˜åº¦ä¸º50çš„æ§ä»¶ä¸Šé¢åˆ›å»ºä¸€ä¸ªä¸‹æ‹‰èœå•ï¼Œæ•ˆæœå¦‚ä¸‹<br><img src="http://upload-images.jianshu.io/upload_images/1393645-7615f6291d98befb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>å½“æˆ‘åšå®Œä¹‹åå‘ç°ï¼Œä¸‹æ‹‰èœå•çš„ä¸‹æ‹‰é€‰æ‹©é¡¹ä¸èƒ½ç‚¹å‡»<br><img src="http://upload-images.jianshu.io/upload_images/1393645-95c2565295819887.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ§ä»¶é«˜åº¦åªæœ‰50ï¼Œä½†æ˜¯ä¸‹æ‹‰èœå•çš„é«˜åº¦è¶…å‡ºäº†æ§ä»¶çš„å¤§å°ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±æ¥å—ä¸åˆ°ç‚¹å‡»äº‹ä»¶äº†<br>è¿™è¾¹æ‰¾äº†ä¸€ä¸ªæ¯”è¾ƒè¯¦ç»†çš„å›¾ï¼Œæ¥æè¿°äº‹ä»¶çš„åˆ†å‘<br><img src="http://upload-images.jianshu.io/upload_images/1393645-f33f808a87360846.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="226702-dd53b5a6df2f3ea5.png"><br>æ¯ä¸ª view éƒ½ä¼šæœ‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="built_in">UIView</span> *view = [<span class="keyword">super</span> hitTest:point withEvent:event];</div><div class="line"></div><div class="line">Â  Â  <span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·ä¸€ä¸ªæ–¹æ³•<br>è¿™ä¸ªæ–¹æ³•ä¼šåˆ¤æ–­å½“å‰ç‚¹å‡»çš„â€œç‚¹â€æ˜¯å¦åœ¨æœ¬ view ä¸Šï¼Œå¦‚æœåœ¨æœ¬ view ä¸Šï¼Œå°±ç»§ç»­å¯»æ‰¾æœ¬ view çš„ Subviewï¼Œè¿˜æ˜¯é€šè¿‡æ­¤æ–¹æ³•åˆ¤æ–­ç‚¹å‡»çš„â€œç‚¹â€æ˜¯å¦åœ¨ Subview ä¸Šï¼Œç›´åˆ°æ‰¾å®Œæ‰€æœ‰çš„ Subviewï¼Œç„¶åè¿™ä¸ªæ–¹æ³•å°±ä¼š return è¿™ä¸ªæœ€ç»ˆçš„ Subview å¹¶ä¸€å±‚å±‚çš„å‘ä¸Šä¼ é€’ç»™ UIWindowï¼Œè¿™æ ·æˆ‘ä»¬å°±æ‹¿åˆ°äº†å±å¹•ä¸Šé¢æœ€ç»ˆå“åº”çš„ viewã€‚</p>
<p>å›åˆ°æˆ‘ä»¬æœ€å¼€å§‹é‡åˆ°çš„é—®é¢˜ã€‚</p>
<p>ç”±äºæˆ‘ä»¬ä¸‹æ‹‰èœå•è¶…å‡ºäº†æˆ‘ä»¬çš„è‡ªå®šä¹‰æ§ä»¶ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»åˆ°ä¸‹æ‹‰èœå•æ—¶ï¼Œä» UIWindow å¼€å§‹é€šè¿‡ <code>hitTest</code> æ–¹æ³•å‘ä¸‹å¯»æ‰¾å“åº”çš„ viewï¼Œå½“æŸ¥æ‰¾åˆ°æˆ‘ä»¬çš„è‡ªå®šä¹‰æ§ä»¶æ—¶ï¼Œå°±ä¼š return äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç‚¹å‡»çš„â€œç‚¹â€å·²ç»è¶…å‡ºäº†è‡ªå®šä¹‰æ§ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªâ€œç‚¹â€ä¸åœ¨æˆ‘ä»¬çš„è‡ªå®šä¹‰æ§ä»¶ä¸Šï¼Œæ‰€ä»¥åœ¨è‡ªå®šä¹‰æ§ä»¶ä¸Šé¢çš„ä¸‹æ‹‰èœå•æ— è®ºå¦‚ä½•ä¹Ÿä¸ä¼šå“åº”ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªè¦æ‰‹åŠ¨çš„å» return æˆ‘ä»¬çš„ä¸‹æ‹‰èœå•ï¼Œæ‰‹åŠ¨çš„å»è¿æ¥èµ·è¿™ä¸ª å“åº” view çš„é“¾ï¼Œæˆ‘ä»¬çš„ä¸‹æ‹‰èœå•å°±èƒ½å“åº”</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UIView</span> *)getTargetView:(<span class="built_in">UIView</span> *)view point:(<span class="built_in">CGPoint</span>)point event:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  __block <span class="built_in">UIView</span> *subView;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//é€†åº ç”±å±‚çº§æœ€ä½ ä¹Ÿå°±æ˜¯æœ€ä¸Šå±‚çš„å­è§†å›¾å¼€å§‹</span></div><div class="line">Â  Â  [view.subviews enumerateObjectsWithOptions:<span class="built_in">NSEnumerationReverse</span> usingBlock:^(__kindof <span class="built_in">UIView</span> * _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//point ä»view è½¬åˆ° objä¸­</span></div><div class="line">Â  Â  Â  Â  <span class="built_in">CGPoint</span> hitPoint = [obj convertPoint:point fromView:view];</div><div class="line">Â  Â  Â  Â  <span class="comment">//Â  Â  Â  Â  NSLog(@"%@ - %@",NSStringFromCGPoint(point),NSStringFromCGPoint(hitPoint));</span></div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span>([obj pointInside:hitPoint withEvent:event])<span class="comment">//åœ¨å½“å‰è§†å›¾èŒƒå›´å†…</span></div><div class="line">Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span>(obj.subviews.count != <span class="number">0</span>)</div><div class="line">Â  Â  Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//å¦‚æœæœ‰å­è§†å›¾ é€’å½’</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  subView = [<span class="keyword">self</span> getTargetView:obj point:hitPoint event:event];</div><div class="line">Â Â  Â  Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="keyword">if</span>(!subView)</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//å¦‚æœæ²¡æ‰¾åˆ° æäº¤å½“å‰è§†å›¾</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subView = obj;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">else</span></div><div class="line">Â  Â  Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  subView = obj;</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  *stop = <span class="literal">YES</span>;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  <span class="keyword">else</span><span class="comment">//ä¸åœ¨å½“å‰è§†å›¾èŒƒå›´å†…</span></div><div class="line">Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">if</span>(obj.subviews.count != <span class="number">0</span>)</div><div class="line">Â  Â  Â  Â  Â  Â  &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  <span class="comment">//å¦‚æœæœ‰å­è§†å›¾ é€’å½’</span></div><div class="line">Â  Â  Â  Â  Â  Â  Â  Â  subView = [<span class="keyword">self</span> getTargetView:obj point:hitPoint event:event];</div><div class="line">Â  Â  Â  Â  Â  Â  &#125;</div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;];</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">return</span> subView;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„ç›®çš„å°±æ˜¯æ‰¾åˆ°ç‚¹å‡»çš„â€œç‚¹â€æœ€ç»ˆæ‰€åœ¨çš„ subviewï¼Œç„¶å returnã€‚</p>
<p>æˆ‘ä»¬å†å›åˆ°æˆ‘ä»¬çš„å“åº”é“¾æ–­æ‰çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è‡ªå®šä¹‰æ§ä»¶å†…çš„ <code>hitTest</code> æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="built_in">UIView</span> *view = [<span class="keyword">super</span> hitTest:point withEvent:event];</div><div class="line">Â Â </div><div class="line">Â  Â  <span class="comment">//ç”±äºå“åº”é“¾åœ¨æ­¤å¤„æ–­å¼€ï¼Œæˆ‘ä»¬å°±å»æ‰‹åŠ¨å¯»æ‰¾æœ€ç»ˆå“åº”çš„å­è§†å›¾ï¼Œä¼ å…¥æœ¬ view éå†æœ¬ view çš„å­è§†å›¾</span></div><div class="line">Â  Â  <span class="built_in">UIView</span> *tempview = [<span class="keyword">self</span> getTargetView:<span class="keyword">self</span> point:point event:event];</div><div class="line">Â  Â  <span class="keyword">if</span> (tempview) &#123;</div><div class="line">Â  Â  Â  Â  view = tempview;</div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="keyword">return</span> view;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰‹åŠ¨æ‰¾åˆ°ç‚¹å‡»çš„ç‚¹æ‰€åœ¨çš„ subviewï¼Œå¹¶åœ¨æ–­å¼€çš„åœ°æ–¹ returnï¼Œè¿™æ ·æˆ‘ä»¬çš„ä¸‹æ‹‰èœå•å°±èƒ½å“åº”ç‚¹å‡»äº†</p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Swift3.0 ç‰ˆæ—¶å…‰ç”µå½±é¡¹ç›®ç¬”è®°"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/10/18/Swift3.0 ç‰ˆæ—¶å…‰ç”µå½±é¡¹ç›®ç¬”è®°/">Swift3.0 ç‰ˆæ—¶å…‰ç”µå½±é¡¹ç›®ç¬”è®°</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/10/18/Swift3.0 ç‰ˆæ—¶å…‰ç”µå½±é¡¹ç›®ç¬”è®°/" class="article-date">
	  <time datetime="2016-10-18T05:03:04.000Z" itemprop="datePublished">2016-10-18</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Swift åˆšå­¦å‡ å¤©ï¼Œä»¥ç»ƒæ‰‹çš„å¿ƒæ€æ”¹å†™ä»¥å‰ä¸€ä¸ª OC çš„å°é¡¹ç›®ï¼Œè¿™é‡Œè®°å½•ä¸€äº›é‡åˆ°çš„å‘ç‚¹ã€‚ç”±äºæ˜¯åˆå­¦è€…ï¼Œå„ä½å¤§ç‰›å¦‚æœå‘ç°é”™è¯¯ï¼Œæ¬¢è¿æŒ‡å‡ºã€‚é—²è¯ä¸å¤šè¯´ï¼Œä¸‹é¢å°±æ­£å¼å¼€å§‹</p>
<h1 id="1-ç§æœ‰å±æ€§å’Œæ–¹æ³•"><a href="#1-ç§æœ‰å±æ€§å’Œæ–¹æ³•" class="headerlink" title="1.ç§æœ‰å±æ€§å’Œæ–¹æ³•"></a>1.ç§æœ‰å±æ€§å’Œæ–¹æ³•</h1><p>åœ¨ Swift ä¸­ï¼Œæ˜¯æ²¡æœ‰ç§æœ‰å±æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ï¼ˆåé¢ä¼šæœ‰ä»‹ç»ï¼‰ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è®¿é—®çš„åˆ°ã€‚ä½†æ˜¯Swiftä¸­æ˜¯æœ‰æœ‰ private å…³é”®å­—çš„ï¼Œæ ¹æ®ç‰¹ç‚¹å†³å®šï¼Œå¦‚æœç¼–å†™ App çš„è¯ï¼Œç›´æ¥ç”¨é»˜è®¤çš„å°±å¥½äº†ï¼Œå°±æ˜¯å•¥ä¹Ÿä¸ç”¨æ•²ï¼Œå¦‚æœç¼–å†™ Frameworkï¼Œè¯·è®¤çœŸæ€è€ƒæµç¨‹ï¼Œè®¤çœŸè®¾è®¡ï¼Œå¤–éƒ¨æ¥å£è¦è®¾ç½® publicï¼Œè€Œä¸€äº›ä¸æƒ³è®©åˆ«äººçœ‹è§çš„å°±å¯ä»¥ç”¨ private æˆ–è€… internal ä¿®é¥°äº†</p>
<h1 id="2-Swiftä¸­çš„å®å®šä¹‰"><a href="#2-Swiftä¸­çš„å®å®šä¹‰" class="headerlink" title="2.Swiftä¸­çš„å®å®šä¹‰"></a>2.Swiftä¸­çš„å®å®šä¹‰</h1><p>åœ¨Swiftä¸­æ˜¯æ²¡æœ‰å®å®šä¹‰çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…¬ç”¨å‡½æ•°æ¥æ›¿ä»£å®ï¼Œæ¯”å¦‚<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">kTabBarWidth</span><span class="params">(object: UITabBarController)</span></span> -&gt; <span class="type">CGFloat</span> &#123;<span class="keyword">return</span> object.tabBar.frame.size.width&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">kTabBarHeight</span><span class="params">(object: UITabBarController)</span></span> -&gt; <span class="type">CGFloat</span> &#123;<span class="keyword">return</span> object.tabBar.frame.size.height&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">kButtonWidth</span><span class="params">(object: UITabBarController)</span></span> -&gt; <span class="type">CGFloat</span> &#123;<span class="keyword">return</span> kTabBarWidth(object: object)/<span class="type">CGFloat</span>((object.viewControllers?.<span class="built_in">count</span>)!)&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨å…¬ç”¨å‡½æ•°ä¸­å–ä¸åˆ°çš„å˜é‡æˆ‘ä»¬å¯ä»¥ä»¥å‚æ•°çš„å½¢å¼ä¼ å…¥</p>
<h1 id="3-Swift-ä¸­ä¸åŒç±»å‹å˜é‡çš„è¿ç®—"><a href="#3-Swift-ä¸­ä¸åŒç±»å‹å˜é‡çš„è¿ç®—" class="headerlink" title="3.Swift ä¸­ä¸åŒç±»å‹å˜é‡çš„è¿ç®—"></a>3.Swift ä¸­ä¸åŒç±»å‹å˜é‡çš„è¿ç®—</h1><p>Swift æ˜¯å¼ºè¯­è¨€ï¼Œå¦‚æœä¸¤ä¸ªä¸åŒç±»å‹çš„ç›¸åŠ ï¼Œå¿…é¡»è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> num1 = <span class="number">10</span></div><div class="line"><span class="keyword">let</span> num2 = <span class="number">9.9</span></div><div class="line"><span class="keyword">let</span> iSum = num1 + <span class="type">Int</span>(num2)</div><div class="line"><span class="keyword">let</span> dSum = <span class="type">Double</span>(num1) + num2</div></pre></td></tr></table></figure></p>
<h1 id="4-æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶"><a href="#4-æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶" class="headerlink" title="4.æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶"></a>4.æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶</h1><p>ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯#Selector(æ–¹æ³•å)çš„æ ·å¼<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶</span></div><div class="line">button.addTarget(<span class="keyword">self</span>, action: #selector(selectedVC(button:)), <span class="keyword">for</span>: <span class="type">UIControlEvents</span>.touchUpInside)</div></pre></td></tr></table></figure></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åé¢çš„æŒ‰é’®ç‚¹å‡»æ–¹å¼çš„æšä¸¾ç±»å‹åº”è¯¥ç”¨<br>æšä¸¾å+â€œ.â€+æšä¸¾å€¼<br>çš„æ–¹å¼æ¥è°ƒç”¨</p>
<h1 id="5-é—­åŒ…ä¸­çš„selfä¸å¾ªç¯å¼•ç”¨"><a href="#5-é—­åŒ…ä¸­çš„selfä¸å¾ªç¯å¼•ç”¨" class="headerlink" title="5.é—­åŒ…ä¸­çš„selfä¸å¾ªç¯å¼•ç”¨"></a>5.é—­åŒ…ä¸­çš„selfä¸å¾ªç¯å¼•ç”¨</h1><p>Swift ä¸­çš„é—­åŒ…ï¼Œä¹Ÿå°±æ˜¯ OC ä¸­çš„ Block ï¼Œæ€ä¹ˆä½¿ç”¨è¿™é‡Œå°±ä¸å¤šå™è¿°äº†ï¼Œæˆ‘ä»¬è¿™é‡Œè¦è¯´çš„ï¼Œæ˜¯è¦ç‰¹åˆ«æ³¨æ„çš„ç‚¹<br>åœ¨é—­åŒ…ä¸­ä½¿ç”¨æœ¬ç±»çš„å±æ€§æˆ–è°ƒç”¨æ–¹æ³•ï¼Œå¿…é¡»ä½¿ç”¨Selfè°ƒç”¨ï¼Œè¿™æ ·çš„è¯ï¼Œå°±äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå’ŒOCä¸­ç›¸å·®ä¸å¤šï¼Œæˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ª weak å…³é”®å­—æ¥è§£å†³è¿™ä¸€é—®é¢˜<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> homeViewModel = <span class="type">HomeViewModel</span>()</div><div class="line"><span class="keyword">weak</span> <span class="keyword">var</span> weakSelf = <span class="keyword">self</span></div><div class="line">homeViewModel.loadMovieData &#123; (data) <span class="keyword">in</span></div><div class="line">Â  Â  weakSelf!.dataList = data</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="6-Swiftä¸­çš„å‘½åç©ºé—´"><a href="#6-Swiftä¸­çš„å‘½åç©ºé—´" class="headerlink" title="6.Swiftä¸­çš„å‘½åç©ºé—´"></a>6.Swiftä¸­çš„å‘½åç©ºé—´</h1><p>Objective-C æ˜¯æ²¡æœ‰å‘½åç©ºé—´çš„ï¼Œåœ¨åº”ç”¨å¼€å‘æ—¶ï¼Œæ‰€æœ‰çš„ä»£ç å’Œå¼•ç”¨çš„é™æ€åº“æœ€ç»ˆéƒ½ä¼šè¢«ç¼–è¯‘åˆ°åŒä¸€ä¸ªåŸŸå’ŒäºŒè¿›åˆ¶ä¸­ã€‚è¿™æ ·çš„åæœæ˜¯ä¸€æ—¦æˆ‘ä»¬æœ‰é‡å¤çš„ç±»åçš„è¯ï¼Œå°±ä¼šå¯¼è‡´ç¼–è¯‘æ—¶çš„å†²çªå’Œå¤±è´¥ã€‚åœ¨ Swift ä¸­ï¼Œç”±äºå¯ä»¥ä½¿ç”¨å‘½åç©ºé—´äº†ï¼Œå³ä½¿æ˜¯åå­—ç›¸åŒçš„ç±»å‹ï¼Œåªè¦æ˜¯æ¥è‡ªä¸åŒçš„å‘½åç©ºé—´çš„è¯ï¼Œéƒ½æ˜¯å¯ä»¥å’Œå¹³å…±å¤„çš„ã€‚Swift ä¸­çš„å‘½åç©ºé—´çš„ä½¿ç”¨ä¸æ˜¯ä¸€ä¸ªé¡¹ç›®,è€Œæ˜¯éœ€è¦è·¨é¡¹ç›®,åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­,éƒ½æ˜¯ä¸€ä¸ªå‘½åç©ºé—´,åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹,æ‰€æœ‰å…¨å±€å˜é‡æˆ–è€…å‡½æ•°å…±äº«,ä¸éœ€è¦ import<br>æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†å‘½åç©ºé—´ï¼Œåœ¨æˆ‘ä»¬åŠ¨æ€åˆ›å»ºæ§åˆ¶å™¨çš„æ—¶å€™<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> imgNames = [<span class="string">"home"</span>,<span class="string">"payticket"</span>,<span class="string">"store"</span>,<span class="string">"discover"</span>,<span class="string">"myinfo"</span>]</div><div class="line"><span class="comment">//åˆ›å»ºæ ‡ç­¾æ§åˆ¶å™¨æ•°ç»„å­˜å‚¨æ ‡ç­¾æ§åˆ¶å™¨å</span></div><div class="line"><span class="keyword">let</span> viewContorllersArray = [<span class="string">"HomeViewController"</span>,<span class="string">"PayTicketViewController"</span>,<span class="string">"StoreViewController"</span>,<span class="string">"DiscoverViewController"</span>,<span class="string">"MyInfoViewController"</span>]</div><div class="line">Â Â  Â  Â  Â </div><div class="line"><span class="keyword">var</span> bnvVcArray:[<span class="type">UIViewController</span>] = []</div><div class="line">Â Â  Â  Â  Â </div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</div><div class="line">Â  Â  <span class="keyword">let</span> str = viewContorllersArray[i]</div><div class="line">Â  Â  <span class="comment">//é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²åˆ›å»ºæ§åˆ¶å™¨å¯¹è±¡</span></div><div class="line">Â  Â  <span class="comment">//è·å–å‘½åç©ºé—´</span></div><div class="line">Â  Â  <span class="comment">//namespaceåœ¨info.plist å¯¹åº”çš„æ˜¯ CFBundleExecutable,æˆ‘ä»¬å¯ä»¥åœ¨info.plistä¸­ä»»æ„å³å‡»ä¸€è¡Œ,é€‰ä¸­Show Raw Keys/Values</span></div><div class="line">Â  Â  <span class="keyword">let</span> namespace = <span class="type">Bundle</span>.main.infoDictionary![<span class="string">"CFBundleExecutable"</span>] <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">Â  Â  <span class="keyword">let</span> uivcType = <span class="type">NSClassFromString</span>(namespace + <span class="string">"."</span> + str) <span class="keyword">as</span>? <span class="type">UIViewController</span>.<span class="type">Type</span></div><div class="line">Â  Â  <span class="comment">//å¯é€‰ç»‘å®š</span></div><div class="line">Â  Â  <span class="keyword">if</span> <span class="keyword">let</span> type = uivcType &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//åˆ›å»º</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> uiVC = type.<span class="keyword">init</span>()</div><div class="line">Â  Â  Â  Â  uiVC.tabBarItem.selectedImage = <span class="type">UIImage</span>(named: imgNames[i] + <span class="string">"_on"</span>)</div><div class="line">Â  Â  Â  Â  uiVC.tabBarItem.image = <span class="type">UIImage</span>(named: imgNames[i])</div><div class="line">Â  Â  Â  Â  uiVC.title = imgNames[i]</div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> bnv = <span class="type">BaseNavViewController</span>(rootViewController: uiVC)</div><div class="line">Â  Â  Â  Â  bnvVcArray.append(bnv)</div><div class="line">Â  Â  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæ–°å»ºé¡¹ç›®æ—¶ï¼Œé¡¹ç›®åç§°ä¸­åŒ…å«æœ‰ä¸­æ–‡ï¼Œå¯ä»¥è¿›å…¥æ˜¯ Build Settings ä¸­é€‰ä¸­ â€œAllâ€ ï¼Œæœç´¢ product name ï¼Œå³å¯ä¿®æ”¹å‘½åç©ºé—´ï¼Œå¦‚å›¾:<br><img src="http://upload-images.jianshu.io/upload_images/1393645-21279dec8e9096b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2373BC66-3171-4EE9-998F-D715DD43D680.png"></p>
<h1 id="7-ä½¿ç”¨-Runtime-å®ç°å­—å…¸è½¬æ¨¡å‹"><a href="#7-ä½¿ç”¨-Runtime-å®ç°å­—å…¸è½¬æ¨¡å‹" class="headerlink" title="7.ä½¿ç”¨ Runtime å®ç°å­—å…¸è½¬æ¨¡å‹"></a>7.ä½¿ç”¨ Runtime å®ç°å­—å…¸è½¬æ¨¡å‹</h1><p>æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­è‡ªå®šä¹‰äº†ä¸€ä¸ª BaseModel è‡ªå®šä¹‰äº†ä¸€ä¸ªæ„é€ æ–¹æ³•ä¼ å…¥ä¸€ä¸ªå­—å…¸ï¼Œæ¥æ–¹ä¾¿çš„å®ç°å­—å…¸è½¬æ¨¡å‹ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ Swift ä¸­ä½¿ç”¨äº† Runtime<br>æˆ‘ä»¬çŸ¥é“ OC æ˜¯åŠ¨æ€è¯­è¨€ï¼Œèƒ½å¤Ÿé€šè¿‡ runtime API è°ƒç”¨å’Œæ›¿æ¢ä»»æ„æ–¹æ³•ï¼Œçº¯ Swift ç±»çš„å‡½æ•°è°ƒç”¨å·²ç»ä¸å†æ˜¯ OC çš„è¿è¡Œæ—¶å‘æ¶ˆæ¯ï¼Œè€Œæ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æ²¡æ³•é€šè¿‡ runtime è·å–æ–¹æ³•ã€å±æ€§ï¼Œè€ŒSwiftä¸ºäº†å…¼å®¹ OC ï¼Œå‡¡æ˜¯ç»§æ‰¿è‡ª NSObject çš„ç±»éƒ½ä¼šä¿ç•™å…¶åŠ¨æ€æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½é€šè¿‡ runtime æ‹¿åˆ°ç»§æ‰¿ä¸ NSObject çš„ç±»çš„æ–¹æ³•å’Œå±æ€§<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">setAttribut</span><span class="params">(dic: [String:Any])</span></span> -&gt; <span class="type">Void</span> &#123;</div><div class="line">Â  Â  <span class="keyword">let</span> attributDic = attributesDic(dic: dic)</div><div class="line"> Â  Â </div><div class="line">Â  Â  <span class="comment">//Runtimeè·å–æœ¬ç±»å±æ€§</span></div><div class="line">Â  Â  <span class="keyword">var</span> <span class="built_in">count</span>:<span class="type">UInt32</span> = <span class="number">0</span></div><div class="line">Â  Â  <span class="keyword">let</span> ivars = class_copyIvarList(<span class="keyword">self</span>.classForCoder, &amp;<span class="built_in">count</span>)</div><div class="line">Â  Â  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="built_in">count</span> &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//å–å‡ºå±æ€§å</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> ivar = ivars?[<span class="type">Int</span>(i)]</div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> ivarName = ivar_getName(ivar!)</div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> nName = <span class="type">String</span>(cString: ivarName!)</div><div class="line">Â  Â  Â  Â  <span class="comment">//å–å‡ºè¦èµ‹å€¼çš„å€¼</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> attribut = attributDic[nName]</div><div class="line">Â  Â  Â  Â  <span class="keyword">var</span> value:<span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> dic[attribut!] != <span class="literal">nil</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  value = dic[attribut!] <span class="keyword">as</span>! <span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  &#125; <span class="keyword">else</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  value = <span class="string">""</span> <span class="keyword">as</span> <span class="type">NSObject</span></div><div class="line">Â  Â  Â  Â  &#125; Â  </div><div class="line">Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//åˆ©ç”¨KVCç»™æœ¬ç±»çš„å±æ€§èµ‹å€¼</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">self</span>.setValue(value, forKey: nName)</div><div class="line">Â Â  Â  Â   Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="8-Swift-ä¸­çš„å¼‚å¸¸å¤„ç†"><a href="#8-Swift-ä¸­çš„å¼‚å¸¸å¤„ç†" class="headerlink" title="8.Swift ä¸­çš„å¼‚å¸¸å¤„ç†"></a>8.Swift ä¸­çš„å¼‚å¸¸å¤„ç†</h1><p>åœ¨ OC ä¸­è°ƒç”¨æ–¹æ³•æ—¶ï¼Œé€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ª NSError å‚æ•°æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯çš„ï¼Œä½†æ˜¯åœ¨Swiftä¸­è¿”å›å¼‚å¸¸çš„æ–¹å¼å°±æœ‰äº›ä¸åŒäº†ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªè¿”å›å¼‚å¸¸çš„å‡½æ•°ï¼Œå¹¶ä¸”è°ƒç”¨è¿™ä¸ªå‡½æ•°<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªæŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•</span></div><div class="line"><span class="comment">//åœ¨ä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œè¿”å›å€¼æ˜¯Stringç±»å‹ï¼Œ</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">someFunctionWhichCanFail</span><span class="params">(param: Int)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">String</span> &#123;Â  Â  Â  Â </div><div class="line">Â  Â  <span class="keyword">if</span> param &gt; <span class="number">0</span> &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">return</span> <span class="string">"æˆåŠŸ"</span></div><div class="line">Â  Â  &#125; <span class="keyword">else</span> &#123;</div><div class="line">Â  Â  Â  Â  <span class="keyword">throw</span> <span class="type">NSError</span>(domain: <span class="string">"å•¦å•¦å•¦ï¼Œå¤±è´¥äº†"</span>, code: <span class="number">499</span>, userInfo: <span class="literal">nil</span>)</div><div class="line">Â  Â  &#125;Â  Â </div><div class="line">&#125;</div><div class="line"><span class="comment">//do-try-catchè¿™ç§é”™è¯¯æ¨¡å¼ï¼Œæœ¬æ„å°±æ˜¯å°è¯•ï¼ˆtryï¼‰åšä¸€ä»¶äº‹æƒ…ï¼Œå¦‚æœå¤±è´¥åˆ™æ•è·ï¼ˆcatchï¼‰å¤„ç†ã€‚</span></div><div class="line"><span class="comment">//è¦æ³¨æ„çš„æ˜¯ä½ å¯ä»¥åœ¨ do ä»£ç æ®µä¸­å†™å¤šäºä¸€è¡Œçš„ä»£ç (å¹¶ä¸” try å¯ä»¥è°ƒç”¨ä¸æ­¢ä¸€ä¸ªæŠ›é”™è¯¯çš„æ–¹æ³•)ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œå°†ä¼šåƒé¢„æœŸçš„é‚£æ ·æ‰§è¡Œé‚£äº›æ–¹æ³•ï¼Œä½†æ˜¯ä¸€æ—¦æ–¹æ³•å‡ºé”™å°±ä¼šè·³å‡º do ä»£ç æ®µï¼Œè¿›å…¥ catch å¤„ã€‚</span></div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">Â  Â  <span class="comment">//å°è¯•åšä¸€ä»¶äº‹æƒ…</span></div><div class="line">Â  Â  <span class="keyword">let</span> result = <span class="keyword">try</span> someFunctionWhichCanFail(param: -<span class="number">1</span>)</div><div class="line">Â  Â  <span class="built_in">print</span>(<span class="string">"\(result)"</span>)</div><div class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">Â  Â  <span class="comment">//åœ¨catchä¸­æ•è·é”™è¯¯ä¿¡æ¯</span></div><div class="line">Â  Â  <span class="built_in">print</span>(<span class="string">"\(error)"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±åŸºæœ¬æ˜ç™½äº† Swift ä¸­å¤„ç†å¼‚å¸¸çš„åŸºæœ¬æ–¹å¼ï¼Œå†çœ‹æˆ‘ä»¬çš„é¡¹ç›®ã€‚<br>åœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å°è£…äº†ä¸€ä¸ªJSONæ–‡ä»¶è§£æç±»ï¼Œè¿™ä¸ªç±»æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œä¼ å…¥JSONæ–‡ä»¶åï¼Œè¿”å›ä¸€ä¸ªè§£æå¥½çš„å­—å…¸æˆ–æ˜¯æ•°ç»„<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">jsonObjectFromFileName</span>(<span class="title">fileName</span>: <span class="title">String</span>) -&gt; <span class="title">NSDictionary</span>? </span>&#123;</div><div class="line">Â  Â  <span class="comment">//è·å–æ–‡ä»¶è·¯å¾„</span></div><div class="line">Â  Â  <span class="keyword">let</span> path = <span class="type">Bundle</span>.main.path(forResource: fileName, ofType: <span class="string">"json"</span>)</div><div class="line">Â  Â  <span class="comment">//è§£æ</span></div><div class="line">Â  Â  <span class="keyword">let</span> data = <span class="type">NSData</span>.<span class="keyword">init</span>(contentsOfFile: path!)</div><div class="line">Â  Â  <span class="keyword">let</span> dic = <span class="keyword">try</span>! <span class="type">JSONSerialization</span>.jsonObject(with: data! <span class="keyword">as</span> <span class="type">Data</span>, options: <span class="type">JSONSerialization</span>.<span class="type">ReadingOptions</span>.allowFragments) <span class="keyword">as</span>? <span class="type">NSDictionary</span></div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  <span class="keyword">return</span> dic</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„<br>JSONSerialization.jsonObject(with: data! as Data, options: JSONSerialization.ReadingOptions.allowFragments)<br>æ–¹æ³•æ˜¯è¦æ±‚æˆ‘ä»¬å¿…é¡»æ•è·ä¸€ä¸ªå¼‚å¸¸çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä»£ç ä¸­ä½¿ç”¨äº†ä¸€ä¸ª try! å…³é”®å­—ï¼Œè¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨ try? å…³é”®å­—ã€‚try? ä¼šå°†é”™è¯¯è½¬æ¢ä¸ºå¯é€‰å€¼ï¼Œå½“è°ƒç”¨ try? ï¼‹å‡½æ•°æˆ–æ–¹æ³•è¯­å¥ çš„æ—¶å€™ï¼Œå¦‚æœå‡½æ•°æˆ–æ–¹æ³•æŠ›å‡ºé”™è¯¯ï¼Œç¨‹åºä¸ä¼šå‘å´©æºƒï¼Œè€Œè¿”å›ä¸€ä¸ªnilï¼Œå¦‚æœæ²¡æœ‰æŠ›å‡ºé”™è¯¯åˆ™è¿”å›å¯é€‰å€¼ï¼Œä¸ä¼šå«æœ‰æ›´å¤šçš„é€ æˆç‰¹å®šçš„é”™è¯¯æˆ–è€…å¼‚å¸¸åŸå› çš„ä¿¡æ¯ã€‚try! æ‰“ç ´äº†é”™è¯¯ä¼ æ’­é“¾æ¡ï¼Œä½†æ˜¯å¦‚æœçœŸçš„å‘ç”Ÿé”™è¯¯å°±å‡ºç°è¿è¡ŒæœŸé”™è¯¯ï¼Œå¯¼è‡´ç¨‹åºçš„å´©æºƒã€‚æ‰€ä»¥ä½¿ç”¨ try! æ‰“ç ´é”™è¯¯ä¼ æ’­é“¾æ¡æ—¶ï¼Œåº”è¯¥ç¡®ä¿ç¨‹åºä¸ä¼šå‘ç”Ÿé”™è¯¯</p>
<h1 id="9-Swift-é¡¹ç›®ä¸­ä½¿ç”¨-CocoaPods"><a href="#9-Swift-é¡¹ç›®ä¸­ä½¿ç”¨-CocoaPods" class="headerlink" title="9.Swift é¡¹ç›®ä¸­ä½¿ç”¨ CocoaPods"></a>9.Swift é¡¹ç›®ä¸­ä½¿ç”¨ CocoaPods</h1><p>Swift é¡¹ç›®ä¸­ä½¿ç”¨ Cocoapods å¯¼å…¥ç¬¬ä¸‰æ–¹åº“ï¼Œå¯¼å…¥çš„è¿‡ç¨‹ä¸ OC é¡¹ç›®æ— å¼‚ï¼Œä½†æ˜¯ä½¿ç”¨æ—¶ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª Bridging-Header.h æ¡¥æ¥å¤´æ–‡ä»¶ï¼Œæ¥å®ç° OC ä¸ Swift æ··ç¼–<br><img src="http://upload-images.jianshu.io/upload_images/1393645-8fd9129efb896ad0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>å¯ä»¥åœ¨Building Settingsä¸­è‡ªå·±è®¾ç½®æ¡¥æ¥å¤´æ–‡ä»¶</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-e2e655391285c0e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot 2.png"><br>è¿™é‡Œæœ‰ä¸ªç®€ä¾¿æ–¹æ³•ç”Ÿæˆè¿™ä¸ªæ¡¥æ¥æ–‡ä»¶ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª OC æ–‡ä»¶ï¼ŒXcodeå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªæ¡¥æ¥å¤´æ–‡ä»¶<br>æœ‰äº†å¤´æ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¡¥æ¥æ–‡ä»¶ä¸­å¯¼å…¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå°±å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨äº†~~~~</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-b04706b707d455a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot 3.png"></p>
<h1 id="10-å­ç±»å®ç°çˆ¶ç±»çš„ä»£ç†æ–¹æ³•"><a href="#10-å­ç±»å®ç°çˆ¶ç±»çš„ä»£ç†æ–¹æ³•" class="headerlink" title="10.å­ç±»å®ç°çˆ¶ç±»çš„ä»£ç†æ–¹æ³•"></a>10.å­ç±»å®ç°çˆ¶ç±»çš„ä»£ç†æ–¹æ³•</h1><p>åœ¨è¿™é‡Œï¼Œè®©æˆ‘ä»¬é¦–å…ˆçœ‹é¡¹ç›®ä¸­çš„ä¾‹å­<br>æˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ª BaseCollectionView ç»§æ‰¿äº UICollectionView ï¼Œå¹¶å°†ä»£ç†è®¾ç½®ä¸ºè‡ªå·±<br><img src="http://upload-images.jianshu.io/upload_images/1393645-169020eb03fefbee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>ç„¶åæˆ‘ä»¬åˆå£°æ˜äº†ä¸€ä¸ª PosterCollectionView ç»§æ‰¿äº†BaseCollectionView<br><img src="http://upload-images.jianshu.io/upload_images/1393645-b245fda051861ade.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>åœ¨ OC ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨ PosterCollectionView é‡Œå®ç° UICollectionView çš„ delegate æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥åœ¨å­ç±» PosterCollectionView ä¸­ä¹¦å†™å°±å¯ä»¥äº†ï¼Œä½†æ˜¯åœ¨Swiftä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨çˆ¶ç±» BaseCollectionView ä¸­å®ç°ï¼Œç„¶ååœ¨å­ç±» PosterCollectionView ä¸­é‡å†™</p>
<p>çˆ¶ç±»ï¼š<br><img src="http://upload-images.jianshu.io/upload_images/1393645-25cdf09067afd92c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"><br>å­ç±»ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1393645-b209ec1954c829e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="screenshot.png"></p>
<h1 id="11-Swift-ä¸­çš„-KVO"><a href="#11-Swift-ä¸­çš„-KVO" class="headerlink" title="11.Swift ä¸­çš„ KVO"></a>11.Swift ä¸­çš„ KVO</h1><p>Swift ä¸­çš„ KVO ä½¿ç”¨ä¸ OC ç›¸å·®ä¸å¤šï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›å‘ç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬åªæ˜¯ç®€å•çš„è¯´ä¸€ä¸‹<br>1.è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…éƒ½å¿…é¡»æ˜¯ NSObject çš„å­ç±»ï¼Œå› ä¸º OC ä¸­ KVO çš„å®ç°åŸºäº KVC å’Œ runtime æœºåˆ¶ï¼Œåªæœ‰æ˜¯ NSObject çš„å­ç±»æ‰èƒ½åˆ©ç”¨è¿™äº›ç‰¹æ€§<br>2.è¦è§‚å¯Ÿçš„å±æ€§ä½¿ç”¨ @dynamic ä¿®é¥°ï¼Œè¡¨ç¤ºè¯¥å±æ€§çš„å­˜å–éƒ½ç”± runtime åœ¨è¿è¡Œæ—¶æ¥å†³å®šï¼Œç”±äº Swift åŸºäºæ•ˆç‡çš„è€ƒé‡é»˜è®¤ç¦æ­¢äº†åŠ¨æ€æ´¾å‘æœºåˆ¶ï¼Œå› æ­¤è¦åŠ ä¸Šè¯¥ä¿®é¥°ç¬¦æ¥å¼€å¯åŠ¨æ€æ´¾å‘<br>è¿™é‡Œæ˜¯é¡¹ç›®ä¸­çš„å®ç°ä»£ç <br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è¢«è§‚å¯Ÿçš„å±æ€§ï¼ŒåŠ dynamicå…³é”®å­—</span></div><div class="line"><span class="comment">//è®°å½•ä¸‹æ ‡</span></div><div class="line"><span class="keyword">dynamic</span> <span class="keyword">var</span> currentIndex:<span class="type">Int</span> = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ·»åŠ ç›‘å¬</span></div><div class="line">Â  Â  <span class="function"><span class="keyword">func</span> <span class="title">addObserver</span><span class="params">()</span></span> -&gt; <span class="type">Void</span> &#123;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//æ·»åŠ indexCollectionViewçš„ç›‘å¬</span></div><div class="line">Â  Â  Â  Â  indexCollectionView?.addObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"currentIndex"</span>, options: <span class="type">NSKeyValueObservingOptions</span>.new, context: <span class="literal">nil</span>)</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//æ·»åŠ posterCollectionViewçš„ç›‘å¬</span></div><div class="line">Â  Â  Â  Â  posterCollectionView?.addObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"currentIndex"</span>, options: <span class="type">NSKeyValueObservingOptions</span>.new, context: <span class="literal">nil</span>)</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//è§‚å¯Ÿè€…æ–¹æ³•</span></div><div class="line">Â  Â  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?)</span></span> &#123;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//å˜åŒ–åçš„å€¼</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> index = change?[<span class="type">NSKeyValueChangeKey</span>.newKey] <span class="keyword">as</span>! <span class="type">Int</span></div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//åˆ›å»ºindexPath</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">let</span> indexPath = <span class="type">IndexPath</span>(item: index, section: <span class="number">0</span>)</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯currenIndexå±æ€§</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">guard</span> keyPath == <span class="string">"currentIndex"</span> <span class="keyword">else</span> &#123;</div><div class="line">Â  Â  Â  Â  Â  Â  <span class="keyword">return</span></div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//åˆ¤æ–­å¯¹è±¡çš„ç±»å‹</span></div><div class="line">Â  Â  Â  Â  <span class="keyword">if</span> object <span class="keyword">is</span> <span class="type">PosterCollectionView</span> &#123;</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//æ»‘åŠ¨åˆ°æŒ‡å®šå•å…ƒæ ¼</span></div><div class="line">Â  Â  Â  Â  Â  Â  indexCollectionView?.scrollToItem(at: indexPath, at: <span class="type">UICollectionViewScrollPosition</span>.centeredHorizontally, animated: <span class="literal">true</span>)</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  &#125; <span class="keyword">else</span> <span class="keyword">if</span> object <span class="keyword">is</span> <span class="type">IndexCollectionView</span>&#123;</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  Â  Â  <span class="comment">//æ»‘åŠ¨åˆ°æŒ‡å®šå•å…ƒæ ¼</span></div><div class="line">Â  Â  Â  Â  Â  Â  posterCollectionView?.scrollToItem(at: indexPath, at: <span class="type">UICollectionViewScrollPosition</span>.centeredHorizontally, animated: <span class="literal">true</span>)</div><div class="line">Â Â  Â  Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  &#125;</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  Â  Â  <span class="comment">//å˜æ¢æ ‡é¢˜</span></div><div class="line">Â  Â  Â  Â  titleLabel?.text = dataList?[index].titleCn</div><div class="line">Â Â  Â  Â  Â </div><div class="line">Â  Â  &#125;</div><div class="line">Â Â  Â </div><div class="line">Â  Â  <span class="comment">//é”€æ¯</span></div><div class="line">Â  Â  <span class="keyword">deinit</span> &#123;</div><div class="line">Â  Â  Â  Â  <span class="comment">//ç§»é™¤è§‚å¯Ÿè€…</span></div><div class="line">Â  Â  Â  Â  indexCollectionView?.removeObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"currentIndex"</span>)</div><div class="line">Â  Â  Â  Â  posterCollectionView?.removeObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"currentIndex"</span>)</div><div class="line">Â  Â  &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ³¨æ„ä¸€å®šè¦åœ¨ææ„å‡½æ•°ä¸­ç§»é™¤ç›‘å¬<br>å¦‚æœä½ è¿˜å¯¹ Swift ä¸­çš„ KVO æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« <br><a href="http://www.jianshu.com/p/e036e53d240e" target="_blank" rel="external">Swift: KVO æ³¨æ„äº‹é¡¹å’Œå±æ€§è§‚å¯Ÿå™¨</a></p>
<p>åœ¨æœ€åï¼Œæ”¾ä¸Šå°é¡¹ç›®çš„åœ°å€ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œè¯´å†å¤šä¹Ÿä¸å¦‚è‡ªå·±æ•²ä¸€æ•²<br><a href="https://github.com/li1024316925/Swift-TimeMovie" target="_blank" rel="external">æ—¶å…‰ç”µå½±Swiftç‰ˆåˆå­¦å°é¡¹ç›®</a></p>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swift-iOS/">Swift iOS</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-åŸºç¡€ç®—æ³•åˆé›†ï¼ˆæœªå®Œå¾…ç»­-ï¼‰"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2016/08/03/åŸºç¡€ç®—æ³•åˆé›†ï¼ˆæœªå®Œå¾…ç»­-ï¼‰/">åŸºç¡€ç®—æ³•åˆé›†ï¼ˆæœªå®Œå¾…ç»­...ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2016/08/03/åŸºç¡€ç®—æ³•åˆé›†ï¼ˆæœªå®Œå¾…ç»­-ï¼‰/" class="article-date">
	  <time datetime="2016-08-03T09:15:20.000Z" itemprop="datePublished">2016-08-03</time>
	</a>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="æ¡¶æ’åº"><a href="#æ¡¶æ’åº" class="headerlink" title="æ¡¶æ’åº"></a>æ¡¶æ’åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - æ¡¶æ’åº</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"æ¡¶æ’åº\n"</span>);</div><div class="line">    <span class="comment">//æ¯”è¾ƒ0~10ä¹‹é—´çš„æ•°åˆ™åˆ›å»ºä¸€ä¸ªé•¿åº¦11çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> a[<span class="number">11</span>];</div><div class="line">    <span class="comment">//åˆå§‹åŒ–ï¼Œå…¨éƒ¨å½’0</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i ++) &#123;</div><div class="line">        a[i] = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è¯»å…¥5ä¸ªæ•°ï¼Œè®°å½•æ¯ä¸ªæ•°å‡ºç°çš„æ¬¡æ•°</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">        <span class="keyword">int</span> t;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;t);</div><div class="line">        a[t]++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æŒ‰é¡ºåºå°†è§’æ ‡è¾“å‡ºï¼ˆè§’æ ‡å³ä¸ºæ’åºçš„æ•°ï¼‰ï¼Œä¸ªæ•°æ˜¯å‡ å°±è¾“å‡ºå‡ æ¬¡</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">11</span>; i ++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= a[i]; j ++) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - å†’æ³¡æ’åº</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"å†’æ³¡æ’åº\n"</span>);</div><div class="line">    <span class="comment">//æ¯”è¾ƒ5ä¸ªæ•°ï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º5çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> b[<span class="number">5</span>];</div><div class="line">    <span class="comment">//è¯»å…¥5ä¸ªæ•°</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;b[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ’åº</span></div><div class="line">    <span class="comment">//5ä¸ªæ•°åªéœ€è¦å†’æ³¡å››æ¬¡</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span><span class="number">-1</span>; i ++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>-i; j ++) &#123;</div><div class="line">            <span class="keyword">if</span> (b[j]&lt;b[j+<span class="number">1</span>]) &#123;</div><div class="line">                <span class="comment">//ä¸¤ä¸ªæ•°æ¯”è¾ƒï¼Œå¦‚æœåé¢çš„æ•°å¤§äºå‰é¢çš„æ•°ï¼Œåˆ™ä¸¤ä¸ªæ•°äº¤æ¢ï¼ˆå†’æ³¡ï¼‰</span></div><div class="line">                <span class="keyword">int</span> t;</div><div class="line">                t = b[j];</div><div class="line">                b[j] = b[j+<span class="number">1</span>];</div><div class="line">                b[j+<span class="number">1</span>] = t;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æŒ‰é¡ºåºè¾“å‡º</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,b[i]);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - å¿«é€Ÿæ’åº</span></div><div class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªå…¨å±€æ•°ç»„ç”¨äºæ’åº10ä¸ªæ•°</span></div><div class="line"><span class="keyword">int</span> a[<span class="number">10</span>];</div><div class="line"></div><div class="line"><span class="comment">//å¿«é€Ÿæ’åºå‡½æ•°</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicksort</span><span class="params">(<span class="keyword">int</span> left,<span class="keyword">int</span> right)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span> (right&lt;left) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//è®©iï¼Œjåˆ†åˆ«ç­‰äºå·¦å³ä¸¤è¾¹çš„ä¸‹æ ‡ï¼Œè®©æœ€å·¦çš„æ•°ä½œä¸ºåŸºæ•°</span></div><div class="line">    <span class="keyword">int</span> i = left,j = right,temp = a[left],t;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     1.å…ˆjå‘å·¦ç§»åŠ¨ï¼Œç›´åˆ°æ‰¾åˆ°æ¯”tempå°çš„æ•°ï¼Œç„¶åè®©iå‘å³ç§»åŠ¨ï¼Œç›´åˆ°æ‰¾åˆ°æ¯”tempå¤§çš„æ•°ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªæ•°äº¤æ¢ä½ç½®ã€‚ç”±äºåŸºæ•°ä¸ºæœ€å·¦ç«¯çš„æ•°ï¼Œæ‰€ä»¥ä¸€å®šè¦è®©jå…ˆå‘å·¦ç§»åŠ¨</div><div class="line">     2.ç»§ç»­ç§»åŠ¨iï¼Œjï¼Œé‡å¤æ­¥éª¤1ï¼Œç›´åˆ°iï¼Œjç›¸ç­‰ï¼Œå°†åŸºæ•°æ”¾äºiä½ç½®</div><div class="line">     3.ä»åŸºæ•°å¤„åˆ†ä¸ºä¸¤ç»„ï¼Œåˆ†åˆ«æ‰§è¡Œæ­¥éª¤1ã€2ã€3</div><div class="line">     */</div><div class="line">    <span class="keyword">while</span> (i != j) &#123;</div><div class="line">        <span class="comment">//å…ˆè®©jå‘å·¦ç§»åŠ¨</span></div><div class="line">        <span class="keyword">while</span> (a[j]&gt;=temp &amp;&amp; i&lt;j) &#123;</div><div class="line">            j --;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å†è®©iå‘å³ç§»åŠ¨</span></div><div class="line">        <span class="keyword">while</span> (a[i]&lt;=temp &amp;&amp; i&lt;j) &#123;</div><div class="line">            i ++;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//æ‰¾åˆ°æ¯”åŸºæ•°å°çš„æ•°ä¸æ¯”åŸºæ•°å¤§çš„æ•°ï¼Œäº¤æ¢</span></div><div class="line">        <span class="keyword">if</span> (i &lt; j) &#123;</div><div class="line">            t = a[i];</div><div class="line">            a[i] = a[j];</div><div class="line">            a[j] = t;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//iï¼Œjç›¸ç­‰ï¼Œå°†åŸºæ•°ä¸iä½ç½®çš„æ•°äº¤æ¢</span></div><div class="line">    a[left] = a[i];</div><div class="line">    a[i] = temp;</div><div class="line">    <span class="comment">//åˆ†æˆä¸¤ç»„ï¼Œç»§ç»­æ“ä½œ</span></div><div class="line">    quicksort(left, i<span class="number">-1</span>);</div><div class="line">    quicksort(i+<span class="number">1</span>, right);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//è¯»å…¥åä¸ªæ•°</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a[i]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//æ‰§è¡Œæ’åºå‡½æ•°</span></div><div class="line">    quicksort(<span class="number">0</span>, <span class="number">9</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,a[i]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="é˜Ÿåˆ—ä¸å‡ºå…¥é˜Ÿ"><a href="#é˜Ÿåˆ—ä¸å‡ºå…¥é˜Ÿ" class="headerlink" title="é˜Ÿåˆ—ä¸å‡ºå…¥é˜Ÿ"></a>é˜Ÿåˆ—ä¸å‡ºå…¥é˜Ÿ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - é˜Ÿåˆ—ä¸å‡ºå…¥é˜Ÿåˆ—</span></div><div class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªé˜Ÿåˆ—</span></div><div class="line"><span class="keyword">struct</span> <span class="built_in">queue</span> &#123;</div><div class="line">    <span class="keyword">int</span> data[<span class="number">100</span>];  <span class="comment">//é˜Ÿåˆ—ä¸»ä½“ï¼Œå­˜å‚¨æ•°æ®</span></div><div class="line">    <span class="keyword">int</span> head;  <span class="comment">//é˜Ÿé¦–</span></div><div class="line">    <span class="keyword">int</span> tail;  <span class="comment">//é˜Ÿå°¾</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> <span class="built_in">queue</span> q;  <span class="comment">//åˆå§‹åŒ–ä¸€ä¸ªé˜Ÿåˆ—</span></div><div class="line">    <span class="comment">//åˆå§‹åŒ–</span></div><div class="line">    q.head = <span class="number">0</span>;</div><div class="line">    q.tail = <span class="number">0</span>;</div><div class="line">    <span class="comment">//è¾“å…¥9ä¸ªæ•°</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i ++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;q.data[q.tail]);</div><div class="line">        q.tail ++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//ç©ºé˜Ÿåˆ—æ—¶åœæ­¢å¾ªç¯</span></div><div class="line">    <span class="keyword">while</span> (q.head &lt; q.tail) &#123;</div><div class="line">        <span class="comment">//æ‰“å°é˜Ÿé¦–ï¼Œå¹¶å‡ºé˜Ÿ</span></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,q.data[q.head]);</div><div class="line">        q.head ++;</div><div class="line">        <span class="comment">//å°†æ–°é˜Ÿé¦–æ·»åŠ åˆ°é˜Ÿå°¾</span></div><div class="line">        q.data[q.tail] = q.data[q.head];</div><div class="line">        q.tail ++;</div><div class="line">        <span class="comment">//å†å°†é˜Ÿé¦–å‡ºé˜Ÿ</span></div><div class="line">        q.head ++;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="åˆ¤æ–­å›æ–‡ï¼ˆæ ˆæ“ä½œï¼‰"><a href="#åˆ¤æ–­å›æ–‡ï¼ˆæ ˆæ“ä½œï¼‰" class="headerlink" title="åˆ¤æ–­å›æ–‡ï¼ˆæ ˆæ“ä½œï¼‰"></a>åˆ¤æ–­å›æ–‡ï¼ˆæ ˆæ“ä½œï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºå›æ–‡</span></div><div class="line">    <span class="keyword">char</span> a[<span class="number">100</span>], s[<span class="number">100</span>];</div><div class="line">    <span class="keyword">long</span> len, next, top, mid;</div><div class="line">    <span class="comment">//è¾“å…¥ä¸€ä¸²å­—ç¬¦</span></div><div class="line">    gets(a);</div><div class="line">    len = <span class="built_in">strlen</span>(a);</div><div class="line">    <span class="comment">//æ‰¾å‡ºä¸­ç‚¹</span></div><div class="line">    mid = len/<span class="number">2</span><span class="number">-1</span>;</div><div class="line">    <span class="comment">//åˆå§‹åŒ–æ ˆ</span></div><div class="line">    top = <span class="number">0</span>;</div><div class="line">    <span class="comment">//å°†ä¸­ç‚¹å‰çš„å­—ç¬¦å…¥æ ˆ</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;= mid; i ++) &#123;</div><div class="line">        top ++;</div><div class="line">        s[top] = a[i];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//åˆ¤æ–­å¥‡å¶ï¼Œæ¥ç¡®å®šå¼€å§‹å¯¹æ¯”çš„ä½ç½®</span></div><div class="line">    <span class="keyword">if</span> (len%<span class="number">2</span> == <span class="number">0</span>) &#123;</div><div class="line">        next = mid + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        next = mid + <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//å¯¹æ¯”ï¼Œå¯¹æ¯”æˆåŠŸä¸€ä½å‡ºæ ˆä¸€ä½</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> i = next; i &lt; len; i ++) &#123;</div><div class="line">        <span class="keyword">if</span> (s[top] != a[i]) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å‡ºæ ˆæ“ä½œ</span></div><div class="line">        top --;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (top == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"y\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"n\n"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="é“¾è¡¨-æ’å…¥ä¸€ä¸ªæ•°æ®"><a href="#é“¾è¡¨-æ’å…¥ä¸€ä¸ªæ•°æ®" class="headerlink" title="é“¾è¡¨-æ’å…¥ä¸€ä¸ªæ•°æ®"></a>é“¾è¡¨-æ’å…¥ä¸€ä¸ªæ•°æ®</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - é“¾è¡¨æ“ä½œ-æ’å…¥ä¸€ä¸ªæ•°æ®</span></div><div class="line"><span class="comment">//å®šä¹‰é“¾è¡¨çš„èŠ‚ç‚¹</span></div><div class="line"><span class="keyword">struct</span> node &#123;</div><div class="line">    <span class="keyword">int</span> data;  <span class="comment">//èŠ‚ç‚¹çš„æ•°æ®</span></div><div class="line">    <span class="keyword">struct</span> node *next;  <span class="comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> node *head, *p, *q, *t;</div><div class="line">    <span class="comment">//è¯»å…¥5ä¸ªæ•°</span></div><div class="line">    <span class="keyword">int</span> a;</div><div class="line">    head = <span class="literal">NULL</span>;</div><div class="line">    q = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a);</div><div class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">        p = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> node));</div><div class="line">        p-&gt;data = a;</div><div class="line">        p-&gt;next = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (head == <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="comment">//å¦‚æœå¤´èŠ‚ç‚¹çš„æŒ‡é’ˆä¸ºç©ºï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªç©ºé“¾è¡¨ï¼Œå°†æ–°åˆ›å»ºçš„èŠ‚ç‚¹ä½œä¸ºå¤´èŠ‚ç‚¹</span></div><div class="line">            head = p;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜è¿™ä¸æ˜¯ä¸€ä¸ªç©ºé“¾è¡¨ï¼Œåˆ™å°†æ–°åˆ›å»ºçš„èŠ‚ç‚¹ä½œä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="line">            q-&gt;next = p;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//å°†æ–°åˆ›å»ºçš„èŠ‚ç‚¹ä½œä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯</span></div><div class="line">        q = p;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ’å…¥</span></div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a);</div><div class="line">    <span class="comment">//å¾ªç¯éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾“å…¥çš„æ•°å¤§çš„èŠ‚ç‚¹ï¼Œæ’å…¥åˆ°å®ƒå‰é¢</span></div><div class="line">    t = head;</div><div class="line">    <span class="keyword">while</span> (t != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (t-&gt;next-&gt;data &gt; a) &#123;</div><div class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹</span></div><div class="line">            p = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> node));</div><div class="line">            p-&gt;data = a;</div><div class="line">            <span class="comment">//æ’å…¥è¿™ä¸ªèŠ‚ç‚¹</span></div><div class="line">            p-&gt;next = t-&gt;next;</div><div class="line">            t-&gt;next = p;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        t = t-&gt;next;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//éå†</span></div><div class="line">    t = head;</div><div class="line">    <span class="keyword">while</span> (t != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,t-&gt;data);</div><div class="line">        t = t-&gt;next;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="â€œæ¨¡æ‹Ÿé“¾è¡¨â€-çš„å®ç°ä¸æ“ä½œï¼ˆæ’å…¥æ•°æ®ï¼‰"><a href="#â€œæ¨¡æ‹Ÿé“¾è¡¨â€-çš„å®ç°ä¸æ“ä½œï¼ˆæ’å…¥æ•°æ®ï¼‰" class="headerlink" title="â€œæ¨¡æ‹Ÿé“¾è¡¨â€ çš„å®ç°ä¸æ“ä½œï¼ˆæ’å…¥æ•°æ®ï¼‰"></a>â€œæ¨¡æ‹Ÿé“¾è¡¨â€ çš„å®ç°ä¸æ“ä½œï¼ˆæ’å…¥æ•°æ®ï¼‰</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - â€œæ¨¡æ‹Ÿé“¾è¡¨â€çš„å®ç°ä¸æ“ä½œï¼ˆæ’å…¥ä¸€ä¸ªæ•°ï¼‰</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     æ¨¡æ‹Ÿé“¾è¡¨ï¼šæœ‰ä¸¤ä¸ªæ•´å½¢æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªæ•´å‹æ•°ç»„ data æ˜¯ç”¨æ¥å­˜æ”¾åºåˆ—ä¸­å…·ä½“æ•°å­—çš„ï¼Œå¦å¤–ä¸€ä¸ªæ•´å‹ æ•°ç»„ right æ˜¯ç”¨æ¥å­˜æ”¾å½“å‰åºåˆ—ä¸­æ¯ä¸€ä¸ªå…ƒç´ å³è¾¹çš„å…ƒç´ åœ¨æ•°ç»„ data ä¸­ä½ç½®çš„ã€‚ä¾‹å¦‚ right[1] çš„å€¼ä¸º 2ï¼Œå°±è¡¨ç¤ºå½“å‰åºåˆ—ä¸­ 1 å·å…ƒç´ å³è¾¹çš„å…ƒç´ å­˜æ”¾åœ¨ data[2]ä¸­;å¦‚æœæ˜¯ 0ï¼Œä¾‹å¦‚ right[9] çš„å€¼ä¸º 0ï¼Œå°±è¡¨ç¤ºå½“å‰åºåˆ—ä¸­ 9 å·å…ƒç´ çš„å³è¾¹æ²¡æœ‰å…ƒç´ ã€‚</div><div class="line">     */</div><div class="line">    <span class="comment">//å®šä¹‰ä¸¤ä¸ªæ•°ç»„</span></div><div class="line">    <span class="keyword">int</span> data[<span class="number">100</span>], right[<span class="number">100</span>];</div><div class="line">    <span class="keyword">int</span> n, len, t;</div><div class="line">    <span class="comment">//è¯»å…¥å‡ ä¸ªæ•°</span></div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;data[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//åˆå§‹åŒ–rightæ•°ç»„</span></div><div class="line">    len = n;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</div><div class="line">        <span class="keyword">if</span> (i != len) &#123;</div><div class="line">            <span class="comment">//å¦‚æœâ€œæ¨¡æ‹Ÿé“¾è¡¨â€ä¸­ç¬¬ i ä½ä¸æ˜¯æœ€åä¸€ä½ï¼Œåˆ™åœ¨â€œæ¨¡æ‹Ÿé“¾è¡¨â€ä¸­ç¬¬ i ä½çš„å³è¾¹ä¸€ä½åœ¨ data ä¸­çš„ä½ç½®ä¸º i+1</span></div><div class="line">            right[i] = i+<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//i æ˜¯æœ€åä¸€ä½ï¼Œåˆ™â€œæ¨¡æ‹Ÿé“¾è¡¨â€ä¸­ç¬¬ i ä½çš„å³è¾¹ä¸€ä½åœ¨</span></div><div class="line">            right[i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//æ’å…¥ä¸€ä¸ªæ•°æ®ï¼Œç›´æ¥å°†æ•°æ®æ”¾åœ¨ data çš„æœ€å</span></div><div class="line">    len ++;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;data[len]);</div><div class="line">    <span class="comment">//éå†é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾“å…¥æ•°å¤§çš„æ•°</span></div><div class="line">    t = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> (t != <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//å¦‚æœé“¾è¡¨ä¸­ t ä½ç½®çš„ä¸‹ä¸€ä½çš„å€¼å¤§äºåˆšåˆšè¾“å…¥çš„æ•°ï¼Œåˆ™è¿›è¡Œæ’å…¥æ“ä½œ</span></div><div class="line">        <span class="keyword">if</span> (data[right[t]] &gt; data[len]) &#123;</div><div class="line">            right[len] = right[t];</div><div class="line">            right[t] = len;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//t ç­‰äºé“¾è¡¨ä¸­ t ä½ç½®çš„ä¸‹ä¸€ä½</span></div><div class="line">        t = right[t];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//éå†</span></div><div class="line">    t = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> (t != <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,data[t]);</div><div class="line">        t = right[t];</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="å¹¿åº¦ä¼˜å…ˆæœç´¢ä¸æ·±åº¦ä¼˜å…ˆæœç´¢"><a href="#å¹¿åº¦ä¼˜å…ˆæœç´¢ä¸æ·±åº¦ä¼˜å…ˆæœç´¢" class="headerlink" title="å¹¿åº¦ä¼˜å…ˆæœç´¢ä¸æ·±åº¦ä¼˜å…ˆæœç´¢"></a>å¹¿åº¦ä¼˜å…ˆæœç´¢ä¸æ·±åº¦ä¼˜å…ˆæœç´¢</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»¥ä¸€ä¸ª 10 * 10 çš„äºŒç»´çŸ©é˜µä¸ºä¾‹ï¼Œæœç´¢çŸ©é˜µä¸­ä¸€ä¸ªç‚¹å‘¨å›´çš„å¤§äº0çš„ç‚¹ä¸ªæ•°</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> å¹¿åº¦ä¼˜å…ˆæœç´¢</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//è¡¨ç¤ºä¸€ä¸ªç‚¹çš„ç»“æ„ä½“</span></div><div class="line"><span class="keyword">struct</span> note &#123;</div><div class="line">    <span class="keyword">int</span> x;</div><div class="line">    <span class="keyword">int</span> y;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="keyword">struct</span> note que[<span class="number">101</span>];  <span class="comment">//è¡¨ç¤ºå­˜å‚¨ç‚¹çš„é˜Ÿåˆ—ï¼Œåœ¨ 10*10 çš„äºŒç»´çŸ©é˜µä¸­æœ€å¤š 101 ä¸ªç‚¹</span></div><div class="line">    <span class="keyword">int</span> head,tail;  <span class="comment">//æŒ‡ç¤ºé˜Ÿåˆ—çš„é˜Ÿé¦–ä¸é˜Ÿå°¾</span></div><div class="line">    <span class="keyword">int</span> a[<span class="number">11</span>][<span class="number">11</span>];  <span class="comment">//ç”¨æ¥è¡¨ç¤ºäºŒç»´çŸ©é˜µ</span></div><div class="line">    <span class="keyword">int</span> book[<span class="number">11</span>][<span class="number">11</span>] = &#123;<span class="number">0</span>&#125;;  <span class="comment">//ç”¨æ¥æ ‡è¯†å·²ç»å…¥é˜Ÿçš„ç‚¹ï¼Œä¾‹ï¼š(2,3) å·²ç»åœ¨é˜Ÿåˆ—ä¸­ï¼Œåˆ™ book[2][3] = 1</span></div><div class="line">    <span class="keyword">int</span> i,j,sum,startx,starty,tx,ty;</div><div class="line">    </div><div class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªæ–¹å‘æ•°ç»„ï¼Œç”¨æ¥è¡¨ç¤ºå‘ä¸Šä¸‹å·¦å³æœç´¢</span></div><div class="line">    <span class="keyword">int</span> next[<span class="number">4</span>][<span class="number">2</span>] = &#123;</div><div class="line">        &#123;<span class="number">0</span>,<span class="number">1</span>&#125;,   <span class="comment">//å‘å³</span></div><div class="line">        &#123;<span class="number">1</span>,<span class="number">0</span>&#125;,   <span class="comment">//å‘ä¸‹</span></div><div class="line">        &#123;<span class="number">0</span>,<span class="number">-1</span>&#125;,  <span class="comment">//å‘å·¦</span></div><div class="line">        &#123;<span class="number">-1</span>,<span class="number">0</span>&#125;   <span class="comment">//å‘ä¸Š</span></div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    <span class="comment">//è®¾ç½®å¼€å§‹æœç´¢çš„ç‚¹</span></div><div class="line">    startx = <span class="number">6</span>;</div><div class="line">    starty = <span class="number">8</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//è¯»å…¥ä¸€ä¸ªäºŒç»´çŸ©é˜µ</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i ++)</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= <span class="number">10</span>; j ++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a[i][j]);</div><div class="line">    </div><div class="line">    <span class="comment">//åˆå§‹åŒ–é˜Ÿåˆ—</span></div><div class="line">    head = <span class="number">1</span>;</div><div class="line">    tail = <span class="number">1</span>;</div><div class="line">    <span class="comment">//å°†å¼€å§‹ç‚¹æ·»åŠ è¿›é˜Ÿåˆ—</span></div><div class="line">    que[tail].x = startx;</div><div class="line">    que[tail].y = starty;</div><div class="line">    tail ++;</div><div class="line">    book[startx][starty] = <span class="number">1</span>;</div><div class="line">    sum = <span class="number">1</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºå°±å¾ªç¯</span></div><div class="line">    <span class="keyword">while</span> (head &lt; tail) &#123;</div><div class="line">        <span class="comment">//éå†å››ä¸ªæ–¹å‘</span></div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i ++) &#123;</div><div class="line">            <span class="comment">//è®¡ç®—ä¸‹ä¸€æ­¥çš„åæ ‡</span></div><div class="line">            tx = que[head].x + next[i][<span class="number">0</span>];</div><div class="line">            ty = que[head].y + next[i][<span class="number">1</span>];</div><div class="line">            <span class="comment">//åˆ¤æ–­æ˜¯å¦è¶Šç•Œ</span></div><div class="line">            <span class="keyword">if</span> (tx&lt;<span class="number">1</span> || tx&gt;<span class="number">10</span> || ty&gt;<span class="number">10</span> || ty&lt;<span class="number">1</span>)</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»èµ°è¿‡è¿™ä¸ªç‚¹ä¸”ç¬¦åˆæ¡ä»¶ï¼ˆè¿™ä¸ªçŸ©é˜µä¸Šçš„ç‚¹çš„å€¼å¤§äº0ï¼‰</span></div><div class="line">            <span class="keyword">if</span> (a[tx][ty]&gt;<span class="number">0</span> &amp;&amp; book[tx][ty]==<span class="number">0</span>) &#123;</div><div class="line">                sum ++;</div><div class="line">                book[tx][ty] = <span class="number">1</span>;  <span class="comment">//æ ‡è®°è¿™ä¸ªç‚¹å·²ç»èµ°è¿‡</span></div><div class="line">                </div><div class="line">                <span class="comment">//å…¥é˜Ÿ</span></div><div class="line">                que[tail].x = tx;</div><div class="line">                que[tail].y = ty;</div><div class="line">                tail ++;</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//è¿™ä¸ªç‚¹çš„å››ä¸ªæ–¹å‘éƒ½éå†å®Œäº†ï¼Œè½¬å‘ä¸‹ä¸€ä¸ªç‚¹ï¼Œç»§ç»­éå†è¿™ä¸ªç‚¹çš„å››ä¸ªæ–¹å‘ï¼ˆå¹¿åº¦ä¼˜å…ˆï¼‰</span></div><div class="line">        head ++;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//è¾“å‡ºç¬¦åˆæ¡ä»¶çš„ç‚¹çš„æ€»å’Œ</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,sum);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> æ·±åº¦ä¼˜å…ˆæœç´¢</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">int</span> a[<span class="number">11</span>][<span class="number">11</span>];  <span class="comment">//ç”¨æ¥è¡¨ç¤ºäºŒç»´çŸ©é˜µ</span></div><div class="line"><span class="keyword">int</span> book[<span class="number">11</span>][<span class="number">11</span>] = &#123;<span class="number">0</span>&#125;;  <span class="comment">//ç”¨æ¥æ ‡è¯†å·²ç»å…¥é˜Ÿçš„ç‚¹ï¼Œä¾‹ï¼š(2,3) å·²ç»åœ¨é˜Ÿåˆ—ä¸­ï¼Œåˆ™ book[2][3] = 1</span></div><div class="line"><span class="keyword">int</span> sum;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªæ–¹å‘æ•°ç»„ï¼Œç”¨æ¥è¡¨ç¤ºå‘ä¸Šä¸‹å·¦å³æœç´¢</span></div><div class="line">    <span class="keyword">int</span> next[<span class="number">4</span>][<span class="number">2</span>] = &#123;</div><div class="line">        &#123;<span class="number">0</span>,<span class="number">1</span>&#125;,   <span class="comment">//å‘å³</span></div><div class="line">        &#123;<span class="number">1</span>,<span class="number">0</span>&#125;,   <span class="comment">//å‘ä¸‹</span></div><div class="line">        &#123;<span class="number">0</span>,<span class="number">-1</span>&#125;,  <span class="comment">//å‘å·¦</span></div><div class="line">        &#123;<span class="number">-1</span>,<span class="number">0</span>&#125;   <span class="comment">//å‘ä¸Š</span></div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int</span> i,tx,ty;</div><div class="line">    </div><div class="line">    <span class="comment">//éå†å››ä¸ªæ–¹å‘</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i ++) &#123;</div><div class="line">        <span class="comment">//è®¡ç®—ä¸‹ä¸€ä¸ªç‚¹åæ ‡</span></div><div class="line">        tx = x + next[i][<span class="number">0</span>];</div><div class="line">        ty = y + next[i][<span class="number">1</span>];</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦è¶Šç•Œ</span></div><div class="line">        <span class="keyword">if</span> (tx&lt;<span class="number">1</span> || tx&gt;<span class="number">10</span> || ty&gt;<span class="number">10</span> || ty&lt;<span class="number">1</span>)</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦å·²ç»èµ°è¿‡è¿™ä¸ªç‚¹ä¸”ç¬¦åˆæ¡ä»¶ï¼ˆè¿™ä¸ªçŸ©é˜µä¸Šçš„ç‚¹çš„å€¼å¤§äº0ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (a[tx][ty]&gt;<span class="number">0</span> &amp;&amp; book[tx][ty]==<span class="number">0</span>) &#123;</div><div class="line">            sum ++;</div><div class="line">            book[tx][ty] = <span class="number">1</span>;  <span class="comment">//è¿™ä¸ªç‚¹å·²ç»èµ°è¿‡</span></div><div class="line">            dfs(tx, ty);  <span class="comment">//ç»§ç»­ä¸‹ä¸€ä¸ªç‚¹ï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//å·²ç»åˆ°äº†ä¸€ä¸ªæ–¹å‘çš„ç»ˆç‚¹ï¼Œè¿”å›ä¸Šä¸€ä¸ªç‚¹ç»§ç»­å¦ä¸€ä¸ªæ–¹å‘ï¼ˆæ·±åº¦ä¼˜å…ˆï¼‰</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i,j,startx,starty;</div><div class="line">    </div><div class="line">    <span class="comment">//è®¾ç½®å¼€å§‹ç‚¹</span></div><div class="line">    startx = <span class="number">6</span>;</div><div class="line">    starty = <span class="number">8</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//è¯»å…¥ä¸€ä¸ªäºŒç»´çŸ©é˜µ</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i ++)</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= <span class="number">10</span>; j ++)</div><div class="line">            <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;a[i][j]);</div><div class="line">    </div><div class="line">    <span class="comment">//è®°å½•å¼€å§‹ä½ç½®å·²ç»è¯»å–è¿‡</span></div><div class="line">    book[startx][starty] = <span class="number">1</span>;</div><div class="line">    sum = <span class="number">1</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//å¼€å§‹æœç´¢</span></div><div class="line">    dfs(startx, starty);</div><div class="line">    </div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,sum);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ç®—æ³•/">ç®—æ³•</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  



</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      <div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2013 - 2020 LLQâ€™s Blog All Rights Reserved.</p>
	      <p id="copyRightCn">LLQ ä¿ç•™æ‰€æœ‰æƒåˆ©</p>
	</div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com/li1024316925" class="mobile-nav-link">Categories</a>
  
    <a href="http://www.jianshu.com/u/605febdfa703" class="mobile-nav-link">Tags</a>
  
    <a href="/impress" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>


  <script src="/js/home.js"></script>








  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">è®¾ç½®</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              æ­£æ–‡å­—å·å¤§å°
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            æ‚¨å·²è°ƒæ•´é¡µé¢å­—ä½“å¤§å°
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              å¤œé—´æŠ¤çœ¼æ¨¡å¼
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            å¤œé—´æ¨¡å¼å·²ç»å¼€å¯ï¼Œå†æ¬¡å•å‡»æŒ‰é’®å³å¯å…³é—­ 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³ äº&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            LLQâ€™s Blog
          </div>
          <div class="panel-body">
            Copyright Â© 2020 LLQ All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
      </div>
    </div>
  </div>
</div>
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  

	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



  
</body>
</html>